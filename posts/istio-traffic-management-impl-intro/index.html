<!DOCTYPE html>
<html lang="zh" itemscope itemtype="http://schema.org/WebPage">
  <head>
    

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <title>Istio æµé‡ç®¡ç†å®ç°æœºåˆ¶æ·±åº¦è§£æ - Kubernetes|Docker|Istio|Envoy|Hugo|Golang|äº‘åŸç”Ÿ</title>


  <meta content="" name="keywords">

  <meta name="description" content="äº‘åŸç”Ÿå®éªŒå®¤æ˜¯ä¸€ä¸ªå…³æ³¨å®¹å™¨ã€kubernetesã€istioã€devopsã€prometheusã€envoyã€golangã€äº‘åŸç”Ÿã€å¾®æœåŠ¡ç­‰æŠ€æœ¯çš„ä¸ªäººåšå®¢ã€‚">
  <meta name="author" content="ç±³å¼€æœ—åŸºæ¨"/><script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "WebSite",
    "name": "äº‘åŸç”Ÿå®éªŒå®¤",
    
    "url": "https:\/\/fuckcloudnative.io"
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Organization",
  "name": "",
  "url": "https:\/\/fuckcloudnative.io"
  
  
  
  
}
</script>
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [{
        "@type": "ListItem",
        "position": 1,
        "item": {
          "@id": "https:\/\/fuckcloudnative.io",
          "name": "home"
        }
    },{
        "@type": "ListItem",
        "position": 3,
        "item": {
          "@id": "https:\/\/fuckcloudnative.io\/posts\/istio-traffic-management-impl-intro\/",
          "name": "Istio æµé‡ç®¡ç†å®ç°æœºåˆ¶æ·±åº¦è§£æ"
        }
    }]
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Article",
  "author": {
    "name" : "ç±³å¼€æœ—åŸºæ¨"
  },
  "headline": "Istio æµé‡ç®¡ç†å®ç°æœºåˆ¶æ·±åº¦è§£æ",
  "description" : "",
  "inLanguage" : "zh",
  "wordCount":  10954 ,
  "datePublished" : "2018-10-09T20:00:17",
  "dateModified" : "2018-10-09T20:00:17",
  "image" : "https:\/\/hugo-picture.oss-cn-beijing.aliyuncs.com\/blog\/2019-08-26-WechatIMG12268.jpeg",
  "keywords" : [ "istio, service mesh" ],
  "mainEntityOfPage" : "https:\/\/fuckcloudnative.io\/posts\/istio-traffic-management-impl-intro\/",
  "publisher" : {
    "@type": "Organization",
    "name" : "https:\/\/fuckcloudnative.io",
    "logo" : {
        "@type" : "ImageObject",
        "url" : "https:\/\/hugo-picture.oss-cn-beijing.aliyuncs.com\/blog\/2019-08-26-WechatIMG12268.jpeg",
        "height" :  60 ,
        "width" :  60
    }
  }
}
</script>

<meta property="og:title" content="Istio æµé‡ç®¡ç†å®ç°æœºåˆ¶æ·±åº¦è§£æ" />
<meta property="og:description" content="ä»æ•´ä½“ä¸Šç†è§£ Pilot å’Œ Envoy çš„æµé‡ç®¡ç†æœºåˆ¶">
<meta property="og:image" content="https://hugo-picture.oss-cn-beijing.aliyuncs.com/blog/2019-08-26-WechatIMG12268.jpeg" />
<meta property="og:url" content="https://fuckcloudnative.io/posts/istio-traffic-management-impl-intro/" />
<meta property="og:type" content="website" />
<meta property="og:site_name" content="äº‘åŸç”Ÿå®éªŒå®¤" />

  <meta name="twitter:title" content="Istio æµé‡ç®¡ç†å®ç°æœºåˆ¶æ·±åº¦è§£æ" />
  <meta name="twitter:description" content="ä»æ•´ä½“ä¸Šç†è§£ Pilot å’Œ Envoy çš„æµé‡ç®¡ç†æœºåˆ¶">
  <meta name="twitter:image" content="https://hugo-picture.oss-cn-beijing.aliyuncs.com/blog/2019-08-26-WechatIMG12268.jpeg" />
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@RyangYang1" />
  <meta name="twitter:creator" content="@RyangYang1" />

  <link href='https://hugo-picture.oss-cn-beijing.aliyuncs.com/favicon-32x32.png' rel='icon' type='image/x-icon'/>
  <meta name="generator" content="Hugo 0.59.0" />
  <link rel="alternate" href="https://fuckcloudnative.io/index.xml" type="application/rss+xml" title="äº‘åŸç”Ÿå®éªŒå®¤">
  
  
  
  <link href="https://cdn.bootcss.com/photoswipe/4.1.2/photoswipe.min.css" rel="stylesheet">
  <link href="https://cdn.bootcss.com/photoswipe/4.1.2/default-skin/default-skin.min.css" rel="stylesheet">


<link rel="stylesheet" href='/css/bundle.min.0c804cfe94dacde9228af00c13fb201d7423ee04f57ad78d1f0b9a087c193027.css' integrity='sha256-DIBM/pTazekiivAME/sgHXQj7gT1eteNHwuaCHwZMCc='>





<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?efe96f04908ae320df234a4f5626879e";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
</script>

<script src="https://fuckcloudnative.io/js/pace.min.js"></script>



<script src="https://fuckcloudnative.io/js/busuanzi.pure.mini.js"></script>
<script>
var int = setInterval(fixCount, 50);
function fixCount() {
    if (document.getElementById('busuanzi_container_site_uv').ownerDocument.defaultView.getComputedStyle(document.getElementById('busuanzi_container_site_uv'), null).display === 'inline') {
        clearInterval(int);
        document.getElementById('busuanzi_value_site_uv') = parseInt(document.getElementById('busuanzi_value_site_uv').innerHTML) + parseInt('100000');
    }
}
</script>







    <div class="top-scroll-bar"></div>



<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-145022311-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


  </head>
  <body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">åˆ‡æ¢å¯¼èˆª</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      
      <a class="navbar-brand" href="https://fuckcloudnative.io">ğŸ³ > $ cd /home/</a>
      
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
        
          
            <li class="navlinks-container">
		    <a class="navlinks-parent"><i class="fas fa-dharmachakra fa-spin" style="color:#986dbd"></i> æ–‡ç« åˆ†ç±»</a>
              <div class="navlinks-children">
                
                  <a href="/categories/kubernetes/">kubernetes</a>
                
                  <a href="/categories/monitoring/">ç›‘æ§</a>
                
                  <a href="/categories/service-mesh/">Service Mesh</a>
                
                  <a href="/categories/devops/">DevOps</a>
                
                  <a href="/categories/docker/">Docker</a>
                
                  <a href="/categories/linux/">Linux</a>
                
                  <a href="/categories/python/">Python</a>
                
                  <a href="/categories/network/">ç½‘ç»œ</a>
                
                  <a href="/categories/loadbalance/"> è´Ÿè½½å‡è¡¡</a>
                
                  <a href="/categories/gfw/">ç§‘å­¦ä¸Šç½‘</a>
                
                  <a href="/categories/math/">æ•°å­¦</a>
                
                  <a href="/categories/share/">é»‘ç§‘æŠ€</a>
                
                  <a href="/categories/hugo/">Hugo</a>
                
              </div>
            </li>
          
        
          
            <li class="navlinks-container">
		    <a class="navlinks-parent"><i class="fab fa-docker"></i> ç”µå­ä¹¦</a>
              <div class="navlinks-children">
                
                  <a href="/prometheus-handbook/">Prometheus ä¸­æ–‡æ–‡æ¡£</a>
                
                  <a href="/talent-is-overrated/">å¤©æ‰æºè‡ªåˆ»æ„ç»ƒä¹ </a>
                
                  <a href="/the-way-to-go/">Go å…¥é—¨æŒ‡å—</a>
                
                  <a href="https://github.com/fengdu78/Coursera-ML-AndrewNg-Notes">æœºå™¨å­¦ä¹ ç¬”è®°</a>
                
                  <a href="https://github.com/ruanyf/reading-list">é˜®ä¸€å³°ä¹¦å•</a>
                
                  <a href="https://istio.io/zh/docs">Istio service mesh</a>
                
                  <a href="https://www.gitbook.com/book/yeasy/docker_practice">Docker handbook</a>
                
              </div>
            </li>
          
        
          
            <li class="navlinks-container">
		    <a class="navlinks-parent"><i class="fas fa-book"></i> è‘µèŠ±å®å…¸</a>
              <div class="navlinks-children">
                
                  <a href="/learn-english/"> è‹±è¯­å­¦ä¹ ç»ˆæç§˜è¯€</a>
                
                  <a href="/a-day-in-the-life-of-jeff/">A Day in the life of Jeff</a>
                
              </div>
            </li>
          
        
          
            <li class="navlinks-container">
		    <a class="navlinks-parent"> ğŸ˜±ç¦åˆ©</a>
              <div class="navlinks-children">
                
                  <a href="https://nav.fuckcloudnative.io">äº‘åŸç”Ÿå¯¼èˆª</a>
                
                  <a href="https://google.fuckcloudnative.io">è°·æ­Œæœç´¢</a>
                
                  <a href="https://bt.fuckcloudnative.io">ç§å­æœç´¢</a>
                
              </div>
            </li>
          
        
          
            <li>
              <a title="Rss è®¢é˜…" href="/index.xml">Rss è®¢é˜…</a>
            </li>
          
        

        

        
        
          <li>
            <a href="#modalSearch" data-toggle="modal" data-target="#modalSearch" style="outline: none;">
              <span class="hidden-sm hidden-md hidden-lg">æœç´¢</span> <span id="searchGlyph" class="glyphicon glyphicon-search"></span>
            </a>
          </li>
        
      </ul>
    </div>

    
      <div class="avatar-container">
        <div class="avatar-img-border">
          <a title="äº‘åŸç”Ÿå®éªŒå®¤" href="https://fuckcloudnative.io">
            <img class="avatar-img" src="https://hugo-picture.oss-cn-beijing.aliyuncs.com/blog/2019-08-26-WechatIMG12268.jpeg" alt="äº‘åŸç”Ÿå®éªŒå®¤" />
          </a>
        </div>
      </div>
    

  </div>
</nav>





  <div id="modalSearch" class="modal fade" role="dialog">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal">&times;</button>
          <h4 class="modal-title">Search fuckcloudnative.io</h4>
        </div>
        <div class="modal-body">
            
<div class="aa-input-container" id="aa-input-container">
    <input type="search" id="aa-search-input" class="aa-input-search" placeholder="Search for titles or URIs..." name="search" autocomplete="off" />
    <svg class="aa-input-icon" viewBox="654 -372 1664 1664">
        <path d="M1806,332c0-123.3-43.8-228.8-131.5-316.5C1586.8-72.2,1481.3-116,1358-116s-228.8,43.8-316.5,131.5  C953.8,103.2,910,208.7,910,332s43.8,228.8,131.5,316.5C1129.2,736.2,1234.7,780,1358,780s228.8-43.8,316.5-131.5  C1762.2,560.8,1806,455.3,1806,332z M2318,1164c0,34.7-12.7,64.7-38,90s-55.3,38-90,38c-36,0-66-12.7-90-38l-343-342  c-119.3,82.7-252.3,124-399,124c-95.3,0-186.5-18.5-273.5-55.5s-162-87-225-150s-113-138-150-225S654,427.3,654,332  s18.5-186.5,55.5-273.5s87-162,150-225s138-113,225-150S1262.7-372,1358-372s186.5,18.5,273.5,55.5s162,87,225,150s113,138,150,225  S2062,236.7,2062,332c0,146.7-41.3,279.7-124,399l343,343C2305.7,1098.7,2318,1128.7,2318,1164z" />
    </svg>
</div>


<script src="https://fuckcloudnative.io/js/algoliasearch.min.js"></script>
<script src="https://fuckcloudnative.io/js/autocomplete.min.js"></script>


<script>
var client = algoliasearch("4BELQK2TOI", "62fd06bd949abb4211bfab0aa288f67b");
var index = client.initIndex('blog');

autocomplete('#aa-search-input',
{ hint: false}, {
    source: autocomplete.sources.hits(index, {hitsPerPage: 5}),
    
    displayKey: 'name',
    
    templates: {
        
        suggestion: function(suggestion) {
            
            return '<span>' + '<a href="/' + suggestion.uri+ '">' +
            suggestion._highlightResult.title.value + '</a></span>';
        }
    }
});
</script>

        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">close</button>
        </div>
      </div>
    </div>
  </div>


    


<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>


  
  
  






  
    <div id="header-big-imgs" data-num-img=1 
      
         
          data-img-src-1="https://hugo-picture.oss-cn-beijing.aliyuncs.com/blog/2019-04-27-080627.jpg" 
         
         
      ></div>
  

  <header class="header-section has-img">
    
      <div class="intro-header big-img">
        
        <div class="container">
          <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
              <div class="post-heading">
		  
		      <h1 align="center">Istio æµé‡ç®¡ç†å®ç°æœºåˆ¶æ·±åº¦è§£æ</h1>
		  
                  
                    
		      <hr class="small">
                      <h2 class="post-subheading">ä»æ•´ä½“ä¸Šç†è§£ Pilot å’Œ Envoy çš„æµé‡ç®¡ç†æœºåˆ¶</h2>
                    
                  
                  
                    <span class="post-meta">
  
  
  <i class="fas fa-calendar"></i>&nbsp;å‘è¡¨äº 2018 å¹´ 10 æœˆ 9 æ—¥
  
  
    &nbsp;|&nbsp;<i class="fas fa-clock"></i>&nbsp;22&nbsp;åˆ†é’Ÿ
  
  
    &nbsp;|&nbsp;<i class="fas fa-book"></i>&nbsp;10954&nbsp;ä¸ªå­—
  
  
    
    
  
  &nbsp;|&nbsp;<i class="fas fa-book-reader"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>æ¬¡é˜…è¯»
  
</span>

                  
              </div>
            </div>
          </div>
        </div>
        <span class="img-desc" style="display: inline;"></span>
      </div>
    
    <div class="intro-header no-img">
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            <div class="post-heading">
              
                <h1>Istio æµé‡ç®¡ç†å®ç°æœºåˆ¶æ·±åº¦è§£æ</h1>
              
              
              
                
                  <h2 class="post-subheading">ä»æ•´ä½“ä¸Šç†è§£ Pilot å’Œ Envoy çš„æµé‡ç®¡ç†æœºåˆ¶</h2>
                
              
              
                <span class="post-meta">
  
  
  <i class="fas fa-calendar"></i>&nbsp;å‘è¡¨äº 2018 å¹´ 10 æœˆ 9 æ—¥
  
  
    &nbsp;|&nbsp;<i class="fas fa-clock"></i>&nbsp;22&nbsp;åˆ†é’Ÿ
  
  
    &nbsp;|&nbsp;<i class="fas fa-book"></i>&nbsp;10954&nbsp;ä¸ªå­—
  
  
    
    
  
  &nbsp;|&nbsp;<i class="fas fa-book-reader"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>æ¬¡é˜…è¯»
  
</span>

              
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>
      
      <div class="minor-banner-box container">
        <div class="minor-banner row">
          
          <li class="minor-item col-md-3">
            <a href="https://www.processon.com/view/link/5ac64532e4b00dc8a02f05eb#map" target="_blank" title="Kubernetes çŸ¥è¯†å›¾è°±">
              <img src="https://hugo-picture.oss-cn-beijing.aliyuncs.com/images/20200221192640.jpg?x-oss-process=image/resize,w_400" alt="Kubernetes çŸ¥è¯†å›¾è°±">
            </a>
          </li>
          
          <li class="minor-item col-md-3">
            <a href="https://nav.fuckcloudnative.io?utm_source=blog&amp;utm_campaign=referral&amp;utm_medium=tophero" target="_blank" title="äº‘åŸç”Ÿå¯¼èˆª">
              <img src="https://hugo-picture.oss-cn-beijing.aliyuncs.com/images/20200221172445.png?x-oss-process=image/resize,w_300" alt="äº‘åŸç”Ÿå¯¼èˆª">
            </a>
          </li>
          
          <li class="minor-item col-md-3">
            <a href="https://nav.fuckcloudnative.io/" target="_blank" title="è°·æ­Œæœç´¢">
              <img src="https://hugo-picture.oss-cn-beijing.aliyuncs.com/images/20200221180235.png?x-oss-process=image/resize,w_400" alt="è°·æ­Œæœç´¢">
            </a>
          </li>
          
          <li class="minor-item col-md-3">
            <a href="https://raft.fuckcloudnative.io/raft/" target="_blank" title="Raft åè®®åŠ¨ç”»æ¼”ç¤º">
              <img src="https://hugo-picture.oss-cn-beijing.aliyuncs.com/images/20200221191048.jpg?x-oss-process=image/resize,w_400" alt="Raft åè®®åŠ¨ç”»æ¼”ç¤º">
            </a>
          </li>
          
        </div>
      </div>
      


    
<div class="container" role="main">
  <div class="row">
    <div id="container" class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
      <a title="æ¬ç“¦å·¥" href="https://bandwagonhost.com/aff.php?aff=54207" target="_blank">
<p id="sponsor-text" style="box-sizing: border-box;
    text-align: center;
    width: 100%;
    border: 1px solid #e5e4e9;
    background-color: #d0e4a9;
    margin: 1em 0 0;
    padding: 0.6em 0.6em 0.4em 0.6em;
    border-radius: 0.3em 0.3em 0.1em 0.1em;
    color: #076a66;"><span style="text-decoration: underline;">æ¬ç“¦å·¥</span>é¦™æ¸¯ VPS CN2ï¼Œè¶…ä½ä»· <span style="text-decoration: underline;">$2.99/å¹´</span>èµ·ã€‚é€‚åˆæ–°æ‰‹å…¥é—¨å»ºç«™ï¼Œæˆ‘çš„åšå®¢å°±æ˜¯åœ¨è¿™ä¸Šé¢æ­å»ºçš„</p>
<p style="padding:0em;margin:0 0 1.5em 0;border: 1px solid #e5e4e9;border-radius: 0.1em 0.1em 0.3em 0.3em;background-color: #28344a;text-align: center;" class="entry-sponsor-img">
  <img alt="æ¬ç“¦å·¥" id="support-img" src="https://hugo-picture.oss-cn-beijing.aliyuncs.com/images/bandwagonhost.jpg" style="border: none;width: 100%;max-width: 100%;display: inline-block;">

</p>
</a>

      <article role="main" class="blog-post">
	
<aside class="toc">
    <div id='anchors-navbar'>
        <i class='fa fa-anchor'></i>
        <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#å‰è¨€">å‰è¨€</a></li>
<li><a href="#piloté«˜å±‚æ¶æ„">Piloté«˜å±‚æ¶æ„</a>
<ul>
<li><a href="#ç»Ÿä¸€çš„æœåŠ¡æ¨¡å‹">ç»Ÿä¸€çš„æœåŠ¡æ¨¡å‹</a></li>
<li><a href="#æ ‡å‡†æ•°æ®å¹³é¢-api">æ ‡å‡†æ•°æ®å¹³é¢ API</a></li>
<li><a href="#ä¸šåŠ¡-dsl-è¯­è¨€">ä¸šåŠ¡ DSL è¯­è¨€</a></li>
</ul></li>
<li><a href="#istio-æµé‡ç®¡ç†ç›¸å…³ç»„ä»¶">Istio æµé‡ç®¡ç†ç›¸å…³ç»„ä»¶</a>
<ul>
<li><a href="#æ§åˆ¶å¹³é¢ç»„ä»¶">æ§åˆ¶å¹³é¢ç»„ä»¶</a>
<ul>
<li><a href="#discovery-services">Discovery Services</a></li>
<li><a href="#k8s-api-server">K8S API Server</a></li>
</ul></li>
<li><a href="#æ•°æ®å¹³é¢ç»„ä»¶">æ•°æ®å¹³é¢ç»„ä»¶</a>
<ul>
<li><a href="#pilot-agent">Pilot-agent</a></li>
<li><a href="#envoy">Envoy</a></li>
</ul></li>
<li><a href="#å‘½ä»¤è¡Œå·¥å…·">å‘½ä»¤è¡Œå·¥å…·</a></li>
</ul></li>
<li><a href="#æ•°æ®å¹³é¢æ ‡å‡†-api">æ•°æ®å¹³é¢æ ‡å‡† API</a>
<ul>
<li><a href="#åŸºæœ¬æ¦‚å¿µå’Œæœ¯è¯­">åŸºæœ¬æ¦‚å¿µå’Œæœ¯è¯­</a></li>
<li><a href="#xds-æœåŠ¡æ¥å£">XDS æœåŠ¡æ¥å£</a></li>
<li><a href="#xds-æœåŠ¡æ¥å£çš„æœ€ç»ˆä¸€è‡´æ€§è€ƒè™‘">XDS æœåŠ¡æ¥å£çš„æœ€ç»ˆä¸€è‡´æ€§è€ƒè™‘</a></li>
<li><a href="#ads-èšåˆå‘ç°æœåŠ¡">ADS èšåˆå‘ç°æœåŠ¡</a></li>
</ul></li>
<li><a href="#bookinfo-ç¤ºä¾‹ç¨‹åºåˆ†æ">Bookinfo ç¤ºä¾‹ç¨‹åºåˆ†æ</a>
<ul>
<li><a href="#bookinfo-ç¨‹åºç»“æ„">Bookinfo ç¨‹åºç»“æ„</a></li>
<li><a href="#xds-æ¥å£è°ƒè¯•æ–¹æ³•">xDS æ¥å£è°ƒè¯•æ–¹æ³•</a>
<ul>
<li><a href="#pilot-è°ƒè¯•æ–¹æ³•">Pilot è°ƒè¯•æ–¹æ³•</a></li>
<li><a href="#envoy-è°ƒè¯•æ–¹æ³•">Envoy è°ƒè¯•æ–¹æ³•</a></li>
</ul></li>
<li><a href="#envoy-å¯åŠ¨è¿‡ç¨‹åˆ†æ">Envoy å¯åŠ¨è¿‡ç¨‹åˆ†æ</a>
<ul>
<li><a href="#proxy-init">Proxy_init</a></li>
<li><a href="#proxyv2">Proxyv2</a></li>
<li><a href="#envoy-åˆå§‹é…ç½®æ–‡ä»¶">Envoy åˆå§‹é…ç½®æ–‡ä»¶</a></li>
</ul></li>
<li><a href="#envoy-é…ç½®åˆ†æ">Envoy é…ç½®åˆ†æ</a>
<ul>
<li><a href="#é€šè¿‡ç®¡ç†æ¥å£è·å–å®Œæ•´é…ç½®">é€šè¿‡ç®¡ç†æ¥å£è·å–å®Œæ•´é…ç½®</a></li>
<li><a href="#envoy-é…ç½®æ–‡ä»¶ç»“æ„">Envoy é…ç½®æ–‡ä»¶ç»“æ„</a>
<ul>
<li><a href="#bootstrap">Bootstrap</a></li>
<li><a href="#clusters">Clusters</a></li>
<li><a href="#listeners">Listeners</a></li>
<li><a href="#routes">Routes</a></li>
</ul></li>
</ul></li>
<li><a href="#bookinfo-ç«¯åˆ°ç«¯è°ƒç”¨åˆ†æ">Bookinfo ç«¯åˆ°ç«¯è°ƒç”¨åˆ†æ</a></li>
</ul></li>
<li><a href="#å°ç»“">å°ç»“</a></li>
<li><a href="#å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</a></li>
</ul></li>
</ul>
</nav>
    </div>
    
</aside>


        
         

         
           
           <p id="div-border-left-red">æœ¬æ–‡è½¬è½½è‡ª <a href="https://zhaohuabing.com/post/2018-09-25-istio-traffic-management-impl-intro/" target="_blank">èµµåŒ–å†°çš„åšå®¢</a>ã€‚</p>

<h2 id="å‰è¨€">å‰è¨€</h2>

<hr />

<p>Istio ä½œä¸ºä¸€ä¸ª service mesh å¼€æºé¡¹ç›®,å…¶ä¸­æœ€é‡è¦çš„åŠŸèƒ½å°±æ˜¯å¯¹ç½‘æ ¼ä¸­å¾®æœåŠ¡ä¹‹é—´çš„æµé‡è¿›è¡Œç®¡ç†,åŒ…æ‹¬æœåŠ¡å‘ç°,è¯·æ±‚è·¯ç”±å’ŒæœåŠ¡é—´çš„å¯é é€šä¿¡ã€‚Istio å®ç°äº† service mesh çš„æ§åˆ¶å¹³é¢ï¼Œå¹¶æ•´åˆ Envoy å¼€æºé¡¹ç›®ä½œä¸ºæ•°æ®å¹³é¢çš„ sidecarï¼Œä¸€èµ·å¯¹æµé‡è¿›è¡Œæ§åˆ¶ã€‚</p>

<p>Istio ä½“ç³»ä¸­æµé‡ç®¡ç†é…ç½®ä¸‹å‘ä»¥åŠæµé‡è§„åˆ™å¦‚ä½•åœ¨æ•°æ®å¹³é¢ç”Ÿæ•ˆçš„æœºåˆ¶ç›¸å¯¹æ¯”è¾ƒå¤æ‚ï¼Œé€šè¿‡å®˜æ–¹æ–‡æ¡£å®¹æ˜“ç®¡ä¸­çª¥è±¹ï¼Œéš¾ä»¥äº†è§£å…¶å®ç°åŸç†ã€‚æœ¬æ–‡å°è¯•ç»“åˆç³»ç»Ÿæ¶æ„ã€é…ç½®æ–‡ä»¶å’Œä»£ç å¯¹ Istio æµé‡ç®¡ç†çš„æ¶æ„å’Œå®ç°æœºåˆ¶è¿›è¡Œåˆ†æï¼Œä»¥è¾¾åˆ°ä»æ•´ä½“ä¸Šç†è§£ Pilot å’Œ Envoy çš„æµé‡ç®¡ç†æœºåˆ¶çš„ç›®çš„ã€‚</p>

<h2 id="piloté«˜å±‚æ¶æ„">Piloté«˜å±‚æ¶æ„</h2>

<hr />

<p>Istio æ§åˆ¶å¹³é¢ä¸­è´Ÿè´£æµé‡ç®¡ç†çš„ç»„ä»¶ä¸º <code>Pilot</code>ï¼ŒPilot çš„é«˜å±‚æ¶æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>


<link rel="stylesheet" href="https://fuckcloudnative.io/css/hugo-easy-gallery.css" />
<div class="box" >
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img itemprop="thumbnail" src="https://hugo-picture.oss-cn-beijing.aliyuncs.com/images/post_loading.gif" data-original="https://hugo-picture.oss-cn-beijing.aliyuncs.com/images/5Zywav.jpg" alt="https://hugo-picture.oss-cn-beijing.aliyuncs.com/images/5Zywav.jpg"/>
    </div>
    <a href="https://hugo-picture.oss-cn-beijing.aliyuncs.com/images/5Zywav.jpg" itemprop="contentUrl"></a>
  </figure>
</div>


<p><center>Pilot Architectureï¼ˆæ¥è‡ª <a href="https://istio.io/docs/concepts/traffic-management/" target="_blank">Isioå®˜ç½‘æ–‡æ¡£</a>)</center></p>

<p>æ ¹æ®ä¸Šå›¾,Pilot ä¸»è¦å®ç°äº†ä¸‹è¿°åŠŸèƒ½ï¼š</p>

<h3 id="ç»Ÿä¸€çš„æœåŠ¡æ¨¡å‹">ç»Ÿä¸€çš„æœåŠ¡æ¨¡å‹</h3>

<p>Pilot å®šä¹‰äº†ç½‘æ ¼ä¸­æœåŠ¡çš„æ ‡å‡†æ¨¡å‹ï¼Œè¿™ä¸ªæ ‡å‡†æ¨¡å‹ç‹¬ç«‹äºå„ç§åº•å±‚å¹³å°ã€‚ç”±äºæœ‰äº†è¯¥æ ‡å‡†æ¨¡å‹ï¼Œå„ä¸ªä¸åŒçš„å¹³å°å¯ä»¥é€šè¿‡é€‚é…å™¨å’Œ Pilot å¯¹æ¥ï¼Œå°†è‡ªå·±ç‰¹æœ‰çš„æœåŠ¡æ•°æ®æ ¼å¼è½¬æ¢ä¸ºæ ‡å‡†æ ¼å¼ï¼Œå¡«å……åˆ° Pilot çš„æ ‡å‡†æ¨¡å‹ä¸­ã€‚</p>

<p>ä¾‹å¦‚ Pilot ä¸­çš„ Kubernetes é€‚é…å™¨é€šè¿‡ <code>Kubernetes API</code> æœåŠ¡å™¨å¾—åˆ° kubernetes ä¸­ service å’Œ pod çš„ç›¸å…³ä¿¡æ¯ï¼Œç„¶åç¿»è¯‘ä¸ºæ ‡å‡†æ¨¡å‹æä¾›ç»™ Pilot ä½¿ç”¨ã€‚é€šè¿‡é€‚é…å™¨æ¨¡å¼ï¼ŒPilot è¿˜å¯ä»¥ä» <code>Mesos</code>, <code>Cloud Foundry</code>, <code>Consul</code> ç­‰å¹³å°ä¸­è·å–æœåŠ¡ä¿¡æ¯ï¼Œè¿˜å¯ä»¥å¼€å‘é€‚é…å™¨å°†å…¶ä»–æä¾›æœåŠ¡å‘ç°çš„ç»„ä»¶é›†æˆåˆ° Pilot ä¸­ã€‚</p>

<h3 id="æ ‡å‡†æ•°æ®å¹³é¢-api">æ ‡å‡†æ•°æ®å¹³é¢ API</h3>

<p>Pilot ä½¿ç”¨äº†ä¸€å¥—èµ·æºäº Envoy é¡¹ç›®çš„æ ‡å‡†æ•°æ®å¹³é¢ API æ¥å°†æœåŠ¡ä¿¡æ¯å’Œæµé‡è§„åˆ™ä¸‹å‘åˆ°æ•°æ®å¹³é¢çš„ <code>sidecar</code> ä¸­ã€‚</p>

<p>é€šè¿‡é‡‡ç”¨è¯¥æ ‡å‡† APIï¼ŒIstio å°†æ§åˆ¶å¹³é¢å’Œæ•°æ®å¹³é¢è¿›è¡Œäº†è§£è€¦ï¼Œä¸ºå¤šç§æ•°æ®å¹³é¢ sidecar å®ç°æä¾›äº†å¯èƒ½æ€§ã€‚äº‹å®ä¸ŠåŸºäºè¯¥æ ‡å‡† API å·²ç»å®ç°äº†å¤šç§ Sidecar ä»£ç†å’Œ Istio çš„é›†æˆï¼Œé™¤ Istio ç›®å‰é›†æˆçš„ Envoy å¤–ï¼Œè¿˜å¯ä»¥å’Œ <code>Linkerd</code>, <code>Nginmesh</code> ç­‰ç¬¬ä¸‰æ–¹é€šä¿¡ä»£ç†è¿›è¡Œé›†æˆï¼Œä¹Ÿå¯ä»¥åŸºäºè¯¥ API è‡ªå·±ç¼–å†™ Sidecar å®ç°ã€‚</p>

<p>æ§åˆ¶å¹³é¢å’Œæ•°æ®å¹³é¢è§£è€¦æ˜¯ Istio åæ¥å±…ä¸Šï¼Œé£å¤´è¶…è¿‡ Service mesh é¼»ç¥– <code>Linkerd</code> çš„ä¸€æ‹›å¦™æ£‹ã€‚Istio ç«™åœ¨äº†æ§åˆ¶å¹³é¢çš„é«˜åº¦ä¸Šï¼Œè€Œ Linkerd åˆ™æˆä¸ºäº†å¯é€‰çš„ä¸€ç§ sidecar å®ç°ï¼Œå¯è°“<strong>é™ç»´æ‰“å‡»</strong>çš„ä¸€ä¸ªå…¸å‹æˆåŠŸæ¡ˆä¾‹ï¼</p>

<p>æ•°æ®å¹³é¢æ ‡å‡† API ä¹Ÿæœ‰åˆ©äºç”Ÿæ€åœˆçš„å»ºç«‹ï¼Œå¼€æºã€å•†ä¸šçš„å„ç§ sidecar ä»¥åå¯èƒ½ç™¾èŠ±é½æ”¾ï¼Œç”¨æˆ·ä¹Ÿå¯ä»¥æ ¹æ®è‡ªå·±çš„ä¸šåŠ¡åœºæ™¯é€‰æ‹©ä¸åŒçš„ sidecar å’Œæ§åˆ¶å¹³é¢é›†æˆï¼Œå¦‚é«˜ååé‡çš„ï¼Œä½å»¶è¿Ÿçš„ï¼Œé«˜å®‰å…¨æ€§çš„ç­‰ç­‰ã€‚æœ‰å®åŠ›çš„å¤§å‚å•†å¯ä»¥æ ¹æ®è¯¥ API å®šåˆ¶è‡ªå·±çš„ sidecarï¼Œä¾‹å¦‚èš‚èšé‡‘æœå¼€æºçš„ Golang ç‰ˆæœ¬çš„ Sidecar <code>MOSN</code>(Modular Observable Smart Netstub)ï¼ˆ<code>SOFAMesh</code> ä¸­ Golang ç‰ˆæœ¬çš„ Sidecar)ï¼›å°å‚å•†åˆ™å¯ä»¥è€ƒè™‘é‡‡ç”¨æˆç†Ÿçš„å¼€æºé¡¹ç›®æˆ–è€…æä¾›æœåŠ¡çš„å•†ä¸š sidecar å®ç°ã€‚</p>

<p id="blockquote">Istio å’Œ Envoy é¡¹ç›®è”åˆåˆ¶å®šäº† <code>Envoy V2 API</code>,å¹¶é‡‡ç”¨è¯¥ API ä½œä¸º Istio æ§åˆ¶å¹³é¢å’Œæ•°æ®å¹³é¢æµé‡ç®¡ç†çš„æ ‡å‡†æ¥å£ã€‚</p>

<h3 id="ä¸šåŠ¡-dsl-è¯­è¨€">ä¸šåŠ¡ DSL è¯­è¨€</h3>

<p>Pilot è¿˜å®šä¹‰äº†ä¸€å¥— <code>DSL</code>ï¼ˆDomain Specific Languageï¼‰è¯­è¨€ï¼ŒDSL è¯­è¨€æä¾›äº†é¢å‘ä¸šåŠ¡çš„é«˜å±‚æŠ½è±¡ï¼Œå¯ä»¥è¢«è¿ç»´äººå‘˜ç†è§£å’Œä½¿ç”¨ã€‚è¿ç»´äººå‘˜ä½¿ç”¨è¯¥ DSL å®šä¹‰æµé‡è§„åˆ™å¹¶ä¸‹å‘åˆ° Pilotï¼Œè¿™äº›è§„åˆ™è¢« Pilot ç¿»è¯‘æˆæ•°æ®å¹³é¢çš„é…ç½®ï¼Œå†é€šè¿‡æ ‡å‡† API åˆ†å‘åˆ° Envoy å®ä¾‹ï¼Œå¯ä»¥åœ¨è¿è¡ŒæœŸå¯¹å¾®æœåŠ¡çš„æµé‡è¿›è¡Œæ§åˆ¶å’Œè°ƒæ•´ã€‚</p>

<p>Pilot çš„è§„åˆ™ DSL æ˜¯é‡‡ç”¨ K8S API Server ä¸­çš„ <a href="https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources/" target="_blank">Custom Resource (CRD)</a> å®ç°çš„ï¼Œå› æ­¤å’Œå…¶ä»–èµ„æºç±»å‹å¦‚ Serviceï¼ŒPod å’Œ Deployment çš„åˆ›å»ºå’Œä½¿ç”¨æ–¹æ³•ç±»ä¼¼ï¼Œéƒ½å¯ä»¥ç”¨ <code>Kubectl</code> è¿›è¡Œåˆ›å»ºã€‚</p>

<p>é€šè¿‡è¿ç”¨ä¸åŒçš„æµé‡è§„åˆ™ï¼Œå¯ä»¥å¯¹ç½‘æ ¼ä¸­å¾®æœåŠ¡è¿›è¡Œç²¾ç»†åŒ–çš„æµé‡æ§åˆ¶ï¼Œå¦‚æŒ‰ç‰ˆæœ¬åˆ†æµï¼Œæ–­è·¯å™¨ï¼Œæ•…éšœæ³¨å…¥ï¼Œç°åº¦å‘å¸ƒç­‰ã€‚</p>

<h2 id="istio-æµé‡ç®¡ç†ç›¸å…³ç»„ä»¶">Istio æµé‡ç®¡ç†ç›¸å…³ç»„ä»¶</h2>

<hr />

<p>æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸‹å›¾äº†è§£ Istio æµé‡ç®¡ç†æ¶‰åŠåˆ°çš„ç›¸å…³ç»„ä»¶ã€‚è™½ç„¶è¯¥å›¾æ¥è‡ª <code>Istio Github old pilot repo</code>, ä½†å›¾ä¸­æè¿°çš„ç»„ä»¶åŠæµç¨‹å’Œç›®å‰ Pilot çš„æœ€æ–°ä»£ç çš„æ¶æ„åŸºæœ¬æ˜¯ä¸€è‡´çš„ã€‚</p>



<div class="box" >
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img itemprop="thumbnail" src="https://hugo-picture.oss-cn-beijing.aliyuncs.com/images/post_loading.gif" data-original="https://hugo-picture.oss-cn-beijing.aliyuncs.com/images/dCSUXw.jpg" alt="https://hugo-picture.oss-cn-beijing.aliyuncs.com/images/dCSUXw.jpg"/>
    </div>
    <a href="https://hugo-picture.oss-cn-beijing.aliyuncs.com/images/dCSUXw.jpg" itemprop="contentUrl"></a>
  </figure>
</div>


<p><center>Pilot Design Overview (æ¥è‡ª <a href="https://github.com/istio/old_pilot_repo/blob/master/doc/design.md" target="_blank">Istio old_pilot_repo</a>)</center></p>

<p>å›¾ä¾‹è¯´æ˜ï¼šå›¾ä¸­<font color=red>çº¢è‰²</font>çš„çº¿è¡¨ç¤ºæ§åˆ¶æµï¼Œ<strong>é»‘è‰²</strong>çš„çº¿è¡¨ç¤ºæ•°æ®æµã€‚<font color=blue>è“è‰²</font>éƒ¨åˆ†ä¸ºå’ŒPilotç›¸å…³çš„ç»„ä»¶ã€‚</p>

<p>ä»ä¸Šå›¾å¯ä»¥çœ‹åˆ°ï¼ŒIstio ä¸­å’Œæµé‡ç®¡ç†ç›¸å…³çš„æœ‰ä»¥ä¸‹ç»„ä»¶ï¼š</p>

<h3 id="æ§åˆ¶å¹³é¢ç»„ä»¶">æ§åˆ¶å¹³é¢ç»„ä»¶</h3>

<h4 id="discovery-services">Discovery Services</h4>

<p>å¯¹åº”çš„ docker é•œåƒä¸º <code>gcr.io/istio-release/pilot</code>,è¿›ç¨‹ä¸º <code>pilot-discovery</code>ï¼Œè¯¥ç»„ä»¶çš„åŠŸèƒ½åŒ…æ‹¬ï¼š</p>

<ul>
<li>ä» <code>Service provider</code>ï¼ˆå¦‚kubernetesæˆ–è€…consulï¼‰ä¸­è·å–æœåŠ¡ä¿¡æ¯</li>
<li>ä» K8S API Server ä¸­è·å–æµé‡è§„åˆ™ï¼ˆK8S CRD Resourceï¼‰</li>
<li>å°†æœåŠ¡ä¿¡æ¯å’Œæµé‡è§„åˆ™è½¬åŒ–ä¸ºæ•°æ®å¹³é¢å¯ä»¥ç†è§£çš„æ ¼å¼ï¼Œé€šè¿‡æ ‡å‡†çš„æ•°æ®å¹³é¢ API ä¸‹å‘åˆ°ç½‘æ ¼ä¸­çš„å„ä¸ª sidecar ä¸­</li>
</ul>

<h4 id="k8s-api-server">K8S API Server</h4>

<p>æä¾› Pilot ç›¸å…³çš„ CRD Resource çš„å¢ã€åˆ ã€æ”¹ã€æŸ¥ã€‚å’Œ Pilot ç›¸å…³çš„ <code>CRD</code> æœ‰ä»¥ä¸‹å‡ ç§ï¼š</p>

<ul>
<li><span id="inline-blue">Virtualservice</span> : ç”¨äºå®šä¹‰è·¯ç”±è§„åˆ™ï¼Œå¦‚æ ¹æ®æ¥æºæˆ– Header åˆ¶å®šè§„åˆ™ï¼Œæˆ–åœ¨ä¸åŒæœåŠ¡ç‰ˆæœ¬ä¹‹é—´åˆ†æ‹†æµé‡ã€‚</li>
<li><span id="inline-blue">DestinationRule</span> : å®šä¹‰ç›®çš„æœåŠ¡çš„é…ç½®ç­–ç•¥ä»¥åŠå¯è·¯ç”±å­é›†ã€‚ç­–ç•¥åŒ…æ‹¬æ–­è·¯å™¨ã€è´Ÿè½½å‡è¡¡ä»¥åŠ TLS ç­‰ã€‚</li>
<li><span id="inline-blue">ServiceEntry</span> : ç”¨ <a href="https://istio.io/docs/reference/config/istio.networking.v1alpha3/#ServiceEntry" target="_blank">ServiceEntry</a> å¯ä»¥å‘ Istio ä¸­åŠ å…¥é™„åŠ çš„æœåŠ¡æ¡ç›®ï¼Œä»¥ä½¿ç½‘æ ¼å†…å¯ä»¥å‘ Istio æœåŠ¡ç½‘æ ¼ä¹‹å¤–çš„æœåŠ¡å‘å‡ºè¯·æ±‚ã€‚</li>
<li><span id="inline-blue">Gateway</span> : ä¸ºç½‘æ ¼é…ç½®ç½‘å…³ï¼Œä»¥å…è®¸ä¸€ä¸ªæœåŠ¡å¯ä»¥è¢«ç½‘æ ¼å¤–éƒ¨è®¿é—®ã€‚</li>
<li><span id="inline-blue">EnvoyFilter</span> : å¯ä»¥ä¸º Envoy é…ç½®è¿‡æ»¤å™¨ã€‚ç”±äº Envoy å·²ç»æ”¯æŒ <code>Lua</code> è¿‡æ»¤å™¨ï¼Œå› æ­¤å¯ä»¥é€šè¿‡ <code>EnvoyFilter</code> å¯ç”¨ Lua è¿‡æ»¤å™¨ï¼ŒåŠ¨æ€æ”¹å˜ Envoy çš„è¿‡æ»¤é“¾è¡Œä¸ºã€‚æˆ‘ä¹‹å‰ä¸€ç›´åœ¨è€ƒè™‘å¦‚ä½•æ‰èƒ½åŠ¨æ€æ‰©å±• Envoy çš„èƒ½åŠ›ï¼ŒEnvoyFilter æä¾›äº†å¾ˆçµæ´»çš„æ‰©å±•æ€§ã€‚</li>
</ul>

<h3 id="æ•°æ®å¹³é¢ç»„ä»¶">æ•°æ®å¹³é¢ç»„ä»¶</h3>

<p>åœ¨æ•°æ®å¹³é¢æœ‰ä¸¤ä¸ªè¿›ç¨‹ <code>Pilot-agent</code> å’Œ <code>envoy</code>ï¼Œè¿™ä¸¤ä¸ªè¿›ç¨‹è¢«æ”¾åœ¨ä¸€ä¸ª docker å®¹å™¨ <code>gcr.io/istio-release/proxyv2</code> ä¸­ã€‚</p>

<h4 id="pilot-agent">Pilot-agent</h4>

<p>è¯¥è¿›ç¨‹æ ¹æ® K8S API Server ä¸­çš„é…ç½®ä¿¡æ¯ç”Ÿæˆ Envoy çš„é…ç½®æ–‡ä»¶ï¼Œå¹¶è´Ÿè´£å¯åŠ¨ Envoy è¿›ç¨‹ã€‚æ³¨æ„ Envoy çš„å¤§éƒ¨åˆ†é…ç½®ä¿¡æ¯éƒ½æ˜¯é€šè¿‡ <code>xDS</code> æ¥å£ä» Pilot ä¸­åŠ¨æ€è·å–çš„ï¼Œå› æ­¤ Agent ç”Ÿæˆçš„åªæ˜¯ç”¨äºåˆå§‹åŒ– Envoy çš„å°‘é‡é™æ€é…ç½®ã€‚åœ¨åé¢çš„ç« èŠ‚ä¸­ï¼Œæœ¬æ–‡å°†å¯¹ Agent ç”Ÿæˆçš„ Envoy é…ç½®æ–‡ä»¶è¿›è¡Œè¿›ä¸€æ­¥åˆ†æã€‚</p>

<h4 id="envoy">Envoy</h4>

<p>Envoy ç”± <code>Pilot-agent</code> è¿›ç¨‹å¯åŠ¨ï¼Œå¯åŠ¨åï¼ŒEnvoy è¯»å– Pilot-agent ä¸ºå®ƒç”Ÿæˆçš„é…ç½®æ–‡ä»¶ï¼Œç„¶åæ ¹æ®è¯¥æ–‡ä»¶çš„é…ç½®è·å–åˆ° Pilot çš„åœ°å€ï¼Œé€šè¿‡æ•°æ®å¹³é¢æ ‡å‡† API çš„ xDS æ¥å£ä» pilot æ‹‰å–åŠ¨æ€é…ç½®ä¿¡æ¯ï¼ŒåŒ…æ‹¬è·¯ç”±ï¼ˆrouteï¼‰ï¼Œç›‘å¬å™¨ï¼ˆlistenerï¼‰ï¼ŒæœåŠ¡é›†ç¾¤ï¼ˆclusterï¼‰å’ŒæœåŠ¡ç«¯ç‚¹ï¼ˆendpointï¼‰ã€‚Envoy åˆå§‹åŒ–å®Œæˆåï¼Œå°±æ ¹æ®è¿™äº›é…ç½®ä¿¡æ¯å¯¹å¾®æœåŠ¡é—´çš„é€šä¿¡è¿›è¡Œå¯»å€å’Œè·¯ç”±ã€‚</p>

<h3 id="å‘½ä»¤è¡Œå·¥å…·">å‘½ä»¤è¡Œå·¥å…·</h3>

<p><code>kubectl</code> å’Œ <code>istioctl</code>ï¼Œç”±äº Istio çš„é…ç½®æ˜¯åŸºäº K8S çš„ <code>CRD</code>ï¼Œå› æ­¤å¯ä»¥ç›´æ¥é‡‡ç”¨ kubectl å¯¹è¿™äº›èµ„æºè¿›è¡Œæ“ä½œã€‚Istioctl åˆ™é’ˆå¯¹ Istio å¯¹ CRD çš„æ“ä½œè¿›è¡Œäº†ä¸€äº›å°è£…ã€‚Istioctl æ”¯æŒçš„åŠŸèƒ½å‚è§è¯¥ <a href="https://istio.io/docs/reference/commands/istioctl" target="_blank">è¡¨æ ¼</a>ã€‚</p>

<h2 id="æ•°æ®å¹³é¢æ ‡å‡†-api">æ•°æ®å¹³é¢æ ‡å‡† API</h2>

<hr />

<p>å‰é¢è®²åˆ°ï¼ŒPilot é‡‡ç”¨äº†ä¸€å¥—æ ‡å‡†çš„ API æ¥å‘æ•°æ®å¹³é¢ Sidecar æä¾›æœåŠ¡å‘ç°ï¼Œè´Ÿè½½å‡è¡¡æ± å’Œè·¯ç”±è¡¨ç­‰æµé‡ç®¡ç†çš„é…ç½®ä¿¡æ¯ã€‚è¯¥æ ‡å‡† API çš„æ–‡æ¡£å‚è§ <a href="https://www.envoyproxy.io/docs/envoy/latest/configuration/overview/v2_overview" target="_blank">Envoy v2 API</a>ã€‚<a href="https://github.com/envoyproxy/data-plane-api/tree/master/envoy/api/v2" target="_blank">Data Plane API Protocol Buffer Definition</a> ç»™å‡ºäº† <code>v2 grpc</code> æ¥å£ç›¸å…³çš„æ•°æ®ç»“æ„å’Œæ¥å£å®šä¹‰ã€‚</p>

<p id="blockquote">Istio æ—©æœŸé‡‡ç”¨äº† Envoy v1 APIï¼Œç›®å‰çš„ç‰ˆæœ¬ä¸­åˆ™ä½¿ç”¨ V2 APIï¼ŒV1 å·²è¢«åºŸå¼ƒã€‚</p>

<h3 id="åŸºæœ¬æ¦‚å¿µå’Œæœ¯è¯­">åŸºæœ¬æ¦‚å¿µå’Œæœ¯è¯­</h3>

<p>é¦–å…ˆæˆ‘ä»¬éœ€è¦äº†è§£æ•°æ®å¹³é¢ API ä¸­æ¶‰åŠåˆ°çš„ä¸€äº›åŸºæœ¬æ¦‚å¿µï¼š</p>

<ul>
<li><code>Host</code> ï¼šèƒ½å¤Ÿè¿›è¡Œç½‘ç»œé€šä¿¡çš„å®ä½“ï¼ˆå¦‚ç§»åŠ¨è®¾å¤‡ã€æœåŠ¡å™¨ä¸Šçš„åº”ç”¨ç¨‹åºï¼‰ã€‚åœ¨æ­¤æ–‡æ¡£ä¸­ï¼Œä¸»æœºæ˜¯é€»è¾‘ç½‘ç»œåº”ç”¨ç¨‹åºã€‚ä¸€å—ç‰©ç†ç¡¬ä»¶ä¸Šå¯èƒ½è¿è¡Œæœ‰å¤šä¸ªä¸»æœºï¼Œåªè¦å®ƒä»¬æ˜¯å¯ä»¥ç‹¬ç«‹å¯»å€çš„ã€‚åœ¨ EDS æ¥å£ä¸­ï¼Œä¹Ÿä½¿ç”¨ <code>Endpoint</code> æ¥è¡¨ç¤ºä¸€ä¸ªåº”ç”¨å®ä¾‹ï¼Œå¯¹åº”ä¸€ä¸ª IP+Port çš„ç»„åˆã€‚</li>
<li><code>Downstream</code> : ä¸‹æ¸¸ä¸»æœºè¿æ¥åˆ° Envoyï¼Œå‘é€è¯·æ±‚å¹¶æ¥æ”¶å“åº”ã€‚</li>
<li><code>Upstream</code> : ä¸Šæ¸¸ä¸»æœºæ¥æ”¶æ¥è‡ª Envoy çš„è¿æ¥å’Œè¯·æ±‚ï¼Œå¹¶è¿”å›å“åº”ã€‚</li>
<li><code>Listener</code> : ç›‘å¬å™¨æ˜¯å‘½åç½‘åœ°å€ï¼ˆä¾‹å¦‚ï¼Œç«¯å£ã€unix domain socket ç­‰)ï¼Œå¯ä»¥è¢«ä¸‹æ¸¸å®¢æˆ·ç«¯è¿æ¥ã€‚Envoy æš´éœ²ä¸€ä¸ªæˆ–è€…å¤šä¸ªç›‘å¬å™¨ç»™ä¸‹æ¸¸ä¸»æœºè¿æ¥ã€‚åœ¨ Envoy ä¸­ï¼ŒListener å¯ä»¥ç»‘å®šåˆ°ç«¯å£ä¸Šç›´æ¥å¯¹å¤–æœåŠ¡ï¼Œä¹Ÿå¯ä»¥ä¸ç»‘å®šåˆ°ç«¯å£ä¸Šï¼Œè€Œæ˜¯æ¥æ”¶å…¶ä»– listener è½¬å‘çš„è¯·æ±‚ã€‚</li>
<li><code>Cluster</code> : é›†ç¾¤æ˜¯æŒ‡ Envoy è¿æ¥åˆ°çš„é€»è¾‘ä¸Šç›¸åŒçš„ä¸€ç»„ä¸Šæ¸¸ä¸»æœºã€‚Envoy é€šè¿‡æœåŠ¡å‘ç°æ¥å‘ç°é›†ç¾¤çš„æˆå‘˜ã€‚å¯ä»¥é€‰æ‹©é€šè¿‡ä¸»åŠ¨å¥åº·æ£€æŸ¥æ¥ç¡®å®šé›†ç¾¤æˆå‘˜çš„å¥åº·çŠ¶æ€ã€‚Envoy é€šè¿‡è´Ÿè½½å‡è¡¡ç­–ç•¥å†³å®šå°†è¯·æ±‚è·¯ç”±åˆ°å“ªä¸ªé›†ç¾¤æˆå‘˜ã€‚</li>
</ul>

<h3 id="xds-æœåŠ¡æ¥å£">XDS æœåŠ¡æ¥å£</h3>

<p>Istio æ•°æ®å¹³é¢ API å®šä¹‰äº† xDS æœåŠ¡æ¥å£ï¼ŒPilot é€šè¿‡è¯¥æ¥å£å‘æ•°æ®å¹³é¢ sidecar ä¸‹å‘åŠ¨æ€é…ç½®ä¿¡æ¯ï¼Œä»¥å¯¹ Mesh ä¸­çš„æ•°æ®æµé‡è¿›è¡Œæ§åˆ¶ã€‚xDS ä¸­çš„ DS è¡¨ç¤º <code>discovery service</code>ï¼Œå³å‘ç°æœåŠ¡ï¼Œè¡¨ç¤º <code>xDS</code> æ¥å£ä½¿ç”¨åŠ¨æ€å‘ç°çš„æ–¹å¼æä¾›æ•°æ®å¹³é¢æ‰€éœ€çš„é…ç½®æ•°æ®ã€‚è€Œ x åˆ™æ˜¯ä¸€ä¸ªä»£è¯ï¼Œè¡¨ç¤ºæœ‰å¤šç§ discover serviceã€‚è¿™äº›å‘ç°æœåŠ¡åŠå¯¹åº”çš„æ•°æ®ç»“æ„å¦‚ä¸‹ï¼š</p>

<ul>
<li><code>LDS</code> (Listener Discovery Service) : <a href="https://github.com/envoyproxy/data-plane-api/blob/master/envoy/api/v2/lds.proto" target="_blank">envoy.api.v2.Listener</a></li>
<li><code>CDS</code> (Cluster Discovery Service) : <a href="https://github.com/envoyproxy/data-plane-api/blob/master/envoy/api/v2/rds.proto" target="_blank">envoy.api.v2.RouteConfiguration</a></li>
<li><code>EDS</code> (Endpoint Discovery Service) : <a href="https://github.com/envoyproxy/data-plane-api/blob/master/envoy/api/v2/cds.proto" target="_blank">envoy.api.v2.Cluster</a></li>
<li><code>RDS</code> (Route Discovery Service) : <a href="https://github.com/envoyproxy/data-plane-api/blob/master/envoy/api/v2/eds.proto" target="_blank">envoy.api.v2.ClusterLoadAssignment</a></li>
</ul>

<h3 id="xds-æœåŠ¡æ¥å£çš„æœ€ç»ˆä¸€è‡´æ€§è€ƒè™‘">XDS æœåŠ¡æ¥å£çš„æœ€ç»ˆä¸€è‡´æ€§è€ƒè™‘</h3>

<p>xDS çš„å‡ ä¸ªæ¥å£æ˜¯ç›¸äº’ç‹¬ç«‹çš„ï¼Œæ¥å£ä¸‹å‘çš„é…ç½®æ•°æ®æ˜¯æœ€ç»ˆä¸€è‡´çš„ã€‚ä½†åœ¨é…ç½®æ›´æ–°è¿‡ç¨‹ä¸­ï¼Œå¯èƒ½æš‚æ—¶å‡ºç°å„ä¸ªæ¥å£çš„æ•°æ®ä¸åŒ¹é…çš„æƒ…å†µï¼Œä»è€Œå¯¼è‡´éƒ¨åˆ†æµé‡åœ¨æ›´æ–°è¿‡ç¨‹ä¸­ä¸¢å¤±ã€‚</p>

<p>è®¾æƒ³è¿™ç§åœºæ™¯ï¼šåœ¨ <code>CDS/EDS</code> åªçŸ¥é“ cluster X çš„æƒ…å†µä¸‹ï¼Œ<code>RDS</code> çš„ä¸€æ¡è·¯ç”±é…ç½®å°†æŒ‡å‘Cluster X çš„æµé‡è°ƒæ•´åˆ°äº† Cluster Yã€‚åœ¨ CDS/EDS å‘ Mesh ä¸­ Envoy æä¾› Cluster Y çš„æ›´æ–°å‰ï¼Œè¿™éƒ¨åˆ†å¯¼å‘ Cluster Y çš„æµé‡å°†ä¼šå› ä¸º Envoy ä¸çŸ¥é“ Cluster Y çš„ä¿¡æ¯è€Œè¢«ä¸¢å¼ƒã€‚</p>

<p>å¯¹äºæŸäº›åº”ç”¨æ¥è¯´ï¼ŒçŸ­æš‚çš„éƒ¨åˆ†æµé‡ä¸¢å¤±æ˜¯å¯ä»¥æ¥å—çš„ï¼Œä¾‹å¦‚å®¢æˆ·ç«¯é‡è¯•å¯ä»¥è§£å†³è¯¥é—®é¢˜ï¼Œå¹¶ä¸å½±å“ä¸šåŠ¡é€»è¾‘ã€‚å¯¹äºå¦ä¸€äº›åœºæ™¯æ¥è¯´ï¼Œè¿™ç§æƒ…å†µå¯èƒ½æ— æ³•å®¹å¿ã€‚å¯ä»¥é€šè¿‡è°ƒæ•´ xDS æ¥å£çš„æ›´æ–°é€»è¾‘æ¥é¿å…è¯¥é—®é¢˜ï¼Œå¯¹ä¸Šé¢çš„æƒ…å†µï¼Œå¯ä»¥å…ˆé€šè¿‡ CDS/EDS æ›´æ–° Y Clusterï¼Œç„¶åå†é€šè¿‡ RDS å°† X çš„æµé‡è·¯ç”±åˆ°Yã€‚</p>

<p>ä¸€èˆ¬æ¥è¯´ï¼Œä¸ºäº†é¿å… Envoy é…ç½®æ•°æ®æ›´æ–°è¿‡ç¨‹ä¸­å‡ºç°æµé‡ä¸¢å¤±çš„æƒ…å†µï¼ŒxDS æ¥å£åº”é‡‡ç”¨ä¸‹é¢çš„é¡ºåºï¼š</p>

<ol>
<li><code>CDS</code> é¦–å…ˆæ›´æ–° <code>Cluster</code> æ•°æ®ï¼ˆå¦‚æœæœ‰å˜åŒ–ï¼‰</li>
<li><code>EDS</code> æ›´æ–°ç›¸åº” Cluster çš„ <code>Endpoint</code> ä¿¡æ¯ï¼ˆå¦‚æœæœ‰å˜åŒ–ï¼‰</li>
<li><code>LDS</code> æ›´æ–° CDS/EDS ç›¸åº”çš„ <code>Listener</code></li>
<li><code>RDS</code> æœ€åæ›´æ–°æ–°å¢ Listener ç›¸å…³çš„ <code>Route</code> é…ç½®</li>
<li>åˆ é™¤ä¸å†ä½¿ç”¨çš„ CDS cluster å’Œ EDS endpoints</li>
</ol>

<h3 id="ads-èšåˆå‘ç°æœåŠ¡">ADS èšåˆå‘ç°æœåŠ¡</h3>

<p>ä¿è¯æ§åˆ¶å¹³é¢ä¸‹å‘æ•°æ®ä¸€è‡´æ€§ï¼Œé¿å…æµé‡åœ¨é…ç½®æ›´æ–°è¿‡ç¨‹ä¸­ä¸¢å¤±çš„å¦ä¸€ä¸ªæ–¹å¼æ˜¯ä½¿ç”¨ ADS(Aggregated Discovery Services)ï¼Œå³èšåˆçš„å‘ç°æœåŠ¡ã€‚<code>ADS</code> é€šè¿‡ä¸€ä¸ª gRPC æµæ¥å‘å¸ƒæ‰€æœ‰çš„é…ç½®æ›´æ–°ï¼Œä»¥ä¿è¯å„ä¸ª xDS æ¥å£çš„è°ƒç”¨é¡ºåºï¼Œé¿å…ç”±äº xDS æ¥å£æ›´æ–°é¡ºåºå¯¼è‡´çš„é…ç½®æ•°æ®ä¸ä¸€è‡´é—®é¢˜ã€‚</p>

<p>å…³äº XDS æ¥å£çš„è¯¦ç»†ä»‹ç»å¯å‚è€ƒ <a href="https://github.com/envoyproxy/data-plane-api/blob/master/XDS_PROTOCOL.md" target="_blank">xDS REST and gRPC protocol</a></p>

<h2 id="bookinfo-ç¤ºä¾‹ç¨‹åºåˆ†æ">Bookinfo ç¤ºä¾‹ç¨‹åºåˆ†æ</h2>

<hr />

<p>ä¸‹é¢æˆ‘ä»¬ä»¥ <code>Bookinfo</code> ä¸ºä¾‹å¯¹ Istio ä¸­çš„æµé‡ç®¡ç†å®ç°æœºåˆ¶ï¼Œä»¥åŠæ§åˆ¶å¹³é¢å’Œæ•°æ®å¹³é¢çš„äº¤äº’è¿›è¡Œè¿›ä¸€æ­¥åˆ†æã€‚</p>

<h3 id="bookinfo-ç¨‹åºç»“æ„">Bookinfo ç¨‹åºç»“æ„</h3>

<p>ä¸‹å›¾æ˜¾ç¤ºäº† Bookinfo ç¤ºä¾‹ç¨‹åºä¸­å„ä¸ªç»„ä»¶çš„ IP åœ°å€ï¼Œç«¯å£å’Œè°ƒç”¨å…³ç³»ï¼Œä»¥ç”¨äºåç»­çš„åˆ†æã€‚</p>



<div class="box" >
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img itemprop="thumbnail" src="https://hugo-picture.oss-cn-beijing.aliyuncs.com/images/post_loading.gif" data-original="https://hugo-picture.oss-cn-beijing.aliyuncs.com/images/fONobF.jpg" alt="https://hugo-picture.oss-cn-beijing.aliyuncs.com/images/fONobF.jpg"/>
    </div>
    <a href="https://hugo-picture.oss-cn-beijing.aliyuncs.com/images/fONobF.jpg" itemprop="contentUrl"></a>
  </figure>
</div>


<h3 id="xds-æ¥å£è°ƒè¯•æ–¹æ³•">xDS æ¥å£è°ƒè¯•æ–¹æ³•</h3>

<p>é¦–å…ˆæˆ‘ä»¬çœ‹çœ‹å¦‚ä½•å¯¹ xDS æ¥å£çš„ç›¸å…³æ•°æ®è¿›è¡ŒæŸ¥çœ‹å’Œåˆ†æã€‚Envoy v2 æ¥å£é‡‡ç”¨äº† <code>gRPC</code>ï¼Œç”±äº gRPC æ˜¯åŸºäºäºŒè¿›åˆ¶çš„ RPC åè®®ï¼Œæ— æ³•åƒ V1 çš„ <code>REST</code> æ¥å£ä¸€æ ·é€šè¿‡ curl å’Œæµè§ˆå™¨è¿›è¡Œè¿›è¡Œåˆ†æã€‚ä½†æˆ‘ä»¬è¿˜æ˜¯å¯ä»¥é€šè¿‡ Pilot å’Œ Envoy çš„è°ƒè¯•æ¥å£æŸ¥çœ‹ xDS æ¥å£çš„ç›¸å…³æ•°æ®ã€‚</p>

<h4 id="pilot-è°ƒè¯•æ–¹æ³•">Pilot è°ƒè¯•æ–¹æ³•</h4>

<p>Pilot åœ¨ <code>9093</code> ç«¯å£æä¾›äº†ä¸‹è¿° <a href="https://github.com/istio/istio/tree/master/pilot/pkg/proxy/envoy/v2" target="_blank">è°ƒè¯•æ¥å£</a> ä¸‹è¿°æ–¹æ³•æŸ¥çœ‹ xDS æ¥å£ç›¸å…³æ•°æ®ã€‚</p>

<pre><code class="language-bash">PILOT=istio-pilot.istio-system:9093

# What is sent to envoy
# Listeners and routes
curl $PILOT/debug/adsz

# Endpoints
curl $PILOT/debug/edsz

# Clusters
curl $PILOT/debug/cdsz
</code></pre>

<h4 id="envoy-è°ƒè¯•æ–¹æ³•">Envoy è°ƒè¯•æ–¹æ³•</h4>

<p>Envoy æä¾›äº†ç®¡ç†æ¥å£ï¼Œç¼ºçœä¸º localhost çš„ <code>15000</code> ç«¯å£ï¼Œå¯ä»¥è·å– listenerï¼Œcluster ä»¥åŠå®Œæ•´çš„é…ç½®æ•°æ®å¯¼å‡ºåŠŸèƒ½ã€‚</p>

<pre><code class="language-bash">$ kubectl exec productpage-v1-54b8b9f55-bx2dq -c istio-proxy curl http://127.0.0.1:15000/help

  /: Admin home page
  /certs: print certs on machine
  /clusters: upstream cluster status
  /config_dump: dump current Envoy configs (experimental)
  /cpuprofiler: enable/disable the CPU profiler
  /healthcheck/fail: cause the server to fail health checks
  /healthcheck/ok: cause the server to pass health checks
  /help: print out list of admin commands
  /hot_restart_version: print the hot restart compatibility version
  /listeners: print listener addresses
  /logging: query/change logging levels
  /quitquitquit: exit the server
  /reset_counters: reset all counters to zero
  /runtime: print runtime values
  /runtime_modify: modify runtime values
  /server_info: print server version/status information
  /stats: print server stats
  /stats/prometheus: print server stats in prometheus format
</code></pre>

<p>è¿›å…¥ productpage pod ä¸­çš„ istio-proxy(Envoy) containerï¼Œå¯ä»¥çœ‹åˆ°æœ‰ä¸‹é¢çš„ç›‘å¬ç«¯å£ï¼š</p>

<ul>
<li><code>9080</code> : productpage è¿›ç¨‹å¯¹å¤–æä¾›çš„æœåŠ¡ç«¯å£</li>
<li><code>15001</code> : Envoy çš„å…¥å£ç›‘å¬å™¨ï¼Œiptable ä¼šå°† pod çš„æµé‡å¯¼å…¥è¯¥ç«¯å£ä¸­ç”± Envoy è¿›è¡Œå¤„ç†</li>

<li><p><code>15000</code> : Envoy ç®¡ç†ç«¯å£ï¼Œè¯¥ç«¯å£ç»‘å®šåœ¨æœ¬åœ°ç¯å›åœ°å€ä¸Šï¼Œåªèƒ½åœ¨ Pod å†…è®¿é—®ã€‚</p>

<pre><code class="language-bash">$ kubectl exec productpage-v1-76474f6fb7-j8fm4 -c istio-proxy -- ss -tulnp

Netid  State      Recv-Q Send-Q Local Address:Port               Peer Address:Port
tcp    LISTEN     0      128    127.0.0.1:15000                 *:*                   users:((&quot;envoy&quot;,pid=12,fd=9))
tcp    LISTEN     0      128       *:9080                  *:*
tcp    LISTEN     0      128       *:15001                 *:*                   users:((&quot;envoy&quot;,pid=12,fd=85))
</code></pre></li>
</ul>

<h3 id="envoy-å¯åŠ¨è¿‡ç¨‹åˆ†æ">Envoy å¯åŠ¨è¿‡ç¨‹åˆ†æ</h3>

<p>Istio é€šè¿‡ K8s çš„ <a href="https://fuckcloudnative.io/posts/kubernetes-extensible-admission/" target="_blank">Admission webhook</a> æœºåˆ¶å®ç°äº† sidecar çš„è‡ªåŠ¨æ³¨å…¥ï¼ŒMesh ä¸­çš„æ¯ä¸ªå¾®æœåŠ¡ä¼šè¢«åŠ å…¥ Envoy ç›¸å…³çš„å®¹å™¨ã€‚ä¸‹é¢æ˜¯ <code>Productpage</code> å¾®æœåŠ¡çš„ Pod å†…å®¹ï¼Œå¯è§é™¤ productpage ä¹‹å¤–ï¼ŒIstio è¿˜åœ¨è¯¥ Pod ä¸­æ³¨å…¥äº†ä¸¤ä¸ªå®¹å™¨ <code>gcr.io/istio-release/proxy_init</code> å’Œ <code>gcr.io/istio-release/proxyv2</code>ã€‚</p>

<style type="text/css">.notice{padding:18px;line-height:24px;margin-bottom:24px;margin-top:30px;border-radius:4px;color:#444;background:#e7f2fa}.notice p:last-child{margin-bottom:0}.notice-title{margin:-18px -18px 12px;padding:4px 18px;border-radius:4px 4px 0 0;font-weight:700;color:#fff;background:#6ab0de}.notice-title:before{margin-right:8px;font-family:"Font Awesome 5 Free",FontAwesome;font-weight:600}.notice.warning .notice-title{background:rgba(217,83,79,.9)}.notice.warning .notice-title:before{content:'\f071'}.notice.warning{background:#fae2e2}.notice.info .notice-title{background:#f0b37e}.notice.info .notice-title:before{content:'\f05a'}.notice.info{background:#fff2db}.notice.note .notice-title{background:#6ab0de}.notice.note .notice-title:before{content:'\f06a'}.notice.note{background:#e7f2fA}.notice.tip .notice-title{background:rgba(92,184,92,.8)}.notice.tip .notice-title:before{content:'\f058'}.notice.tip{background:#e6f9e6}</style><div class="notice note" >
<p class="first notice-title">æ³¨æ„</p><p>ä¸‹é¢ Pod description ä¸­åªä¿ç•™äº†éœ€è¦å…³æ³¨çš„å†…å®¹ï¼Œåˆ é™¤äº†å…¶å®ƒä¸é‡è¦çš„éƒ¨åˆ†ã€‚ä¸ºæ–¹ä¾¿æŸ¥çœ‹ï¼Œæœ¬æ–‡ä¸­åç»­çš„å…¶å®ƒé…ç½®æ–‡ä»¶ä»¥åŠå‘½ä»¤è¡Œè¾“å‡ºä¹Ÿä¼šè¿›è¡Œç±»ä¼¼å¤„ç†ã€‚</p></div>


<pre><code class="language-bash">$ kubectl describe pod productpage-v1-54b8b9f55-bx2dq

Name:               productpage-v1-54b8b9f55-bx2dq
Namespace:          default
Init Containers:
  istio-init:
    Image:         gcr.io/istio-release/proxy_init:1.0.0
      Args:
      -p
      15001
      -u
      1337
      -m
      REDIRECT
      -i
      *
      -x

      -b
      9080,
      -d

Containers:
  productpage:
    Image:          istio/examples-bookinfo-productpage-v1:1.8.0
    Port:           9080/TCP

  istio-proxy:
    Image:         gcr.io/istio-release/proxyv2:1.0.0
    Args:
      proxy
      sidecar
      --configPath
      /etc/istio/proxy
      --binaryPath
      /usr/local/bin/envoy
      --serviceCluster
      productpage
      --drainDuration
      45s
      --parentShutdownDuration
      1m0s
      --discoveryAddress
      istio-pilot.istio-system:15007
      --discoveryRefreshDelay
      1s
      --zipkinAddress
      zipkin.istio-system:9411
      --connectTimeout
      10s
      --statsdUdpAddress
      istio-statsd-prom-bridge.istio-system:9125
      --proxyAdminPort
      15000
      --controlPlaneAuthPolicy
      NONE
</code></pre>

<h4 id="proxy-init">Proxy_init</h4>

<p>Productpage çš„ Pod ä¸­æœ‰ä¸€ä¸ª InitContainer <code>proxy_init</code>ï¼Œ<code>InitContrainer</code> æ˜¯ K8S æä¾›çš„æœºåˆ¶ï¼Œç”¨äºåœ¨ Pod ä¸­æ‰§è¡Œä¸€äº›åˆå§‹åŒ–ä»»åŠ¡ã€‚åœ¨ Initialcontainer æ‰§è¡Œå®Œæ¯•å¹¶é€€å‡ºåï¼Œæ‰ä¼šå¯åŠ¨ Pod ä¸­çš„å…¶å®ƒ containerã€‚</p>

<p>æˆ‘ä»¬çœ‹ä¸€ä¸‹ proxy_init å®¹å™¨ä¸­çš„å†…å®¹ï¼š</p>

<pre><code class="language-bash">$ docker image inspect gcr.io/istio-release/proxy_init:1.0.0
</code></pre>

<pre><code class="language-json">[
    {
        &quot;RepoTags&quot;: [
            &quot;gcr.io/istio-release/proxy_init:1.0.0&quot;
        ],

        &quot;ContainerConfig&quot;: {
            &quot;Env&quot;: [
                &quot;PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin&quot;
            ],
            &quot;Cmd&quot;: [
                &quot;/bin/sh&quot;,
                &quot;-c&quot;,
                &quot;#(nop) &quot;,
                &quot;ENTRYPOINT [\&quot;/usr/local/bin/istio-iptables.sh\&quot;]&quot;
            ],
            &quot;Entrypoint&quot;: [
                &quot;/usr/local/bin/istio-iptables.sh&quot;
            ],
        },
    }
]
</code></pre>

<p>ä»ä¸Šé¢çš„å‘½ä»¤è¡Œè¾“å‡ºå¯ä»¥çœ‹åˆ°ï¼ŒProxy_init ä¸­æ‰§è¡Œçš„å‘½ä»¤æ˜¯ <code>istio-iptables.sh</code>ï¼Œè¯¥è„šæœ¬æºç è¾ƒé•¿ï¼Œå°±ä¸åˆ—å‡ºæ¥äº†ï¼Œæœ‰å…´è¶£å¯ä»¥åœ¨ Istio æºç ä»“åº“çš„ <a href="https://github.com/istio/istio/blob/master/tools/deb/istio-iptables.sh" target="_blank">tools/deb/istio-iptables.sh</a> æŸ¥çœ‹ã€‚</p>

<p>è¯¥è„šæœ¬çš„ä½œç”¨æ˜¯é€šè¿‡é…ç½® iptables æ¥åŠ«æŒ Pod ä¸­çš„æµé‡ã€‚ç»“åˆå‰é¢ Pod ä¸­è¯¥å®¹å™¨çš„å‘½ä»¤è¡Œå‚æ•° <code>-p 15001</code>ï¼Œå¯ä»¥å¾—çŸ¥ Pod ä¸­çš„æ•°æ®æµé‡è¢« iptables æ‹¦æˆªï¼Œå¹¶å‘å‘ Envoy çš„ 15001 ç«¯å£ã€‚ <code>-u 1337</code> å‚æ•°ç”¨äºæ’é™¤ç”¨æˆ· ID ä¸º 1337ï¼Œå³ Envoy è‡ªèº«çš„æµé‡ï¼Œä»¥é¿å… Iptables æŠŠ Envoy å‘å‡ºçš„æ•°æ®åˆé‡å®šå‘åˆ° Envoyï¼Œå½¢æˆæ­»å¾ªç¯ã€‚</p>

<h4 id="proxyv2">Proxyv2</h4>

<p>å‰é¢æåˆ°ï¼Œè¯¥å®¹å™¨ä¸­æœ‰ä¸¤ä¸ªè¿›ç¨‹ Pilot-agent å’Œ envoyã€‚æˆ‘ä»¬è¿›å…¥å®¹å™¨ä¸­çœ‹çœ‹è¿™ä¸¤ä¸ªè¿›ç¨‹çš„ç›¸å…³ä¿¡æ¯ã€‚</p>

<pre><code class="language-bash">$ kubectl exec productpage-v1-54b8b9f55-bx2dq -c istio-proxy -- ps -ef

UID        PID  PPID  C STIME TTY          TIME CMD
istio-p+     1     0  0 Sep06 ?        00:00:00 /usr/local/bin/pilot-agent proxy sidecar --configPath /etc/istio/proxy --binaryPath /usr/local/bin/envoy --serviceCluster productpage --drainDuration 45s --parentShutdownDuration 1m0s --discoveryAddress istio-pilot.istio-system:15007 --discoveryRefreshDelay 1s --zipkinAddress zipkin.istio-system:9411 --connectTimeout 10s --statsdUdpAddress istio-statsd-prom-bridge.istio-system:9125 --proxyAdminPort 15000 --controlPlaneAuthPolicy NONE
istio-p+    13     1  0 Sep06 ?        00:47:37 /usr/local/bin/envoy -c /etc/istio/proxy/envoy-rev0.json --restart-epoch 0 --drain-time-s 45 --parent-shutdown-time-s 60 --service-cluster productpage --service-node sidecar~192.168.206.23~productpage-v1-54b8b9f55-bx2dq.default~default.svc.cluster.local --max-obj-name-len 189 -l warn --v2-config-only
</code></pre>

<p>Envoy çš„å¤§éƒ¨åˆ†é…ç½®éƒ½æ˜¯ <code>dynamic resource</code>ï¼ŒåŒ…æ‹¬ç½‘æ ¼ä¸­æœåŠ¡ç›¸å…³çš„ service cluster, listener, route è§„åˆ™ç­‰ã€‚è¿™äº› dynamic resource æ˜¯é€šè¿‡ xDS æ¥å£ä» Istio æ§åˆ¶å¹³é¢ä¸­åŠ¨æ€è·å–çš„ã€‚ä½† Envoy å¦‚ä½•çŸ¥é“ xDS server çš„åœ°å€å‘¢ï¼Ÿè¿™æ˜¯åœ¨ Envoy åˆå§‹åŒ–é…ç½®æ–‡ä»¶ä¸­ä»¥ <code>static resource</code> çš„æ–¹å¼é…ç½®çš„ã€‚</p>

<h4 id="envoy-åˆå§‹é…ç½®æ–‡ä»¶">Envoy åˆå§‹é…ç½®æ–‡ä»¶</h4>

<p><code>Pilot-agent</code> è¿›ç¨‹æ ¹æ®å¯åŠ¨å‚æ•°å’Œ K8S API Server ä¸­çš„é…ç½®ä¿¡æ¯ç”Ÿæˆ Envoy çš„åˆå§‹é…ç½®æ–‡ä»¶ï¼Œå¹¶è´Ÿè´£å¯åŠ¨ Envoy è¿›ç¨‹ã€‚ä» ps å‘½ä»¤è¾“å‡ºå¯ä»¥çœ‹åˆ° Pilot-agent åœ¨å¯åŠ¨ Envoy è¿›ç¨‹æ—¶ä¼ å…¥äº† <code>pilot</code> åœ°å€å’Œ <code>zipkin</code> åœ°å€ï¼Œå¹¶ä¸º Envoy ç”Ÿæˆäº†ä¸€ä¸ªåˆå§‹åŒ–é…ç½®æ–‡ä»¶ <code>envoy-rev0.json</code>ã€‚</p>

<p>Pilot agent ç”Ÿæˆåˆå§‹åŒ–é…ç½®æ–‡ä»¶çš„ä»£ç ï¼š <a href="https://github.com/istio/istio/blob/release-1.0/pkg/bootstrap/bootstrap_config.go" target="_blank">https://github.com/istio/istio/blob/release-1.0/pkg/bootstrap/bootstrap_config.go</a> 137è¡Œ</p>

<pre><code class="language-go">// WriteBootstrap generates an envoy config based on config and epoch, and returns the filename.
// TODO: in v2 some of the LDS ports (port, http_port) should be configured in the bootstrap.
func WriteBootstrap(config *meshconfig.ProxyConfig, node string, epoch int, pilotSAN []string, opts map[string]interface{}) (string, error) {
	if opts == nil {
		opts = map[string]interface{}{}
	}
	if err := os.MkdirAll(config.ConfigPath, 0700); err != nil {
		return &quot;&quot;, err
	}
	// attempt to write file
	fname := configFile(config.ConfigPath, epoch)

	cfg := config.CustomConfigFile
	if cfg == &quot;&quot; {
		cfg = config.ProxyBootstrapTemplatePath
	}
	if cfg == &quot;&quot; {
		cfg = DefaultCfgDir
	}
	......

	if config.StatsdUdpAddress != &quot;&quot; {
		h, p, err = GetHostPort(&quot;statsd UDP&quot;, config.StatsdUdpAddress)
		if err != nil {
			return &quot;&quot;, err
		}
		StoreHostPort(h, p, &quot;statsd&quot;, opts)
	}

	fout, err := os.Create(fname)
	if err != nil {
		return &quot;&quot;, err
	}

	// Execute needs some sort of io.Writer
	err = t.Execute(fout, opts)
	return fname, err
}
</code></pre>

<p>å¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤å°† productpage pod ä¸­è¯¥æ–‡ä»¶å¯¼å‡ºæ¥æŸ¥çœ‹å…¶ä¸­çš„å†…å®¹ï¼š</p>

<pre><code class="language-bash">$ kubectl exec productpage-v1-54b8b9f55-bx2dq -c istio-proxy -- cat /etc/istio/proxy/envoy-rev0.json &gt; envoy-rev0.json
</code></pre>

<p>é…ç½®æ–‡ä»¶çš„ç»“æ„å¦‚å›¾æ‰€ç¤ºï¼š</p>

<p><center>

<div class="box" >
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img itemprop="thumbnail" src="https://hugo-picture.oss-cn-beijing.aliyuncs.com/images/post_loading.gif" data-original="https://hugo-picture.oss-cn-beijing.aliyuncs.com/images/Rwq4zh.jpg" alt="https://hugo-picture.oss-cn-beijing.aliyuncs.com/images/Rwq4zh.jpg"/>
    </div>
    <a href="https://hugo-picture.oss-cn-beijing.aliyuncs.com/images/Rwq4zh.jpg" itemprop="contentUrl"></a>
  </figure>
</div>
</center></p>

<p>å…¶ä¸­å„ä¸ªé…ç½®èŠ‚ç‚¹çš„å†…å®¹å¦‚ä¸‹ï¼š</p>

<p id=blue>Node</p>

<p>åŒ…å«äº† Envoy æ‰€åœ¨èŠ‚ç‚¹ç›¸å…³ä¿¡æ¯ã€‚</p>

<pre><code class="language-json">&quot;node&quot;: {
    &quot;id&quot;: &quot;sidecar~192.168.206.23~productpage-v1-54b8b9f55-bx2dq.default~default.svc.cluster.local&quot;,
    //ç”¨äºæ ‡è¯† envoy æ‰€ä»£ç†çš„ nodeï¼ˆåœ¨k8sä¸­å¯¹åº”ä¸ºPodï¼‰ä¸Šçš„ service clusterï¼Œæ¥è‡ªäº Envoy è¿›ç¨‹å¯åŠ¨æ—¶çš„ service-cluster å‚æ•°
    &quot;cluster&quot;: &quot;productpage&quot;,  
    &quot;metadata&quot;: {
          &quot;INTERCEPTION_MODE&quot;: &quot;REDIRECT&quot;,
          &quot;ISTIO_PROXY_SHA&quot;: &quot;istio-proxy:6166ae7ebac7f630206b2fe4e6767516bf198313&quot;,
          &quot;ISTIO_PROXY_VERSION&quot;: &quot;1.0.0&quot;,
          &quot;ISTIO_VERSION&quot;: &quot;1.0.0&quot;,
          &quot;POD_NAME&quot;: &quot;productpage-v1-54b8b9f55-bx2dq&quot;,
          &quot;istio&quot;: &quot;sidecar&quot;
    }
  }
</code></pre>

<p id=blue>Admin</p>

<p>é…ç½® Envoy çš„æ—¥å¿—è·¯å¾„ä»¥åŠç®¡ç†ç«¯å£ã€‚</p>

<pre><code class="language-json">&quot;admin&quot;: {
    &quot;access_log_path&quot;: &quot;/dev/stdout&quot;,
    &quot;address&quot;: {
      &quot;socket_address&quot;: {
        &quot;address&quot;: &quot;127.0.0.1&quot;,
        &quot;port_value&quot;: 15000
      }
    }
  }
</code></pre>

<p id=blue>Dynamic_resources</p>

<p>é…ç½®åŠ¨æ€èµ„æº,è¿™é‡Œé…ç½®äº† <code>ADS</code> æœåŠ¡å™¨ã€‚</p>

<pre><code class="language-json">&quot;dynamic_resources&quot;: {
    &quot;lds_config&quot;: {
        &quot;ads&quot;: {}
    },
    &quot;cds_config&quot;: {
        &quot;ads&quot;: {}
    },
    &quot;ads_config&quot;: {
      &quot;api_type&quot;: &quot;GRPC&quot;,
      &quot;refresh_delay&quot;: {&quot;seconds&quot;: 1, &quot;nanos&quot;: 0},
      &quot;grpc_services&quot;: [
        {
          &quot;envoy_grpc&quot;: {
            &quot;cluster_name&quot;: &quot;xds-grpc&quot;
          }
        }
      ]
    }
  }
</code></pre>

<p id=blue>Static_resources</p>

<p>é…ç½®é™æ€èµ„æºï¼ŒåŒ…æ‹¬äº† <code>xds-grpc</code> å’Œ <code>zipkin</code> ä¸¤ä¸ª clusterã€‚å…¶ä¸­ xds-grpc cluster å¯¹åº”å‰é¢ dynamic_resources ä¸­ ADS é…ç½®ï¼ŒæŒ‡æ˜äº† Envoy ç”¨äºè·å–åŠ¨æ€èµ„æºçš„æœåŠ¡å™¨åœ°å€ã€‚</p>

<pre><code class="language-json">&quot;static_resources&quot;: {
  &quot;clusters&quot;: [
    {
      &quot;name&quot;: &quot;xds-grpc&quot;,
      &quot;type&quot;: &quot;STRICT_DNS&quot;,
      &quot;connect_timeout&quot;: {
        &quot;seconds&quot;: 10,
        &quot;nanos&quot;: 0
      },
      &quot;lb_policy&quot;: &quot;ROUND_ROBIN&quot;,
      &quot;hosts&quot;: [
        {
          &quot;socket_address&quot;: {
            &quot;address&quot;: &quot;istio-pilot.istio-system&quot;,
            &quot;port_value&quot;: 15010
          }
        }
      ],
      &quot;circuit_breakers&quot;: {
        &quot;thresholds&quot;: [
          {
            &quot;priority&quot;: &quot;default&quot;,
            &quot;max_connections&quot;: &quot;100000&quot;,
            &quot;max_pending_requests&quot;: &quot;100000&quot;,
            &quot;max_requests&quot;: &quot;100000&quot;
          },
          {
            &quot;priority&quot;: &quot;high&quot;,
            &quot;max_connections&quot;: &quot;100000&quot;,
            &quot;max_pending_requests&quot;: &quot;100000&quot;,
            &quot;max_requests&quot;: &quot;100000&quot;
          }
        ]
      },
      &quot;upstream_connection_options&quot;: {
        &quot;tcp_keepalive&quot;: {
          &quot;keepalive_time&quot;: 300
        }
      },
      &quot;http2_protocol_options&quot;: {}
    },
    {
      &quot;name&quot;: &quot;zipkin&quot;,
      &quot;type&quot;: &quot;STRICT_DNS&quot;,
      &quot;connect_timeout&quot;: {
        &quot;seconds&quot;: 1
      },
      &quot;lb_policy&quot;: &quot;ROUND_ROBIN&quot;,
      &quot;hosts&quot;: [
        {
          &quot;socket_address&quot;: {
            &quot;address&quot;: &quot;zipkin.istio-system&quot;,
            &quot;port_value&quot;: 9411
          }
        }
      ]
    }
  ]
}
</code></pre>

<p id=blue>Tracing</p>

<p>é…ç½®åˆ†å¸ƒå¼é“¾è·¯è·Ÿè¸ªã€‚</p>

<pre><code class="language-json">&quot;tracing&quot;: {
  &quot;http&quot;: {
    &quot;name&quot;: &quot;envoy.zipkin&quot;,
    &quot;config&quot;: {
      &quot;collector_cluster&quot;: &quot;zipkin&quot;
    }
  }
}
</code></pre>

<p id=blue>Stats_sinks</p>

<p>è¿™é‡Œé…ç½®çš„æ˜¯å’Œ Envoy ç›´è¿çš„ <code>metrics</code> æ”¶é›† sink,å’Œ <code>Mixer telemetry</code> æ²¡æœ‰å…³ç³»ã€‚Envoy è‡ªå¸¦ stats æ ¼å¼çš„ metrics ä¸ŠæŠ¥ã€‚</p>

<pre><code class="language-json">&quot;stats_sinks&quot;: [
  {
    &quot;name&quot;: &quot;envoy.statsd&quot;,
    &quot;config&quot;: {
      &quot;address&quot;: {
        &quot;socket_address&quot;: {
          &quot;address&quot;: &quot;10.254.238.237&quot;,
          &quot;port_value&quot;: 9125
        }
      }
    }
  }
]
</code></pre>

<p>åœ¨Gist <a href="https://gist.github.com/zhaohuabing/14191bdcf72e37bf700129561c3b41ae" target="_blank">https://gist.github.com/zhaohuabing/14191bdcf72e37bf700129561c3b41ae</a> ä¸­å¯ä»¥æŸ¥çœ‹è¯¥é…ç½®æ–‡ä»¶çš„å®Œæ•´å†…å®¹ã€‚</p>

<h3 id="envoy-é…ç½®åˆ†æ">Envoy é…ç½®åˆ†æ</h3>

<h4 id="é€šè¿‡ç®¡ç†æ¥å£è·å–å®Œæ•´é…ç½®">é€šè¿‡ç®¡ç†æ¥å£è·å–å®Œæ•´é…ç½®</h4>

<p>ä» Envoy åˆå§‹åŒ–é…ç½®æ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥å¤§è‡´çœ‹åˆ° Istio é€šè¿‡ Envoy æ¥å®ç°æœåŠ¡å‘ç°å’Œæµé‡ç®¡ç†çš„åŸºæœ¬åŸç†ã€‚å³æ§åˆ¶å¹³é¢å°† xDS server ä¿¡æ¯é€šè¿‡ <code>static resource</code> çš„æ–¹å¼é…ç½®åˆ° Envoy çš„åˆå§‹åŒ–é…ç½®æ–‡ä»¶ä¸­ï¼ŒEnvoy å¯åŠ¨åé€šè¿‡ xDS server è·å–åˆ° <code>dynamic resource</code>ï¼ŒåŒ…æ‹¬ç½‘æ ¼ä¸­çš„ service ä¿¡æ¯åŠè·¯ç”±è§„åˆ™ã€‚</p>

<p>Envoy é…ç½®åˆå§‹åŒ–æµç¨‹ï¼š</p>

<p><center>

<div class="box" >
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img itemprop="thumbnail" src="https://hugo-picture.oss-cn-beijing.aliyuncs.com/images/post_loading.gif" data-original="https://hugo-picture.oss-cn-beijing.aliyuncs.com/images/NQTN5a.jpg" alt="https://hugo-picture.oss-cn-beijing.aliyuncs.com/images/NQTN5a.jpg"/>
    </div>
    <a href="https://hugo-picture.oss-cn-beijing.aliyuncs.com/images/NQTN5a.jpg" itemprop="contentUrl"></a>
  </figure>
</div>
</center></p>

<ol>
<li>Pilot-agent æ ¹æ®å¯åŠ¨å‚æ•°å’Œ K8S API Server ä¸­çš„é…ç½®ä¿¡æ¯ç”Ÿæˆ Envoy çš„åˆå§‹é…ç½®æ–‡ä»¶ <code>envoy-rev0.json</code>ï¼Œè¯¥æ–‡ä»¶å‘Šè¯‰ Envoy ä» <code>xDS server</code> ä¸­è·å–åŠ¨æ€é…ç½®ä¿¡æ¯ï¼Œå¹¶é…ç½®äº† xDS server çš„åœ°å€ä¿¡æ¯ï¼Œå³æ§åˆ¶å¹³é¢çš„ <code>Pilot</code>ã€‚</li>
<li>Pilot-agent ä½¿ç”¨ envoy-rev0.json å¯åŠ¨ Envoy è¿›ç¨‹ã€‚</li>
<li>Envoy æ ¹æ®åˆå§‹é…ç½®è·å¾— Pilot åœ°å€ï¼Œé‡‡ç”¨ xDS æ¥å£ä» Pilot è·å–åˆ° <code>Listener</code>ï¼Œ<code>Cluster</code>ï¼Œ<code>Route</code> ç­‰åŠ¨æ€é…ç½®ä¿¡æ¯ã€‚</li>
<li>Envoy æ ¹æ®è·å–åˆ°çš„åŠ¨æ€é…ç½®å¯åŠ¨ Listenerï¼Œå¹¶æ ¹æ® Listener çš„é…ç½®ï¼Œç»“åˆ Route å’Œ Cluster å¯¹æ‹¦æˆªåˆ°çš„æµé‡è¿›è¡Œå¤„ç†ã€‚</li>
</ol>

<p>å¯ä»¥çœ‹åˆ°ï¼ŒEnvoy ä¸­å®é™…ç”Ÿæ•ˆçš„é…ç½®æ˜¯ç”±åˆå§‹åŒ–é…ç½®æ–‡ä»¶ä¸­çš„é™æ€é…ç½®å’Œä» Pilot è·å–çš„åŠ¨æ€é…ç½®ä¸€èµ·ç»„æˆçš„ã€‚å› æ­¤åªå¯¹ envoy-rev0.json è¿›è¡Œåˆ†æå¹¶ä¸èƒ½çœ‹åˆ° Mesh ä¸­æµé‡ç®¡ç†çš„å…¨è²Œã€‚é‚£ä¹ˆæœ‰æ²¡æœ‰åŠæ³•å¯ä»¥çœ‹åˆ° Envoy ä¸­å®é™…ç”Ÿæ•ˆçš„å®Œæ•´é…ç½®å‘¢ï¼Ÿç­”æ¡ˆæ˜¯å¯ä»¥çš„ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ Envoy çš„ç®¡ç†æ¥å£æ¥è·å– Envoy çš„å®Œæ•´é…ç½®ã€‚</p>

<pre><code class="language-bash">$ kubectl exec -it productpage-v1-54b8b9f55-bx2dq -c istio-proxy curl http://127.0.0.1:15000/config_dump &gt; config_dump
</code></pre>

<p>è¯¥æ–‡ä»¶å†…å®¹é•¿è¾¾è¿‘7000è¡Œï¼Œæœ¬æ–‡ä¸­å°±ä¸è´´å‡ºæ¥äº†ï¼Œåœ¨Gist <a href="https://gist.github.com/zhaohuabing/034ef87786d290a4e89cd6f5ad6fcc97" target="_blank">https://gist.github.com/zhaohuabing/034ef87786d290a4e89cd6f5ad6fcc97</a> ä¸­å¯ä»¥æŸ¥çœ‹åˆ°å…¨æ–‡ã€‚</p>

<h4 id="envoy-é…ç½®æ–‡ä»¶ç»“æ„">Envoy é…ç½®æ–‡ä»¶ç»“æ„</h4>

<p><center>

<div class="box" >
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img itemprop="thumbnail" src="https://hugo-picture.oss-cn-beijing.aliyuncs.com/images/post_loading.gif" data-original="https://hugo-picture.oss-cn-beijing.aliyuncs.com/images/3DyRUz.jpg" alt="https://hugo-picture.oss-cn-beijing.aliyuncs.com/images/3DyRUz.jpg"/>
    </div>
    <a href="https://hugo-picture.oss-cn-beijing.aliyuncs.com/images/3DyRUz.jpg" itemprop="contentUrl"></a>
  </figure>
</div>
</center></p>

<p>æ–‡ä»¶ä¸­çš„é…ç½®èŠ‚ç‚¹åŒ…æ‹¬ï¼š</p>

<h5 id="bootstrap">Bootstrap</h5>

<p>ä»åå­—å¯ä»¥å¤§è‡´çŒœå‡ºè¿™æ˜¯ Envoy çš„åˆå§‹åŒ–é…ç½®ï¼Œæ‰“å¼€è¯¥èŠ‚ç‚¹ï¼Œå¯ä»¥çœ‹åˆ°æ–‡ä»¶ä¸­çš„å†…å®¹å’Œå‰ä¸€ç« èŠ‚ä¸­ä»‹ç»çš„ envoy-rev0.json æ˜¯ä¸€è‡´çš„ï¼Œè¿™é‡Œä¸å†èµ˜è¿°ã€‚</p>

<p><center>

<div class="box" >
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img itemprop="thumbnail" src="https://hugo-picture.oss-cn-beijing.aliyuncs.com/images/post_loading.gif" data-original="https://hugo-picture.oss-cn-beijing.aliyuncs.com/images/CBAqAH.jpg" alt="https://hugo-picture.oss-cn-beijing.aliyuncs.com/images/CBAqAH.jpg"/>
    </div>
    <a href="https://hugo-picture.oss-cn-beijing.aliyuncs.com/images/CBAqAH.jpg" itemprop="contentUrl"></a>
  </figure>
</div>
</center></p>

<h5 id="clusters">Clusters</h5>

<p>åœ¨ Envoy ä¸­ï¼ŒCluster æ˜¯ä¸€ä¸ªæœåŠ¡é›†ç¾¤ï¼ŒCluster ä¸­åŒ…å«ä¸€ä¸ªåˆ°å¤šä¸ª endpointï¼Œæ¯ä¸ª endpoint éƒ½å¯ä»¥æä¾›æœåŠ¡ï¼ŒEnvoy æ ¹æ®è´Ÿè½½å‡è¡¡ç®—æ³•å°†è¯·æ±‚å‘é€åˆ°è¿™äº› endpoint ä¸­ã€‚</p>

<p>åœ¨ Productpage çš„ clusters é…ç½®ä¸­åŒ…å« <code>static_clusters</code> å’Œ <code>dynamic_active_clusters</code> ä¸¤éƒ¨åˆ†ï¼Œå…¶ä¸­ static_clusters æ˜¯æ¥è‡ªäº envoy-rev0.json çš„ xDS server å’Œ zipkin server ä¿¡æ¯ã€‚dynamic_active_clusters æ˜¯é€šè¿‡ xDS æ¥å£ä» Istio æ§åˆ¶å¹³é¢è·å–çš„åŠ¨æ€æœåŠ¡ä¿¡æ¯ã€‚</p>

<p><center>

<div class="box" >
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img itemprop="thumbnail" src="https://hugo-picture.oss-cn-beijing.aliyuncs.com/images/post_loading.gif" data-original="https://hugo-picture.oss-cn-beijing.aliyuncs.com/images/pXRSn3.jpg" alt="https://hugo-picture.oss-cn-beijing.aliyuncs.com/images/pXRSn3.jpg"/>
    </div>
    <a href="https://hugo-picture.oss-cn-beijing.aliyuncs.com/images/pXRSn3.jpg" itemprop="contentUrl"></a>
  </figure>
</div>
</center></p>

<p>Dynamic Cluster ä¸­æœ‰ä»¥ä¸‹å‡ ç±» Clusterï¼š</p>

<p id=blue>Outbound Cluster</p>

<p>è¿™éƒ¨åˆ†çš„ Cluster å äº†ç»å¤§å¤šæ•°ï¼Œè¯¥ç±» Cluster å¯¹åº”äº Envoy æ‰€åœ¨èŠ‚ç‚¹çš„å¤–éƒ¨æœåŠ¡ã€‚ä»¥ <code>details</code> ä¸ºä¾‹ï¼Œå¯¹äº Productpage æ¥è¯´ï¼Œdetails æ˜¯ä¸€ä¸ªå¤–éƒ¨æœåŠ¡ï¼Œå› æ­¤å…¶ Cluster åç§°ä¸­åŒ…å« <code>outbound</code> å­—æ ·ã€‚</p>

<p>ä» details æœåŠ¡å¯¹åº”çš„ cluster é…ç½®ä¸­å¯ä»¥çœ‹åˆ°ï¼Œå…¶ç±»å‹ä¸º <code>EDS</code>ï¼Œå³è¡¨ç¤ºè¯¥ Cluster çš„ endpoint æ¥è‡ªäºåŠ¨æ€å‘ç°ï¼ŒåŠ¨æ€å‘ç°ä¸­ <code>eds_config</code> åˆ™æŒ‡å‘äº† <code>ads</code>ï¼Œæœ€ç»ˆæŒ‡å‘ static Resource ä¸­é…ç½®çš„ xds-grpc clusterï¼Œå³ Pilot çš„åœ°å€ã€‚</p>

<pre><code class="language-json">{
 &quot;version_info&quot;: &quot;2018-09-06T09:34:19Z&quot;,
 &quot;cluster&quot;: {
  &quot;name&quot;: &quot;outbound|9080||details.default.svc.cluster.local&quot;,
  &quot;type&quot;: &quot;EDS&quot;,
  &quot;eds_cluster_config&quot;: {
   &quot;eds_config&quot;: {
    &quot;ads&quot;: {}
   },
   &quot;service_name&quot;: &quot;outbound|9080||details.default.svc.cluster.local&quot;
  },
  &quot;connect_timeout&quot;: &quot;1s&quot;,
  &quot;circuit_breakers&quot;: {
   &quot;thresholds&quot;: [
    {}
   ]
  }
 },
 &quot;last_updated&quot;: &quot;2018-09-06T09:34:20.404Z&quot;
}
</code></pre>

<p>å¯ä»¥é€šè¿‡ Pilot çš„è°ƒè¯•æ¥å£è·å–è¯¥ Cluster çš„ endpointï¼š</p>

<pre><code class="language-bash">$ curl http://10.96.8.103:9093/debug/edsz &gt; pilot_eds_dump
</code></pre>

<p>å¯¼å‡ºçš„æ–‡ä»¶é•¿è¾¾ 1300 å¤šè¡Œï¼Œæœ¬æ–‡åªè´´å‡º details æœåŠ¡ç›¸å…³çš„ <code>endpoint</code> é…ç½®ï¼Œå®Œæ•´æ–‡ä»¶å‚è§: <a href="https://gist.github.com/zhaohuabing/a161d2f64746acd18097b74e6a5af551" target="_blank">https://gist.github.com/zhaohuabing/a161d2f64746acd18097b74e6a5af551</a></p>

<p>ä»ä¸‹é¢çš„æ–‡ä»¶å†…å®¹å¯ä»¥çœ‹åˆ°ï¼Œdetails cluster é…ç½®äº† 1 ä¸ª endpoint åœ°å€ï¼Œæ˜¯ details çš„ <code>pod ip</code>ã€‚</p>

<pre><code class="language-json">{
  &quot;clusterName&quot;: &quot;outbound|9080||details.default.svc.cluster.local&quot;,
  &quot;endpoints&quot;: [
    {
      &quot;locality&quot;: {

      },
      &quot;lbEndpoints&quot;: [
        {
          &quot;endpoint&quot;: {
            &quot;address&quot;: {
              &quot;socketAddress&quot;: {
                &quot;address&quot;: &quot;192.168.206.21&quot;,
                &quot;portValue&quot;: 9080
              }
            }
          },
          &quot;metadata&quot;: {
            &quot;filterMetadata&quot;: {
              &quot;istio&quot;: {
                  &quot;uid&quot;: &quot;kubernetes://details-v1-6764bbc7f7-qwzdg.default&quot;
                }
            }
          }
        }
      ]
    }
  ]
}
</code></pre>

<p id=blue>Inbound Cluster</p>

<p>è¯¥ç±» Cluster å¯¹åº”äº Envoy æ‰€åœ¨èŠ‚ç‚¹ä¸Šçš„æœåŠ¡ã€‚å¦‚æœè¯¥æœåŠ¡æ¥æ”¶åˆ°è¯·æ±‚ï¼Œå½“ç„¶å°±æ˜¯ä¸€ä¸ªå…¥ç«™è¯·æ±‚ã€‚å¯¹äº Productpage Pod ä¸Šçš„ Envoyï¼Œå…¶å¯¹åº”çš„ Inbound Cluster åªæœ‰ä¸€ä¸ªï¼Œå³ productpageã€‚è¯¥ cluster å¯¹åº”çš„ host ä¸º <code>127.0.0.1</code>ï¼Œå³ç¯å›åœ°å€ä¸Š productpage çš„ç›‘å¬ç«¯å£ã€‚ç”±äº iptables è§„åˆ™ä¸­æ’é™¤äº† 127.0.0.1,å…¥ç«™è¯·æ±‚é€šè¿‡è¯¥ Inbound cluster å¤„ç†åå°†è·³è¿‡ Envoyï¼Œç›´æ¥å‘é€ç»™ Productpage è¿›ç¨‹å¤„ç†ã€‚</p>

<pre><code class="language-json">{
   &quot;version_info&quot;: &quot;2018-09-14T01:44:05Z&quot;,
   &quot;cluster&quot;: {
    &quot;name&quot;: &quot;inbound|9080||productpage.default.svc.cluster.local&quot;,
    &quot;connect_timeout&quot;: &quot;1s&quot;,
    &quot;hosts&quot;: [
     {
      &quot;socket_address&quot;: {
       &quot;address&quot;: &quot;127.0.0.1&quot;,
       &quot;port_value&quot;: 9080
      }
     }
    ],
    &quot;circuit_breakers&quot;: {
     &quot;thresholds&quot;: [
      {}
     ]
    }
   },
   &quot;last_updated&quot;: &quot;2018-09-14T01:44:05.291Z&quot;
}
</code></pre>

<p id=blue>BlackHoleCluster</p>

<p>è¿™æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„ Clusterï¼Œå¹¶æ²¡æœ‰é…ç½®åç«¯å¤„ç†è¯·æ±‚çš„ Hostã€‚å¦‚å…¶åå­—æ‰€æš—ç¤ºçš„ä¸€æ ·ï¼Œè¯·æ±‚è¿›å…¥åå°†è¢«ç›´æ¥ä¸¢å¼ƒæ‰ã€‚å¦‚æœä¸€ä¸ªè¯·æ±‚æ²¡æœ‰æ‰¾åˆ°å…¶å¯¹çš„ç›®çš„æœåŠ¡ï¼Œåˆ™è¢«å‘åˆ° BlackHoleClusterã€‚</p>

<pre><code class="language-json">{
   &quot;version_info&quot;: &quot;2018-09-06T09:34:19Z&quot;,
   &quot;cluster&quot;: {
    &quot;name&quot;: &quot;BlackHoleCluster&quot;,
    &quot;connect_timeout&quot;: &quot;5s&quot;
   },
   &quot;last_updated&quot;: &quot;2018-09-06T09:34:20.408Z&quot;
}
</code></pre>

<h5 id="listeners">Listeners</h5>

<p>Envoy é‡‡ç”¨ listener æ¥æ¥æ”¶å¹¶å¤„ç† <code>downstream</code> å‘è¿‡æ¥çš„è¯·æ±‚ï¼Œlistener çš„å¤„ç†é€»è¾‘æ˜¯æ’ä»¶å¼çš„ï¼Œå¯ä»¥é€šè¿‡é…ç½®ä¸åŒçš„ <code>filter</code> æ¥æ’å…¥ä¸åŒçš„å¤„ç†é€»è¾‘ã€‚Istio å°±åœ¨ Envoy ä¸­åŠ å…¥äº†ç”¨äº <code>policy check</code> å’Œ <code>metric report</code> çš„ Mixer filterã€‚</p>

<p>Listener å¯ä»¥ç»‘å®šåˆ° <code>IP Socket</code> æˆ–è€… <code>Unix Domain Socket</code> ä¸Šï¼Œä¹Ÿå¯ä»¥ä¸ç»‘å®šåˆ°ä¸€ä¸ªå…·ä½“çš„ç«¯å£ä¸Šï¼Œè€Œæ˜¯æ¥æ”¶ä»å…¶ä»– listener è½¬å‘æ¥çš„æ•°æ®ã€‚Istio å°±æ˜¯åˆ©ç”¨äº† Envoy listener çš„è¿™ä¸€ç‰¹ç‚¹å®ç°äº†å°†æ¥å‘å‘ä¸åŒæœåŠ¡çš„è¯·æ±‚è½¬äº¤ç»™ä¸åŒçš„ listener å¤„ç†ã€‚</p>

<p id=blue>Virtual Listener</p>

<p>Envoy åˆ›å»ºäº†ä¸€ä¸ªåœ¨ <code>15001</code> ç«¯å£ç›‘å¬çš„å…¥å£ç›‘å¬å™¨ã€‚Iptables å°†è¯·æ±‚æˆªå–åå‘å‘ 15001 ç«¯å£ï¼Œè¯¥ç›‘å¬å™¨æ¥æ”¶åå¹¶ä¸è¿›è¡Œä¸šåŠ¡å¤„ç†ï¼Œè€Œæ˜¯æ ¹æ®è¯·æ±‚ç›®çš„åœ°åˆ†å‘ç»™å…¶ä»–ç›‘å¬å™¨å¤„ç†ã€‚è¯¥ç›‘å¬å™¨å–åä¸º <code>virtual</code>ï¼ˆè™šæ‹Ÿï¼‰ç›‘å¬å™¨ä¹Ÿæ˜¯è¿™ä¸ªåŸå› ã€‚</p>

<p>Envoy æ˜¯å¦‚ä½•åšåˆ°æŒ‰æœåŠ¡åˆ†å‘çš„å‘¢ï¼Ÿ å¯ä»¥çœ‹åˆ°è¯¥ Listener çš„é…ç½®é¡¹ <code>use_original_dest</code> è®¾ç½®ä¸º true,è¯¥é…ç½®è¦æ±‚ç›‘å¬å™¨å°†æ¥æ”¶åˆ°çš„è¯·æ±‚è½¬äº¤ç»™å’Œè¯·æ±‚åŸç›®çš„åœ°å€å…³è”çš„ listener è¿›è¡Œå¤„ç†ã€‚</p>

<p>ä»å…¶ filter é…ç½®å¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœæ‰¾ä¸åˆ°å’Œè¯·æ±‚ç›®çš„åœ°é…ç½®çš„ listener è¿›è¡Œè½¬äº¤ï¼Œåˆ™è¯·æ±‚å°†è¢«å‘é€åˆ° <code>BlackHoleCluster</code>,ç”±äº BlackHoleCluster å¹¶æ²¡æœ‰é…ç½® hostï¼Œå› æ­¤æ‰¾ä¸åˆ°å¯¹åº”ç›®çš„åœ°å¯¹åº”ç›‘å¬å™¨çš„è¯·æ±‚å®é™…ä¸Šä¼šè¢«ä¸¢å¼ƒã€‚</p>

<pre><code class="language-json">{
 &quot;version_info&quot;: &quot;2018-09-06T09:34:19Z&quot;,
 &quot;listener&quot;: {
  &quot;name&quot;: &quot;virtual&quot;,
  &quot;address&quot;: {
   &quot;socket_address&quot;: {
    &quot;address&quot;: &quot;0.0.0.0&quot;,
    &quot;port_value&quot;: 15001
   }
  },
  &quot;filter_chains&quot;: [
   {
    &quot;filters&quot;: [
     {
      &quot;name&quot;: &quot;envoy.tcp_proxy&quot;,
      &quot;config&quot;: {
       &quot;stat_prefix&quot;: &quot;BlackHoleCluster&quot;,
       &quot;cluster&quot;: &quot;BlackHoleCluster&quot;
      }
     }
    ]
   }
  ],
  &quot;use_original_dst&quot;: true
 },
 &quot;last_updated&quot;: &quot;2018-09-06T09:34:26.262Z&quot;
}
</code></pre>

<p id=blue>Inbound Listener</p>

<p>åœ¨ Productpage Pod ä¸Šçš„ Envoy åˆ›å»ºäº† <code>Listener 192.168.206.23_9080</code>ï¼Œå½“å¤–éƒ¨è°ƒç”¨ Productpage æœåŠ¡çš„è¯·æ±‚åˆ°è¾¾ Pod ä¸Š 15001 çš„ <code>Virtual Listener</code> æ—¶ï¼ŒVirtual Listener æ ¹æ®è¯·æ±‚ç›®çš„åœ°åŒ¹é…åˆ°è¯¥ Listener,è¯·æ±‚å°†è¢«è½¬å‘è¿‡æ¥ã€‚</p>

<pre><code class="language-json">{
 &quot;version_info&quot;: &quot;2018-09-14T01:44:05Z&quot;,
 &quot;listener&quot;: {
  &quot;name&quot;: &quot;192.168.206.23_9080&quot;,
  &quot;address&quot;: {
   &quot;socket_address&quot;: {
    &quot;address&quot;: &quot;192.168.206.23&quot;,
    &quot;port_value&quot;: 9080
   }
  },
  &quot;filter_chains&quot;: [
   {
    &quot;filters&quot;: [
     {
      &quot;name&quot;: &quot;mixer&quot;,
      &quot;config&quot;: {
       &quot;transport&quot;: {
        &quot;check_cluster&quot;: &quot;outbound|9091||istio-policy.istio-system.svc.cluster.local&quot;,
        &quot;network_fail_policy&quot;: {
         &quot;policy&quot;: &quot;FAIL_CLOSE&quot;
        },
        &quot;report_cluster&quot;: &quot;outbound|9091||istio-telemetry.istio-system.svc.cluster.local&quot;,
        &quot;attributes_for_mixer_proxy&quot;: {
         &quot;attributes&quot;: {
          &quot;source.uid&quot;: {
           &quot;string_value&quot;: &quot;kubernetes://productpage-v1-54b8b9f55-bx2dq.default&quot;
          }
         }
        }
       },
       &quot;mixer_attributes&quot;: {
        &quot;attributes&quot;: {
         &quot;destination.port&quot;: {
          &quot;int64_value&quot;: &quot;9080&quot;
         },
         &quot;context.reporter.uid&quot;: {
          &quot;string_value&quot;: &quot;kubernetes://productpage-v1-54b8b9f55-bx2dq.default&quot;
         },
         &quot;destination.namespace&quot;: {
          &quot;string_value&quot;: &quot;default&quot;
         },
         &quot;destination.ip&quot;: {
          &quot;bytes_value&quot;: &quot;AAAAAAAAAAAAAP//wKjOFw==&quot;
         },
         &quot;destination.uid&quot;: {
          &quot;string_value&quot;: &quot;kubernetes://productpage-v1-54b8b9f55-bx2dq.default&quot;
         },
         &quot;context.reporter.kind&quot;: {
          &quot;string_value&quot;: &quot;inbound&quot;
         }
        }
       }
      }
     },
     {
      &quot;name&quot;: &quot;envoy.tcp_proxy&quot;,
      &quot;config&quot;: {
       &quot;stat_prefix&quot;: &quot;inbound|9080||productpage.default.svc.cluster.local&quot;,
       &quot;cluster&quot;: &quot;inbound|9080||productpage.default.svc.cluster.local&quot;
      }
     }
    ]
   }
  ],
  &quot;deprecated_v1&quot;: {
   &quot;bind_to_port&quot;: false
  }
 },
 &quot;last_updated&quot;: &quot;2018-09-14T01:44:05.754Z&quot;
}
</code></pre>

<p>ä»ä¸Šé¢çš„é…ç½® <code>â€bind_to_portâ€: false</code> å¯ä»¥å¾—çŸ¥è¯¥ listener åˆ›å»ºåå¹¶ä¸ä¼šè¢«ç»‘å®šåˆ° tcp ç«¯å£ä¸Šç›´æ¥æ¥æ”¶ç½‘ç»œä¸Šçš„æ•°æ®ï¼Œå› æ­¤å…¶æ‰€æœ‰è¯·æ±‚éƒ½è½¬å‘è‡ª 15001 ç«¯å£ã€‚</p>

<p>è¯¥ listener é…ç½®çš„ <code>envoy.tcp_proxy filter</code> å¯¹åº”çš„ clusterä¸º <code>inbound|9080||productpage.default.svc.cluster.local</code>,è¯¥ cluster é…ç½®çš„ host ä¸º 127.0.0.1:9080ï¼Œå› æ­¤ Envoy ä¼šå°†è¯¥è¯·æ±‚å‘å‘ <code>127.0.0.1:9080</code>ã€‚ç”±äº iptables è®¾ç½®ä¸­ 127.0.0.1 ä¸ä¼šè¢«æ‹¦æˆª,è¯¥è¯·æ±‚å°†å‘é€åˆ° Productpage è¿›ç¨‹çš„ 9080 ç«¯å£è¿›è¡Œä¸šåŠ¡å¤„ç†ã€‚</p>

<p>é™¤æ­¤ä»¥å¤–ï¼ŒListenter ä¸­è¿˜åŒ…å« <code>Mixer filter</code> çš„é…ç½®ä¿¡æ¯ï¼Œé…ç½®äº†ç­–ç•¥æ£€æŸ¥(Mixer check)å’Œ Metrics ä¸ŠæŠ¥(Mixer report)æœåŠ¡å™¨åœ°å€ï¼Œä»¥åŠ Mixerä¸Š æŠ¥çš„ä¸€äº› attribute å–å€¼ã€‚</p>

<p id=blue>Outbound Listener</p>

<p>Envoy ä¸ºç½‘æ ¼ä¸­çš„å¤–éƒ¨æœåŠ¡æŒ‰ç«¯å£åˆ›å»ºå¤šä¸ª Listenerï¼Œä»¥ç”¨äºå¤„ç†å‡ºå‘è¯·æ±‚ã€‚</p>

<p>Productpage Pod ä¸­çš„ Envoy åˆ›å»ºäº†å¤šä¸ª Outbound Listenerï¼š</p>

<ul>
<li><code>0.0.0.0_9080</code> : å¤„ç†å¯¹ detailsï¼Œreviews å’Œ rating æœåŠ¡çš„å‡ºå‘è¯·æ±‚</li>
<li><code>0.0.0.0_9411</code> : å¤„ç†å¯¹ <code>zipkin</code> çš„å‡ºå‘è¯·æ±‚</li>
<li><code>0.0.0.0_15031</code> :å¤„ç†å¯¹ <code>ingressgateway</code> çš„å‡ºå‘è¯·æ±‚</li>
<li><code>0.0.0.0_3000</code> : å¤„ç†å¯¹ <code>grafana</code> çš„å‡ºå‘è¯·æ±‚</li>
<li><code>0.0.0.0_9093</code> :å¤„ç†å¯¹ citadelã€galleyã€pilotã€(Mixer)policyã€(Mixer)telemetry çš„å‡ºå‘è¯·æ±‚</li>
<li><code>0.0.0.0_15004</code> : å¤„ç†å¯¹ (Mixer)policyã€(Mixer)telemetry çš„å‡ºå‘è¯·æ±‚</li>
<li>&hellip;&hellip;</li>
</ul>

<p>é™¤äº† 9080 è¿™ä¸ª Listener ç”¨äºå¤„ç†åº”ç”¨çš„ä¸šåŠ¡ä¹‹å¤–ï¼Œå…¶ä»– listener éƒ½æ˜¯ Istio ç”¨äºå¤„ç†è‡ªèº«ç»„ä»¶ä¹‹é—´é€šä¿¡ä½¿ç”¨çš„ï¼Œæœ‰çš„æ§åˆ¶å¹³é¢ç»„ä»¶å¦‚ Pilotï¼ŒMixer å¯¹åº”å¤šä¸ª listenerï¼Œæ˜¯å› ä¸ºè¯¥ç»„ä»¶æœ‰å¤šä¸ªç«¯å£æä¾›æœåŠ¡ã€‚</p>

<p>æˆ‘ä»¬è¿™é‡Œä¸»è¦åˆ†æä¸€ä¸‹ <code>9080</code> è¿™ä¸ªä¸šåŠ¡ç«¯å£çš„ Listenrerã€‚å’Œ Outbound Listener ä¸€æ ·ï¼Œè¯¥ Listener åŒæ ·é…ç½®äº† <code>â€bind_to_portâ€: false</code> å±æ€§ï¼Œå› æ­¤è¯¥ listener ä¹Ÿæ²¡æœ‰è¢«ç»‘å®šåˆ° tcp ç«¯å£ä¸Šï¼Œå…¶æ¥æ”¶åˆ°çš„æ‰€æœ‰è¯·æ±‚éƒ½è½¬å‘è‡ª 15001 ç«¯å£çš„ Virtual listenerã€‚</p>

<p>ç›‘å¬å™¨ name ä¸º <code>0.0.0.0_9080</code>ï¼Œæ¨æµ‹å…¶å«ä¹‰åº”ä¸ºåŒ¹é…å‘å‘ä»»æ„ IP çš„ 9080 çš„è¯·æ±‚ï¼Œä» bookinfo ç¨‹åºç»“æ„å¯ä»¥çœ‹åˆ°è¯¥ç¨‹åºä¸­çš„ productpageï¼Œrevirewsï¼Œratingsï¼Œdetails å››ä¸ª service éƒ½æ˜¯ 9080 ç«¯å£ï¼Œé‚£ä¹ˆ Envoy å¦‚ä½•åŒºåˆ«å¤„ç†è¿™å››ä¸ª service å‘¢ï¼Ÿ</p>

<p>é¦–å…ˆéœ€è¦åŒºåˆ†<strong>å…¥å‘</strong>ï¼ˆå‘é€ç»™productpageï¼‰è¯·æ±‚å’Œ<strong>å‡ºå‘</strong>ï¼ˆå‘é€ç»™å…¶ä»–å‡ ä¸ªæœåŠ¡ï¼‰è¯·æ±‚ï¼š</p>

<ul>
<li>å‘ç»™ productpage çš„å…¥å‘è¯·æ±‚ï¼Œvirtual listener æ ¹æ®å…¶ç›®çš„ IP å’Œ Port é¦–å…ˆåŒ¹é…åˆ° <code>192.168.206.23_9080</code> è¿™ä¸ª listener ä¸Šï¼Œä¸ä¼šè¿›å…¥ <code>0.0.0.0_9080</code> listenerå¤„ç†ã€‚</li>
<li>ä» productpage å¤–å‘ç»™ reviewsã€details å’Œ ratings çš„å‡ºå‘è¯·æ±‚ï¼Œvirtual listener æ— æ³•æ‰¾åˆ°å’Œå…¶ç›®çš„ IP å®Œå…¨åŒ¹é…çš„ listenerï¼Œå› æ­¤æ ¹æ®é€šé…åŸåˆ™è½¬äº¤ç»™ <code>0.0.0.0_9080</code> å¤„ç†ã€‚</li>
</ul>

<p id=blockquote>å¤‡æ³¨ï¼š<br />
1. è¯¥è½¬å‘é€»è¾‘ä¸ºæ ¹æ® Envoy é…ç½®è¿›è¡Œçš„æ¨æµ‹ï¼Œå¹¶æœªåˆ†æ Envoy ä»£ç è¿›è¡ŒéªŒè¯ã€‚æ¬¢è¿äº†è§£ Envoy ä»£ç å’Œå®ç°æœºåˆ¶çš„æœ‹å‹æŒ‡æ­£ã€‚
<br />
2. æ ¹æ®ä¸šåŠ¡é€»è¾‘ï¼Œå®é™…ä¸Š productpage å¹¶ä¸ä¼šè°ƒç”¨ ratings æœåŠ¡ï¼Œä½† Istio å¹¶ä¸çŸ¥é“å„ä¸ªä¸šåŠ¡ä¹‹é—´ä¼šå¦‚ä½•è°ƒç”¨ï¼Œå› æ­¤å°†æ‰€æœ‰çš„æœåŠ¡ä¿¡æ¯éƒ½ä¸‹å‘åˆ°äº† Envoy ä¸­ã€‚è¿™æ ·åšå¯¹æ•ˆç‡å’Œæ€§èƒ½ç†è®ºä¸Šæœ‰ä¸€å®šå½±å“ï¼Œå­˜åœ¨ä¸€å®šçš„ä¼˜åŒ–ç©ºé—´ã€‚</p>

<p>ç”±äºå¯¹åº”åˆ° reviewsã€details å’Œ ratings ä¸‰ä¸ªæœåŠ¡ï¼Œå½“ 0.0.0.0_9080 æ¥æ”¶åˆ°å‡ºå‘è¯·æ±‚åï¼Œå¹¶ä¸èƒ½ç›´æ¥å‘é€åˆ°ä¸€ä¸ª downstream cluster ä¸­ï¼Œè€Œæ˜¯éœ€è¦æ ¹æ®è¯·æ±‚ç›®çš„åœ°è¿›è¡Œä¸åŒçš„è·¯ç”±ã€‚</p>

<p>åœ¨è¯¥ listener çš„é…ç½®ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å¹¶æ²¡æœ‰åƒ inbound listener é‚£æ ·é€šè¿‡ envoy.tcp_proxy ç›´æ¥æŒ‡å®šä¸€ä¸ª downstream çš„ clusterï¼Œè€Œæ˜¯é€šè¿‡ <code>rds</code> é…ç½®äº†ä¸€ä¸ªè·¯ç”±è§„åˆ™ <code>9080</code>ï¼Œåœ¨è·¯ç”±è§„åˆ™ä¸­å†æ ¹æ®ä¸åŒçš„è¯·æ±‚ç›®çš„åœ°å¯¹è¯·æ±‚è¿›è¡Œå¤„ç†ã€‚</p>

<pre><code class="language-json">{
     &quot;version_info&quot;: &quot;2018-09-06T09:34:19Z&quot;,
     &quot;listener&quot;: {
      &quot;name&quot;: &quot;0.0.0.0_9080&quot;,
      &quot;address&quot;: {
       &quot;socket_address&quot;: {
        &quot;address&quot;: &quot;0.0.0.0&quot;,
        &quot;port_value&quot;: 9080
       }
      },
      &quot;filter_chains&quot;: [
       {
        &quot;filters&quot;: [
         {
          &quot;name&quot;: &quot;envoy.http_connection_manager&quot;,
          &quot;config&quot;: {
           &quot;access_log&quot;: [
            {
             &quot;name&quot;: &quot;envoy.file_access_log&quot;,
             &quot;config&quot;: {
              &quot;path&quot;: &quot;/dev/stdout&quot;
             }
            }
           ],
           &quot;http_filters&quot;: [
            {
             &quot;name&quot;: &quot;mixer&quot;,
             &quot;config&quot;: {

			  ......

             }
            },
            {
             &quot;name&quot;: &quot;envoy.cors&quot;
            },
            {
             &quot;name&quot;: &quot;envoy.fault&quot;
            },
            {
             &quot;name&quot;: &quot;envoy.router&quot;
            }
           ],
           &quot;tracing&quot;: {
            &quot;operation_name&quot;: &quot;EGRESS&quot;,
            &quot;client_sampling&quot;: {
             &quot;value&quot;: 100
            },
            &quot;overall_sampling&quot;: {
             &quot;value&quot;: 100
            },
            &quot;random_sampling&quot;: {
             &quot;value&quot;: 100
            }
           },
           &quot;use_remote_address&quot;: false,
           &quot;stat_prefix&quot;: &quot;0.0.0.0_9080&quot;,
           &quot;rds&quot;: {
            &quot;route_config_name&quot;: &quot;9080&quot;,
            &quot;config_source&quot;: {
             &quot;ads&quot;: {}
            }
           },
           &quot;stream_idle_timeout&quot;: &quot;0.000s&quot;,
           &quot;generate_request_id&quot;: true,
           &quot;upgrade_configs&quot;: [
            {
             &quot;upgrade_type&quot;: &quot;websocket&quot;
            }
           ]
          }
         }
        ]
       }
      ],
      &quot;deprecated_v1&quot;: {
       &quot;bind_to_port&quot;: false
      }
     },
     &quot;last_updated&quot;: &quot;2018-09-06T09:34:26.172Z&quot;
    },
</code></pre>

<h5 id="routes">Routes</h5>

<p>é…ç½® Envoy çš„è·¯ç”±è§„åˆ™ã€‚Istio ä¸‹å‘çš„ç¼ºçœè·¯ç”±è§„åˆ™ä¸­å¯¹æ¯ä¸ªç«¯å£è®¾ç½®äº†ä¸€ä¸ªè·¯ç”±è§„åˆ™ï¼Œæ ¹æ® host æ¥å¯¹è¯·æ±‚è¿›è¡Œè·¯ç”±åˆ†å‘ã€‚</p>

<p>ä¸‹é¢æ˜¯ <code>9080</code> çš„è·¯ç”±é…ç½®ï¼Œä»æ–‡ä»¶ä¸­å¯ä»¥çœ‹åˆ°å¯¹åº”äº† 3 ä¸ª <code>virtual host</code>ï¼Œåˆ†åˆ«æ˜¯ detailsã€ratings å’Œ reviewsï¼Œè¿™ä¸‰ä¸ª virtual host åˆ†åˆ«å¯¹åº”åˆ°ä¸åŒçš„ <code>outbound cluster</code>ã€‚</p>

<pre><code class="language-json">{
     &quot;version_info&quot;: &quot;2018-09-14T01:38:20Z&quot;,
     &quot;route_config&quot;: {
      &quot;name&quot;: &quot;9080&quot;,
      &quot;virtual_hosts&quot;: [
       {
        &quot;name&quot;: &quot;details.default.svc.cluster.local:9080&quot;,
        &quot;domains&quot;: [
         &quot;details.default.svc.cluster.local&quot;,
         &quot;details.default.svc.cluster.local:9080&quot;,
         &quot;details&quot;,
         &quot;details:9080&quot;,
         &quot;details.default.svc.cluster&quot;,
         &quot;details.default.svc.cluster:9080&quot;,
         &quot;details.default.svc&quot;,
         &quot;details.default.svc:9080&quot;,
         &quot;details.default&quot;,
         &quot;details.default:9080&quot;,
         &quot;10.101.163.201&quot;,
         &quot;10.101.163.201:9080&quot;
        ],
        &quot;routes&quot;: [
         {
          &quot;match&quot;: {
           &quot;prefix&quot;: &quot;/&quot;
          },
          &quot;route&quot;: {
           &quot;cluster&quot;: &quot;outbound|9080||details.default.svc.cluster.local&quot;,
           &quot;timeout&quot;: &quot;0s&quot;,
           &quot;max_grpc_timeout&quot;: &quot;0s&quot;
          },
          &quot;decorator&quot;: {
           &quot;operation&quot;: &quot;details.default.svc.cluster.local:9080/*&quot;
          },
          &quot;per_filter_config&quot;: {
           &quot;mixer&quot;: {
            ......

           }
          }
         }
        ]
       },
       {
        &quot;name&quot;: &quot;ratings.default.svc.cluster.local:9080&quot;,
        &quot;domains&quot;: [
         &quot;ratings.default.svc.cluster.local&quot;,
         &quot;ratings.default.svc.cluster.local:9080&quot;,
         &quot;ratings&quot;,
         &quot;ratings:9080&quot;,
         &quot;ratings.default.svc.cluster&quot;,
         &quot;ratings.default.svc.cluster:9080&quot;,
         &quot;ratings.default.svc&quot;,
         &quot;ratings.default.svc:9080&quot;,
         &quot;ratings.default&quot;,
         &quot;ratings.default:9080&quot;,
         &quot;10.99.16.205&quot;,
         &quot;10.99.16.205:9080&quot;
        ],
        &quot;routes&quot;: [
         {
          &quot;match&quot;: {
           &quot;prefix&quot;: &quot;/&quot;
          },
          &quot;route&quot;: {
           &quot;cluster&quot;: &quot;outbound|9080||ratings.default.svc.cluster.local&quot;,
           &quot;timeout&quot;: &quot;0s&quot;,
           &quot;max_grpc_timeout&quot;: &quot;0s&quot;
          },
          &quot;decorator&quot;: {
           &quot;operation&quot;: &quot;ratings.default.svc.cluster.local:9080/*&quot;
          },
          &quot;per_filter_config&quot;: {
           &quot;mixer&quot;: {
           ......

            },
            &quot;disable_check_calls&quot;: true
           }
          }
         }
        ]
       },
       {
        &quot;name&quot;: &quot;reviews.default.svc.cluster.local:9080&quot;,
        &quot;domains&quot;: [
         &quot;reviews.default.svc.cluster.local&quot;,
         &quot;reviews.default.svc.cluster.local:9080&quot;,
         &quot;reviews&quot;,
         &quot;reviews:9080&quot;,
         &quot;reviews.default.svc.cluster&quot;,
         &quot;reviews.default.svc.cluster:9080&quot;,
         &quot;reviews.default.svc&quot;,
         &quot;reviews.default.svc:9080&quot;,
         &quot;reviews.default&quot;,
         &quot;reviews.default:9080&quot;,
         &quot;10.108.25.157&quot;,
         &quot;10.108.25.157:9080&quot;
        ],
        &quot;routes&quot;: [
         {
          &quot;match&quot;: {
           &quot;prefix&quot;: &quot;/&quot;
          },
          &quot;route&quot;: {
           &quot;cluster&quot;: &quot;outbound|9080||reviews.default.svc.cluster.local&quot;,
           &quot;timeout&quot;: &quot;0s&quot;,
           &quot;max_grpc_timeout&quot;: &quot;0s&quot;
          },
          &quot;decorator&quot;: {
           &quot;operation&quot;: &quot;reviews.default.svc.cluster.local:9080/*&quot;
          },
          &quot;per_filter_config&quot;: {
           &quot;mixer&quot;: {
            ......

            },
            &quot;disable_check_calls&quot;: true
           }
          }
         }
        ]
       }
      ],
      &quot;validate_clusters&quot;: false
     },
     &quot;last_updated&quot;: &quot;2018-09-27T07:17:50.242Z&quot;
    }
</code></pre>

<h3 id="bookinfo-ç«¯åˆ°ç«¯è°ƒç”¨åˆ†æ">Bookinfo ç«¯åˆ°ç«¯è°ƒç”¨åˆ†æ</h3>

<p>é€šè¿‡å‰é¢ç« èŠ‚å¯¹ Envoy é…ç½®æ–‡ä»¶çš„åˆ†æï¼Œæˆ‘ä»¬äº†è§£åˆ° Istio æ§åˆ¶å¹³é¢å¦‚ä½•å°†æœåŠ¡å’Œè·¯ç”±ä¿¡æ¯é€šè¿‡ xDS æ¥å£ä¸‹å‘åˆ°æ•°æ®å¹³é¢ä¸­ï¼›å¹¶ä»‹ç»äº† Envoy ä¸Šç”Ÿæˆçš„å„ç§é…ç½®æ•°æ®çš„ç»“æ„ï¼ŒåŒ…æ‹¬ listenerï¼Œclusterï¼Œroute å’Œ endpointã€‚</p>

<p>ä¸‹é¢æˆ‘ä»¬æ¥åˆ†æä¸€ä¸ªç«¯åˆ°ç«¯çš„è°ƒç”¨è¯·æ±‚ï¼Œé€šè¿‡è°ƒç”¨è¯·æ±‚çš„æµç¨‹æŠŠè¿™äº›é…ç½®ä¸²è¿èµ·æ¥ï¼Œä»¥ä»å…¨å±€ä¸Šç†è§£ Istio æ§åˆ¶å¹³é¢çš„æµé‡æ§åˆ¶æ˜¯å¦‚ä½•åœ¨æ•°æ®å¹³é¢çš„ Envoy ä¸Šå®ç°çš„ã€‚</p>

<p>ä¸‹å›¾æè¿°äº†ä¸€ä¸ª <code>Productpage</code> æœåŠ¡è°ƒç”¨ <code>Details</code> æœåŠ¡çš„è¯·æ±‚æµç¨‹ï¼š</p>

<p><center>

<div class="box" >
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img itemprop="thumbnail" src="https://hugo-picture.oss-cn-beijing.aliyuncs.com/images/post_loading.gif" data-original="https://hugo-picture.oss-cn-beijing.aliyuncs.com/images/yD84dx.jpg" alt="https://hugo-picture.oss-cn-beijing.aliyuncs.com/images/yD84dx.jpg"/>
    </div>
    <a href="https://hugo-picture.oss-cn-beijing.aliyuncs.com/images/yD84dx.jpg" itemprop="contentUrl"></a>
  </figure>
</div>
</center></p>

<p>1ã€Productpage å‘èµ·å¯¹ Details çš„è°ƒç”¨ï¼š<code>http://details:9080/details/0</code>ã€‚</p>

<p>2ã€è¯·æ±‚è¢« Pod çš„ iptables è§„åˆ™æ‹¦æˆªï¼Œè½¬å‘åˆ° 15001 ç«¯å£ã€‚</p>

<p>3ã€Envoy çš„ Virtual Listener åœ¨ <code>15001</code> ç«¯å£ä¸Šç›‘å¬ï¼Œæ”¶åˆ°äº†è¯¥è¯·æ±‚ã€‚</p>

<p>4ã€è¯·æ±‚è¢« Virtual Listener æ ¹æ®åŸç›®æ ‡ IPï¼ˆé€šé…ï¼‰å’Œç«¯å£ï¼ˆ9080ï¼‰è½¬å‘åˆ° <code>0.0.0.0_9080</code> è¿™ä¸ª listenerã€‚</p>

<pre><code class="language-json">{
 &quot;version_info&quot;: &quot;2018-09-06T09:34:19Z&quot;,
 &quot;listener&quot;: {
  &quot;name&quot;: &quot;virtual&quot;,
  &quot;address&quot;: {
   &quot;socket_address&quot;: {
    &quot;address&quot;: &quot;0.0.0.0&quot;,
    &quot;port_value&quot;: 15001
   }
  }
  ......

  &quot;use_original_dst&quot;: true //è¯·æ±‚è½¬å‘ç»™å’ŒåŸå§‹ç›®çš„IP:PortåŒ¹é…çš„listener
 },
</code></pre>

<p>5ã€æ ¹æ® 0.0.0.0_9080 listener çš„ <code>http_connection_manager filter</code> é…ç½®,è¯¥è¯·æ±‚é‡‡ç”¨ â€œ9080â€ route è¿›è¡Œåˆ†å‘ã€‚</p>

<pre><code class="language-json"> {
  &quot;version_info&quot;: &quot;2018-09-06T09:34:19Z&quot;,
  &quot;listener&quot;: {
   &quot;name&quot;: &quot;0.0.0.0_9080&quot;,
   &quot;address&quot;: {
    &quot;socket_address&quot;: {
     &quot;address&quot;: &quot;0.0.0.0&quot;,
     &quot;port_value&quot;: 9080
    }
   },
   &quot;filter_chains&quot;: [
    {
     &quot;filters&quot;: [
      {
       &quot;name&quot;: &quot;envoy.http_connection_manager&quot;,
       &quot;config&quot;: {
       ......

        &quot;rds&quot;: {
         &quot;route_config_name&quot;: &quot;9080&quot;,
         &quot;config_source&quot;: {
          &quot;ads&quot;: {}
         }
        },

      }
     ]
    }
   ],
   &quot;deprecated_v1&quot;: {
    &quot;bind_to_port&quot;: false
   }
  },
  &quot;last_updated&quot;: &quot;2018-09-06T09:34:26.172Z&quot;
 },

 {
  },
</code></pre>

<p>6ã€<code>9080</code> è¿™ä¸ª route çš„é…ç½®ä¸­ï¼Œhost name ä¸º <code>details:9080</code> çš„è¯·æ±‚å¯¹åº”çš„ cluster ä¸º <code>outbound|9080||details.default.svc.cluster.local</code></p>

<pre><code class="language-json"> {
  &quot;version_info&quot;: &quot;2018-09-14T01:38:20Z&quot;,
  &quot;route_config&quot;: {
   &quot;name&quot;: &quot;9080&quot;,
   &quot;virtual_hosts&quot;: [
    {
     &quot;name&quot;: &quot;details.default.svc.cluster.local:9080&quot;,
     &quot;domains&quot;: [
      &quot;details.default.svc.cluster.local&quot;,
      &quot;details.default.svc.cluster.local:9080&quot;,
      &quot;details&quot;,
      &quot;details:9080&quot;,
      &quot;details.default.svc.cluster&quot;,
      &quot;details.default.svc.cluster:9080&quot;,
      &quot;details.default.svc&quot;,
      &quot;details.default.svc:9080&quot;,
      &quot;details.default&quot;,
      &quot;details.default:9080&quot;,
      &quot;10.101.163.201&quot;,
      &quot;10.101.163.201:9080&quot;
     ],
     &quot;routes&quot;: [
      {
       &quot;match&quot;: {
        &quot;prefix&quot;: &quot;/&quot;
       },
       &quot;route&quot;: {
        &quot;cluster&quot;: &quot;outbound|9080||details.default.svc.cluster.local&quot;,
        &quot;timeout&quot;: &quot;0s&quot;,
        &quot;max_grpc_timeout&quot;: &quot;0s&quot;
       },
         ......

        }
       }
      }
     ]
    },
      ......

 {
  },   
</code></pre>

<p>7ã€<code>outbound|9080||details.default.svc.cluster.local</code> cluster ä¸ºåŠ¨æ€èµ„æºï¼Œé€šè¿‡ eds æŸ¥è¯¢å¾—åˆ°å…¶ endpoint ä¸º 192.168.206.21:9080ã€‚</p>

<pre><code class="language-json"> {
 &quot;clusterName&quot;: &quot;outbound|9080||details.default.svc.cluster.local&quot;,
 &quot;endpoints&quot;: [
 {
   &quot;locality&quot;: {

   },
   &quot;lbEndpoints&quot;: [
     {
       &quot;endpoint&quot;: {
         &quot;address&quot;: {
           &quot;socketAddress&quot;: {
             &quot;address&quot;: &quot;192.168.206.21&quot;,
             &quot;portValue&quot;: 9080
           }
         }
       },
      ......  
     }
   ]
 }
 ]
 }   
</code></pre>

<p>8ã€è¯·æ±‚è¢«è½¬å‘åˆ° 192.168.206.21ï¼Œå³ Details æœåŠ¡æ‰€åœ¨çš„ Podï¼Œè¢« iptables è§„åˆ™æ‹¦æˆªï¼Œè½¬å‘åˆ° 15001 ç«¯å£ã€‚</p>

<p>9ã€Envoy çš„ <code>Virtual Listener</code> åœ¨ 15001 ç«¯å£ä¸Šç›‘å¬ï¼Œæ”¶åˆ°äº†è¯¥è¯·æ±‚ã€‚</p>

<p>10ã€è¯·æ±‚è¢« Virtual Listener æ ¹æ®è¯·æ±‚åŸç›®æ ‡åœ°å€ IPï¼ˆ192.168.206.21ï¼‰å’Œç«¯å£ï¼ˆ9080ï¼‰è½¬å‘åˆ° <code>192.168.206.21_9080</code> è¿™ä¸ª listenerã€‚</p>

<p>11ã€æ ¹æ® 92.168.206.21_9080 listener çš„ <code>http_connection_manager filter</code> é…ç½®ï¼Œè¯¥è¯·æ±‚å¯¹åº”çš„ cluster ä¸º <code>inbound|9080||details.default.svc.cluster.local</code>ã€‚</p>

<pre><code class="language-json"> {
  &quot;version_info&quot;: &quot;2018-09-06T09:34:16Z&quot;,
  &quot;listener&quot;: {
   &quot;name&quot;: &quot;192.168.206.21_9080&quot;,
   &quot;address&quot;: {
    &quot;socket_address&quot;: {
     &quot;address&quot;: &quot;192.168.206.21&quot;,
     &quot;port_value&quot;: 9080
    }
   },
   &quot;filter_chains&quot;: [
    {
     &quot;filters&quot;: [
      {
       &quot;name&quot;: &quot;envoy.http_connection_manager&quot;,
       ......

       &quot;route_config&quot;: {
         &quot;name&quot;: &quot;inbound|9080||details.default.svc.cluster.local&quot;,
         &quot;validate_clusters&quot;: false,
         &quot;virtual_hosts&quot;: [
          {
           &quot;name&quot;: &quot;inbound|http|9080&quot;,
           &quot;routes&quot;: [
             ......

             &quot;route&quot;: {
              &quot;max_grpc_timeout&quot;: &quot;0.000s&quot;,
              &quot;cluster&quot;: &quot;inbound|9080||details.default.svc.cluster.local&quot;,
              &quot;timeout&quot;: &quot;0.000s&quot;
             },
             ......

             &quot;match&quot;: {
              &quot;prefix&quot;: &quot;/&quot;
             }
            }
           ],
           &quot;domains&quot;: [
            &quot;*&quot;
           ]
          }
         ]
        },
         ......

        ]
       }
      }
     ]
    }
   ],
   &quot;deprecated_v1&quot;: {
    &quot;bind_to_port&quot;: false
   }
  },
  &quot;last_updated&quot;: &quot;2018-09-06T09:34:22.184Z&quot;
 }   
</code></pre>

<p>12ã€<code>inbound|9080||details.default.svc.cluster.local</code> cluster é…ç½®çš„ host ä¸º<code>127.0.0.1:9080</code>ã€‚</p>

<p>13ã€è¯·æ±‚è¢«è½¬å‘åˆ° 127.0.0.1:9080ï¼Œå³ Details æœåŠ¡è¿›è¡Œå¤„ç†ã€‚</p>

<p>ä¸Šè¿°è°ƒç”¨æµç¨‹æ¶‰åŠçš„å®Œæ•´ Envoy é…ç½®æ–‡ä»¶å‚è§ï¼š</p>

<ul>
<li>Proudctpage ï¼š<a href="https://gist.github.com/zhaohuabing/034ef87786d290a4e89cd6f5ad6fcc97" target="_blank">https://gist.github.com/zhaohuabing/034ef87786d290a4e89cd6f5ad6fcc97</a></li>
<li>Details ï¼š<a href="https://gist.github.com/zhaohuabing/544d4d45447b65d10150e528a190f8ee" target="_blank">https://gist.github.com/zhaohuabing/544d4d45447b65d10150e528a190f8ee</a></li>
</ul>

<h2 id="å°ç»“">å°ç»“</h2>

<hr />

<p>æœ¬æ–‡ä»‹ç»äº† Istio æµé‡ç®¡ç†ç›¸å…³ç»„ä»¶ï¼ŒIstio æ§åˆ¶å¹³é¢å’Œæ•°æ®å¹³é¢ä¹‹é—´çš„æ ‡å‡†æ¥å£ï¼Œä»¥åŠ Istio ä¸‹å‘åˆ° Envoy çš„å®Œæ•´é…ç½®æ•°æ®çš„ç»“æ„å’Œå†…å®¹ã€‚ç„¶åé€šè¿‡ Bookinfo ç¤ºä¾‹ç¨‹åºçš„ä¸€ä¸ªç«¯åˆ°ç«¯è°ƒç”¨åˆ†æäº† Envoy æ˜¯å¦‚ä½•å®ç°æœåŠ¡ç½‘æ ¼ä¸­æœåŠ¡å‘ç°å’Œè·¯ç”±è½¬å‘çš„ï¼Œå¸Œæœ›èƒ½å¸®åŠ©å¤§å®¶é€è¿‡æ¦‚å¿µæ›´è¿›ä¸€æ­¥æ·±å…¥ç†è§£ Istio æµé‡ç®¡ç†çš„å®ç°æœºåˆ¶ã€‚</p>

<h2 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h2>

<hr />

<ol>
<li><a href="https://istio.io/docs/concepts/traffic-management/#pilot-and-envoy" target="_blank">Istio Traffic Managment Concept</a></li>
<li><a href="https://github.com/envoyproxy/data-plane-api/blob/master/API_OVERVIEW.md" target="_blank">Data Plane API</a></li>
<li><a href="https://kubernetes.io/docs/concepts/extend-kubernetes/api-extension/custom-resources" target="_blank">kubernetes Custom Resource</a></li>
<li><a href="https://github.com/istio/old_pilot_repo/blob/master/doc/design.md" target="_blank">Istio Pilot Design Overview</a></li>
<li><a href="https://www.envoyproxy.io/docs/envoy/latest/configuration/overview/v2_overview" target="_blank">Envoy V2 API Overview</a></li>
<li><a href="https://github.com/envoyproxy/data-plane-api/tree/master/envoy/api/v2" target="_blank">Data Plane API Protocol Buffer Definition</a></li>
<li><a href="https://github.com/envoyproxy/data-plane-api/blob/master/XDS_PROTOCOL.md" target="_blank">xDS REST and gRPC protocol</a></li>
<li><a href="https://github.com/istio/istio/tree/master/pilot/pkg/proxy/envoy/v2" target="_blank">Pilot Debug interface</a></li>
<li><a href="https://zhaohuabing.com/2018/05/23/istio-auto-injection-with-webhook/" target="_blank">Istio Sidecarè‡ªåŠ¨æ³¨å…¥åŸç†</a></li>
</ol>
         
	 
	 <br />
	 <div style="text-align:center;color: #ccc;font-size:16px;font-family: cursive;">-------ä»–æ—¥æ±Ÿæ¹–ç›¸é€¢ <i class="fa fa-umbrella" style="color:#986dbd"></i> å†å½“æ¯é…’è¨€æ¬¢-------</div>
         
           

<div class="entry-shang text-center">
	<p>ã€ŒçœŸè¯šèµèµï¼Œæ‰‹ç•™ä½™é¦™ã€</p>
        <button class="zs show-zs btn rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}"> <span>èµ</span> </button>
</div>
<div class="zs-modal-bg"></div>
<div class="zs-modal-box">
	<div class="zs-modal-head">
		<button type="button" class="close">Ã—</button>
		<span class="author"><img src="https://hugo-picture.oss-cn-beijing.aliyuncs.com/blog/2019-08-26-WechatIMG12268.jpeg"/>ç±³å¼€æœ—åŸºæ¨</span>
		<p class="tip"><i></i><span>çœŸè¯šèµèµï¼Œæ‰‹ç•™ä½™é¦™</span></p>
 	</div>
	<div class="zs-modal-body">
		<div class="zs-modal-btns">
			<button class="btn btn-blink" data-num="2">2å…ƒ</button>
			<button class="btn btn-blink" data-num="5">5å…ƒ</button>
			<button class="btn btn-blink" data-num="10">10å…ƒ</button>
			<button class="btn btn-blink" data-num="50">50å…ƒ</button>
			<button class="btn btn-blink" data-num="100">100å…ƒ</button>
			<button class="btn btn-blink" data-num="1">ä»»æ„é‡‘é¢</button>
		</div>
		<div class="zs-modal-pay">
			<button class="btn btn-bred" id="pay-text">2å…ƒ</button>
			<p>ä½¿ç”¨<span id="pay-type">å¾®ä¿¡</span>æ‰«æäºŒç»´ç å®Œæˆæ”¯ä»˜</p>
			<img src="/img/wechat-2.png" id="pay-image"/>
		</div>
	</div>
	<div class="zs-modal-footer">
                <span class="zs-wechat"><img src="/img/wechat-btn.png"/></span>
	</div>
</div>

         

        
          <div class="blog-tags">
            
              <a href="https://fuckcloudnative.io/tags/istio/"><i class="fa fa-tags"></i>istio</a>&nbsp;
            
              <a href="https://fuckcloudnative.io/tags/service-mesh/"><i class="fa fa-tags"></i>service mesh</a>&nbsp;
            
          </div>
        

        
            <hr/>
            <section id="social-share">
              <div class="list-inline footer-links">
                

<div class="share-box" aria-hidden="true">
    <ul class="share">
      
      <li>
	      <a href="//service.weibo.com/share/share.php?url=https%3a%2f%2ffuckcloudnative.io%2fposts%2fistio-traffic-management-impl-intro%2f&amp;title=Istio%20%e6%b5%81%e9%87%8f%e7%ae%a1%e7%90%86%e5%ae%9e%e7%8e%b0%e6%9c%ba%e5%88%b6%e6%b7%b1%e5%ba%a6%e8%a7%a3%e6%9e%90&amp;pic=https%3a%2f%2fhugo-picture.oss-cn-beijing.aliyuncs.com%2fimages%2f20191203152457.png" target="_blank" title="åˆ†äº«åˆ°å¾®åš">
          <i class="fab fa-weibo"></i>
        </a>
      </li>
      
      <li>
	      <a href="//connect.qq.com/widget/shareqq/index.html?url=https%3a%2f%2ffuckcloudnative.io%2fposts%2fistio-traffic-management-impl-intro%2f&amp;title=Istio%20%e6%b5%81%e9%87%8f%e7%ae%a1%e7%90%86%e5%ae%9e%e7%8e%b0%e6%9c%ba%e5%88%b6%e6%b7%b1%e5%ba%a6%e8%a7%a3%e6%9e%90&amp;source=Istio%20%e6%b5%81%e9%87%8f%e7%ae%a1%e7%90%86%e5%ae%9e%e7%8e%b0%e6%9c%ba%e5%88%b6%e6%b7%b1%e5%ba%a6%e8%a7%a3%e6%9e%90&amp;desc=&amp;pics=https%3a%2f%2fhugo-picture.oss-cn-beijing.aliyuncs.com%2fimages%2f20191203152457.png&amp;summary=" target="_blank" title="åˆ†äº«åˆ° QQ">
          <i class="fab fa-qq"></i>
        </a>
      </li>
      
      <li>
        <a href="//twitter.com/share?url=https%3a%2f%2ffuckcloudnative.io%2fposts%2fistio-traffic-management-impl-intro%2f&amp;text=Istio%20%e6%b5%81%e9%87%8f%e7%ae%a1%e7%90%86%e5%ae%9e%e7%8e%b0%e6%9c%ba%e5%88%b6%e6%b7%b1%e5%ba%a6%e8%a7%a3%e6%9e%90&amp;via=RyangYang1" target="_blank" title="åˆ†äº«åˆ° Twitter">
          <i class="fab fa-twitter"></i>
        </a>
      </li>
  
      
      <li>
        <a href="//www.facebook.com/sharer/sharer.php?u=https%3a%2f%2ffuckcloudnative.io%2fposts%2fistio-traffic-management-impl-intro%2f" target="_blank" title="åˆ†äº«åˆ° Facebook">
          <i class="fab fa-facebook"></i>
        </a>
      </li>
  
      
      <li>
	      <a href="//www.linkedin.com/shareArticle?url=https%3a%2f%2ffuckcloudnative.io%2fposts%2fistio-traffic-management-impl-intro%2f&amp;title=Istio%20%e6%b5%81%e9%87%8f%e7%ae%a1%e7%90%86%e5%ae%9e%e7%8e%b0%e6%9c%ba%e5%88%b6%e6%b7%b1%e5%ba%a6%e8%a7%a3%e6%9e%90" target="_blank" title="åˆ†äº«åˆ° LinkedIn">
          <i class="fab fa-linkedin"></i>
        </a>
      </li>
    </ul>
  </div>
  

              </div>
            </section>
        

        
          
            
          

          
                  <h4 class="see-also">ç›¸å…³æ¨è</h4>
                  <ul>
                
                
                    <li><a href="/posts/istio-deploy/">Istio 1.4 éƒ¨ç½²æŒ‡å—</a></li>
                
                    <li><a href="/posts/istio-1.3-tour/">æ‰‹æŠŠæ‰‹æ•™ä½ éƒ¨ç½² Istio 1.3</a></li>
                
                    <li><a href="/posts/istio-1.3/">Istio 1.3 å‘å¸ƒï¼ŒHTTP é¥æµ‹ä¸å†éœ€è¦ Mixer</a></li>
                
                    <li><a href="/posts/circuit_breaking-and-outlier-detection-in-istio/">ç†”æ–­ä¸å¼‚å¸¸æ£€æµ‹åœ¨ Istio ä¸­çš„åº”ç”¨</a></li>
                
                    <li><a href="/posts/life-of-a-packet-through-istio/">æ•°æ®åŒ…åœ¨ Istio ç½‘æ ¼ä¸­çš„ç”Ÿå‘½å‘¨æœŸ</a></li>
                
              </ul>

          
        
      </article>

      
        <ul class="pager blog-pager">
          
            <li class="previous">
              <a href="https://fuckcloudnative.io/posts/setting-up-ssl-in-envoy-practice/" data-toggle="tooltip" data-placement="top" title="Envoy åŸºç¡€æ•™ç¨‹ï¼šå¼€å¯ TLS éªŒè¯å®æˆ˜">&larr; å‰ä¸€ç¯‡</a>
            </li>
          
          
            <li class="next">
              <a href="https://fuckcloudnative.io/posts/envoy-xds-protocol/" data-toggle="tooltip" data-placement="top" title="Envoy åŸºç¡€æ•™ç¨‹ï¼šxDS REST å’Œ gRPC åè®®è¯¦è§£">åä¸€ç¯‡ &rarr;</a>
            </li>
          
        </ul>
      

      
	    <link rel="stylesheet" href="https://fuckcloudnative.io/css/iDisqus.min.css" />
<div id="comment"></div>
<script src="https://fuckcloudnative.io/js/iDisqus.min.js"></script>
<script>
var disq = new iDisqus('comment', {
    forum: 'fuckcloudnative',
    api: 'https://disqus.fuckcloudnative.io',
    site: 'http://fuckcloudnative.io',
    emojiPath: 'https://api.fooleap.org/emoji/unicode/',
    mode: 2,
    timeout: 15,
    init: true
});
</script>

      

    </div>
  </div>
</div>

      
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
              <li>
                <a href="mailto:yangchuansheng33@gmail.com" target="_blank" title="Email me">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x" style="color:#986dbd"></i>
                    <i class="fas fa-envelope fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://hugo-picture.oss-cn-beijing.aliyuncs.com/blog/2019-06-13-%E9%BB%98%E8%AE%A4%E6%A0%87%E9%A2%98_%E6%A8%AA%E7%89%88%E4%BA%8C%E7%BB%B4%E7%A0%81_2019.05.17.1.1.png" target="_blank" title="Weixin">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x" style="color:#986dbd"></i>
                    <i class="fab fa-weixin fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://github.com/yangchuansheng" target="_blank" title="GitHub">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x" style="color:#986dbd"></i>
                    <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://twitter.com/RyangYang1" target="_blank" title="Twitter">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x" style="color:#986dbd"></i>
                    <i class="fab fa-twitter fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://linkedin.com/in/yang-ryan-b6659b106" target="_blank" title="LinkedIn">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x" style="color:#986dbd"></i>
                    <i class="fab fa-linkedin fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://weibo.com/3496206342" target="_blank" title="å¾®åš">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x" style="color:#986dbd"></i>
                    <i class="fab fa-weibo fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://drive.google.com/drive/folders/0By_W-zIhlMXqSGJyU3pHaVVpV2M" target="_blank" title="è§†é¢‘åˆ†äº«">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x" style="color:#986dbd"></i>
                    <i class="fab fa-google-drive fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
          
          <li>
            <a href="https://fuckcloudnative.io/index.xml" target="_blank" title="RSS">
              <span class="fa-stack fa-lg">
                <i class="fas fa-circle fa-stack-2x" style="color:#986dbd"></i>
                <i class="fas fa-rss fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
        </ul>
	<br />
        <p class="credits copyright text-muted">
	  &nbsp;&bull;&nbsp;&copy;2019
          
            
              <a href="https://fuckcloudnative.io">ç±³å¼€æœ—åŸºæ¨</a>
            
          

          &nbsp;&bull;&nbsp;æ›´æ–°äº
          
            2020 å¹´ 2 æœˆ 10 æ—¥
          

	  &nbsp;&bull;&nbsp;
          <a href="https://fuckcloudnative.io/tags/">æ‰€æœ‰æ–‡ç« </a>

	  
        </p>
        <p class="credits theme-by text-muted">
        <br />
        <span id="busuanzi_container_site_pv">
            æœ¬ç«™å·²è¢«è®¿é—® <span id="busuanzi_value_site_pv"></span> æ¬¡å•¦
        </span>
        <span id="busuanzi_container_site_uv">
            &ensp;|&ensp;&thinsp;æ‚¨æ˜¯ç¬¬ <span id="busuanzi_value_site_uv"></span> ä½åˆ°è®¿çš„å°ä¼™ä¼´
        </span>
        </p>
        
        <p class="credits theme-by text-muted">
          ç”± <a href="https://gohugo.io">Hugo v0.59.0</a> å¼ºåŠ›é©±åŠ¨ &nbsp;&bull;&nbsp; ä¸»é¢˜ <a href="https://github.com/halogenica/beautifulhugo">Beautiful Hugo</a> ç§»æ¤è‡ª <a href="https://deanattali.com/beautiful-jekyll/">Beautiful Jekyll</a>
          
	  <section class="credits theme-by text-muted" align="center">
    <span class="footer__copyright">
    <div>
    <span id="span_dt_dt"> </span>
    <script language="javascript">
      function show_date_time(){
        window.setTimeout("show_date_time()", 1000);
        BirthDay=new Date("7/8/2017 10:56:12");
        today=new Date();
        timeold=(today.getTime()-BirthDay.getTime());
        sectimeold=timeold/1000
        secondsold=Math.floor(sectimeold);
        msPerDay=24*60*60*1000
        e_daysold=timeold/msPerDay
        daysold=Math.floor(e_daysold);
        e_hrsold=(e_daysold-daysold)*24;
        hrsold=Math.floor(e_hrsold);
        e_minsold=(e_hrsold-hrsold)*60;
        minsold=Math.floor((e_hrsold-hrsold)*60);
        seconds=Math.floor((e_minsold-minsold)*60);
        span_dt_dt.innerHTML="æœ¬ç«™å·²ç»å¼€å¿ƒè¿è¡Œ "+daysold+" å¤© "+hrsold+" å°æ—¶ "+minsold+" åˆ† "+seconds+" ç§’";
      }
      show_date_time();
    </script>
    </div>
</script>
</section>

	</p>
      </div>
    </div>
  </div>
</footer>


<script src="https://my.openwrite.cn/js/readmore.js" type="text/javascript"></script>
<script>
    const btw = new BTWPlugin();
    btw.init({
        id: 'container',
        blogId: '10020-1569254413955-300',
        name: 'äº‘åŸç”Ÿå®éªŒå®¤',
        qrcode: 'https://hugo-picture.oss-cn-beijing.aliyuncs.com/images/wechat.gif',
        keyword: 'vip',
    });
</script>
<script src='/js/bundle.min.13b2d74fbe48bdf362a1e1572571a00fa30ef02c3fa8f697c71a47c9462a759a.js' integrity='sha256-E7LXT75IvfNioeFXJXGgD6MO8Cw/qPaXxxpHyUYqdZo='></script>






<script src="https://fuckcloudnative.io/js/load-photoswipe.js"></script>








<div class="rocket"><img src="/img/rocket_up.png" alt="" width="100" height="100"></div>
<script>
    $(function () {
      $(window).scroll(function () {
        
        if ($(window).scrollTop() >= 1000) {
          $('.rocket').stop().fadeIn(1000);
        }else {
          $('.rocket').stop().fadeOut(1000);
        }
      })
      
      $('.rocket').click(function () {
        $('html,body').stop().animate({scrollTop:0},400);
       
      })
    })

</script>




<script type="text/javascript">
      jQuery(function() {
          jQuery("img").lazyload({threshold: 0,effect: "fadeIn"});
      });
</script>











<script type="text/javascript">
$(document).ready(function () {
  $(window).scroll(function(){
    $(".top-scroll-bar").attr("style", "width: " + ($(this).scrollTop() / ($(document).height() - $(this).height()) * 100) + "%; display: block;");
  });
})
</script>


<script type="text/javascript">
var a_idx = 0;
jQuery(document).ready(function($) {
    $("body").click(function(e) {
        var a = new Array("Docker", "Kubernetes", "Prometheus", "Envoy", "Istio", "coredns", "Service Mesh", "Cloud Native");
        var $i = $("<span />").text(a[a_idx]);
        a_idx = (a_idx + 1) % a.length;
        var x = e.pageX,
        y = e.pageY;
        function randomColor() {
          var flakeColor = new Array("#FFDA65", "#00BFFF", "#BA55D3", "#FFA07A", "#87CEEB", "#FFB6C1");
          var snowColor = flakeColor[Math.floor(flakeColor.length * Math.random())];
          return snowColor;
        }
        $i.css({
            "z-index": 999999999999999999999999999999999999999999999999999999999999999999999,
            "top": y - 20,
            "left": x,
            "position": "absolute",
            "font-weight": "bold",
            "color": randomColor()
        });
        $("body").append($i);
        $i.animate({
            "top": y - 180,
            "opacity": 0
        },
        1500,
        function() {
            $i.remove();
        });
    });
});
</script>


    
  </body>
</html>

