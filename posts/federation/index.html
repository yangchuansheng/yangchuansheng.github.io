<!DOCTYPE html>
<html lang="zh" itemscope itemtype="http://schema.org/WebPage">
  <head>
    

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <title>Kubernetes ä½¿ç”¨é›†ç¾¤è”é‚¦å®ç°å¤šé›†ç¾¤ç®¡ç† - Kubernetes|Docker|Istio|Envoy|Hugo|Golang|äº‘åŸç”Ÿ</title>


  <meta content="" name="keywords">

  <meta name="description" content="äº‘åŸç”Ÿå®éªŒå®¤æ˜¯ä¸€ä¸ªå…³æ³¨å®¹å™¨ã€kubernetesã€istioã€devopsã€prometheusã€envoyã€golangã€äº‘åŸç”Ÿã€å¾®æœåŠ¡ç­‰æŠ€æœ¯çš„ä¸ªäººåšå®¢ã€‚">
  <meta name="author" content="ç±³å¼€æœ—åŸºæ¨"/><script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "WebSite",
    "name": "äº‘åŸç”Ÿå®éªŒå®¤",
    
    "url": "https:\/\/fuckcloudnative.io"
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Organization",
  "name": "",
  "url": "https:\/\/fuckcloudnative.io"
  
  
  
  
}
</script>
<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [{
        "@type": "ListItem",
        "position": 1,
        "item": {
          "@id": "https:\/\/fuckcloudnative.io",
          "name": "home"
        }
    },{
        "@type": "ListItem",
        "position": 3,
        "item": {
          "@id": "https:\/\/fuckcloudnative.io\/posts\/federation\/",
          "name": "Kubernetes ä½¿ç”¨é›†ç¾¤è”é‚¦å®ç°å¤šé›†ç¾¤ç®¡ç†"
        }
    }]
}
</script><script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Article",
  "author": {
    "name" : "ç±³å¼€æœ—åŸºæ¨"
  },
  "headline": "Kubernetes ä½¿ç”¨é›†ç¾¤è”é‚¦å®ç°å¤šé›†ç¾¤ç®¡ç†",
  "description" : "åœ¨äº‘è®¡ç®—ç¯å¢ƒä¸­ï¼ŒæœåŠ¡çš„ä½œç”¨è·ç¦»èŒƒå›´ä»è¿‘åˆ°è¿œä¸€èˆ¬å¯ä»¥æœ‰ï¼š åŒä¸»æœºï¼ˆHostï¼ŒNodeï¼‰ è·¨ä¸»æœºåŒå¯ç”¨åŒºï¼ˆAvailable Zoneï¼‰ è·¨å¯ç”¨åŒºåŒåœ°åŒº",
  "inLanguage" : "zh",
  "wordCount":  4443 ,
  "datePublished" : "2018-03-22T09:36:27",
  "dateModified" : "2018-03-22T09:36:27",
  "image" : "https:\/\/hugo-picture.oss-cn-beijing.aliyuncs.com\/blog\/2019-08-26-WechatIMG12268.jpeg",
  "keywords" : [ "kubernetes" ],
  "mainEntityOfPage" : "https:\/\/fuckcloudnative.io\/posts\/federation\/",
  "publisher" : {
    "@type": "Organization",
    "name" : "https:\/\/fuckcloudnative.io",
    "logo" : {
        "@type" : "ImageObject",
        "url" : "https:\/\/hugo-picture.oss-cn-beijing.aliyuncs.com\/blog\/2019-08-26-WechatIMG12268.jpeg",
        "height" :  60 ,
        "width" :  60
    }
  }
}
</script>

<meta property="og:title" content="Kubernetes ä½¿ç”¨é›†ç¾¤è”é‚¦å®ç°å¤šé›†ç¾¤ç®¡ç†" />
<meta property="og:description" content="ä½¿ç”¨è”é‚¦æœåŠ¡è¿›è¡Œè·¨é›†ç¾¤æœåŠ¡å‘ç°">
<meta property="og:image" content="https://hugo-picture.oss-cn-beijing.aliyuncs.com/blog/2019-08-26-WechatIMG12268.jpeg" />
<meta property="og:url" content="https://fuckcloudnative.io/posts/federation/" />
<meta property="og:type" content="website" />
<meta property="og:site_name" content="äº‘åŸç”Ÿå®éªŒå®¤" />

  <meta name="twitter:title" content="Kubernetes ä½¿ç”¨é›†ç¾¤è”é‚¦å®ç°å¤šé›†ç¾¤ç®¡ç†" />
  <meta name="twitter:description" content="ä½¿ç”¨è”é‚¦æœåŠ¡è¿›è¡Œè·¨é›†ç¾¤æœåŠ¡å‘ç°">
  <meta name="twitter:image" content="https://hugo-picture.oss-cn-beijing.aliyuncs.com/blog/2019-08-26-WechatIMG12268.jpeg" />
  <meta name="twitter:card" content="summary" />
  <meta name="twitter:site" content="@RyangYang1" />
  <meta name="twitter:creator" content="@RyangYang1" />

  <link href='https://hugo-picture.oss-cn-beijing.aliyuncs.com/favicon-32x32.png' rel='icon' type='image/x-icon'/>
  <meta name="generator" content="Hugo 0.59.0" />
  <link rel="alternate" href="https://fuckcloudnative.io/index.xml" type="application/rss+xml" title="äº‘åŸç”Ÿå®éªŒå®¤">
  
  
  
  <link href="https://cdn.bootcss.com/photoswipe/4.1.2/photoswipe.min.css" rel="stylesheet">
  <link href="https://cdn.bootcss.com/photoswipe/4.1.2/default-skin/default-skin.min.css" rel="stylesheet">


<link rel="stylesheet" href='/css/bundle.min.ca81645448b32fad41ea71de0716262d9ced5a37dc1c2499fbf80a12c2740528.css' integrity='sha256-yoFkVEizL61B6nHeBxYmLZztWjfcHCSZ&#43;/gKEsJ0BSg='>





<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?efe96f04908ae320df234a4f5626879e";
  var s = document.getElementsByTagName("script")[0];
  s.parentNode.insertBefore(hm, s);
})();
</script>

<script src="https://fuckcloudnative.io/js/pace.min.js"></script>



<script src="https://fuckcloudnative.io/js/busuanzi.pure.mini.js"></script>
<script>
var int = setInterval(fixCount, 50);
function fixCount() {
    if (document.getElementById('busuanzi_container_site_uv').ownerDocument.defaultView.getComputedStyle(document.getElementById('busuanzi_container_site_uv'), null).display === 'inline') {
        clearInterval(int);
        document.getElementById('busuanzi_value_site_uv') = parseInt(document.getElementById('busuanzi_value_site_uv').innerHTML) + parseInt('100000');
    }
}
</script>







    <div class="top-scroll-bar"></div>



<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-145022311-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


  </head>
  <body>
    <nav class="navbar navbar-default navbar-fixed-top navbar-custom">
  <div class="container-fluid">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#main-navbar">
        <span class="sr-only">åˆ‡æ¢å¯¼èˆª</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      
      <a class="navbar-brand" href="https://fuckcloudnative.io">ğŸ³ > $ cd /home/</a>
      
    </div>

    <div class="collapse navbar-collapse" id="main-navbar">
      <ul class="nav navbar-nav navbar-right">
        
          
            <li class="navlinks-container">
		    <a class="navlinks-parent"><i class="fas fa-dharmachakra fa-spin" style="color:#986dbd"></i> æ–‡ç« åˆ†ç±»</a>
              <div class="navlinks-children">
                
                  <a href="/categories/kubernetes/">kubernetes</a>
                
                  <a href="/categories/monitoring/">ç›‘æ§</a>
                
                  <a href="/categories/service-mesh/">Service Mesh</a>
                
                  <a href="/categories/devops/">DevOps</a>
                
                  <a href="/categories/docker/">Docker</a>
                
                  <a href="/categories/linux/">Linux</a>
                
                  <a href="/categories/python/">Python</a>
                
                  <a href="/categories/network/">ç½‘ç»œ</a>
                
                  <a href="/categories/loadbalance/"> è´Ÿè½½å‡è¡¡</a>
                
                  <a href="/categories/gfw/">ç§‘å­¦ä¸Šç½‘</a>
                
                  <a href="/categories/math/">æ•°å­¦</a>
                
                  <a href="/categories/share/">é»‘ç§‘æŠ€</a>
                
                  <a href="/categories/hugo/">Hugo</a>
                
              </div>
            </li>
          
        
          
            <li class="navlinks-container">
		    <a class="navlinks-parent"><i class="fab fa-docker"></i> ç”µå­ä¹¦</a>
              <div class="navlinks-children">
                
                  <a href="/prometheus-handbook/">Prometheus ä¸­æ–‡æ–‡æ¡£</a>
                
                  <a href="/talent-is-overrated/">å¤©æ‰æºè‡ªåˆ»æ„ç»ƒä¹ </a>
                
                  <a href="/the-way-to-go/">Go å…¥é—¨æŒ‡å—</a>
                
                  <a href="https://github.com/fengdu78/Coursera-ML-AndrewNg-Notes">æœºå™¨å­¦ä¹ ç¬”è®°</a>
                
                  <a href="https://github.com/ruanyf/reading-list">é˜®ä¸€å³°ä¹¦å•</a>
                
                  <a href="https://istio.io/zh/docs">Istio service mesh</a>
                
                  <a href="https://www.gitbook.com/book/yeasy/docker_practice">Docker handbook</a>
                
              </div>
            </li>
          
        
          
            <li class="navlinks-container">
		    <a class="navlinks-parent"><i class="fas fa-book"></i> è‘µèŠ±å®å…¸</a>
              <div class="navlinks-children">
                
                  <a href="/learn-english/"> è‹±è¯­å­¦ä¹ ç»ˆæç§˜è¯€</a>
                
                  <a href="/a-day-in-the-life-of-jeff/">A Day in the life of Jeff</a>
                
              </div>
            </li>
          
        
          
            <li class="navlinks-container">
		    <a class="navlinks-parent"> ğŸ˜±ç¦åˆ©</a>
              <div class="navlinks-children">
                
                  <a href="https://bt.fuckcloudnative.io">ç§å­æœç´¢</a>
                
              </div>
            </li>
          
        
          
            <li>
              <a title="Rss è®¢é˜…" href="/index.xml">Rss è®¢é˜…</a>
            </li>
          
        

        

        
        
          <li>
            <a href="#modalSearch" data-toggle="modal" data-target="#modalSearch" style="outline: none;">
              <span class="hidden-sm hidden-md hidden-lg">æœç´¢</span> <span id="searchGlyph" class="glyphicon glyphicon-search"></span>
            </a>
          </li>
        
      </ul>
    </div>

    
      <div class="avatar-container">
        <div class="avatar-img-border">
          <a title="äº‘åŸç”Ÿå®éªŒå®¤" href="https://fuckcloudnative.io">
            <img class="avatar-img" src="https://hugo-picture.oss-cn-beijing.aliyuncs.com/blog/2019-08-26-WechatIMG12268.jpeg" alt="äº‘åŸç”Ÿå®éªŒå®¤" />
          </a>
        </div>
      </div>
    

  </div>
</nav>





  <div id="modalSearch" class="modal fade" role="dialog">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal">&times;</button>
          <h4 class="modal-title">Search fuckcloudnative.io</h4>
        </div>
        <div class="modal-body">
            
<div class="aa-input-container" id="aa-input-container">
    <input type="search" id="aa-search-input" class="aa-input-search" placeholder="Search for titles or URIs..." name="search" autocomplete="off" />
    <svg class="aa-input-icon" viewBox="654 -372 1664 1664">
        <path d="M1806,332c0-123.3-43.8-228.8-131.5-316.5C1586.8-72.2,1481.3-116,1358-116s-228.8,43.8-316.5,131.5  C953.8,103.2,910,208.7,910,332s43.8,228.8,131.5,316.5C1129.2,736.2,1234.7,780,1358,780s228.8-43.8,316.5-131.5  C1762.2,560.8,1806,455.3,1806,332z M2318,1164c0,34.7-12.7,64.7-38,90s-55.3,38-90,38c-36,0-66-12.7-90-38l-343-342  c-119.3,82.7-252.3,124-399,124c-95.3,0-186.5-18.5-273.5-55.5s-162-87-225-150s-113-138-150-225S654,427.3,654,332  s18.5-186.5,55.5-273.5s87-162,150-225s138-113,225-150S1262.7-372,1358-372s186.5,18.5,273.5,55.5s162,87,225,150s113,138,150,225  S2062,236.7,2062,332c0,146.7-41.3,279.7-124,399l343,343C2305.7,1098.7,2318,1128.7,2318,1164z" />
    </svg>
</div>


<script src="https://fuckcloudnative.io/js/algoliasearch.min.js"></script>
<script src="https://fuckcloudnative.io/js/autocomplete.min.js"></script>


<script>
var client = algoliasearch("4BELQK2TOI", "62fd06bd949abb4211bfab0aa288f67b");
var index = client.initIndex('blog');

autocomplete('#aa-search-input',
{ hint: false}, {
    source: autocomplete.sources.hits(index, {hitsPerPage: 5}),
    
    displayKey: 'name',
    
    templates: {
        
        suggestion: function(suggestion) {
            
            return '<span>' + '<a href="/' + suggestion.uri+ '">' +
            suggestion._highlightResult.title.value + '</a></span>';
        }
    }
});
</script>

        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">close</button>
        </div>
      </div>
    </div>
  </div>


    


<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

<div class="pswp__bg"></div>

<div class="pswp__scroll-wrap">
    
    <div class="pswp__container">
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
      <div class="pswp__item"></div>
    </div>
    
    <div class="pswp__ui pswp__ui--hidden">
    <div class="pswp__top-bar">
      
      <div class="pswp__counter"></div>
      <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
      <button class="pswp__button pswp__button--share" title="Share"></button>
      <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
      <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
      
      
      <div class="pswp__preloader">
        <div class="pswp__preloader__icn">
          <div class="pswp__preloader__cut">
            <div class="pswp__preloader__donut"></div>
          </div>
        </div>
      </div>
    </div>
    <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
      <div class="pswp__share-tooltip"></div>
    </div>
    <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
    </button>
    <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
    </button>
    <div class="pswp__caption">
      <div class="pswp__caption__center"></div>
    </div>
    </div>
    </div>
</div>


  
  
  






  
    <div id="header-big-imgs" data-num-img=1 
      
         
          data-img-src-1="https://hugo-picture.oss-cn-beijing.aliyuncs.com/blog/2019-04-27-080627.jpg" 
         
         
      ></div>
  

  <header class="header-section has-img">
    
      <div class="intro-header big-img">
        
        <div class="container">
          <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
              <div class="post-heading">
		  
		      <h1 align="center">Kubernetes ä½¿ç”¨é›†ç¾¤è”é‚¦å®ç°å¤šé›†ç¾¤ç®¡ç†</h1>
		  
                  
                    
		      <hr class="small">
                      <h2 class="post-subheading">ä½¿ç”¨è”é‚¦æœåŠ¡è¿›è¡Œè·¨é›†ç¾¤æœåŠ¡å‘ç°</h2>
                    
                  
                  
                    <span class="post-meta">
  
  
  <i class="fas fa-calendar"></i>&nbsp;å‘è¡¨äº 2018 å¹´ 3 æœˆ 22 æ—¥
  
  
    &nbsp;|&nbsp;<i class="fas fa-clock"></i>&nbsp;9&nbsp;åˆ†é’Ÿ
  
  
    &nbsp;|&nbsp;<i class="fas fa-book"></i>&nbsp;4443&nbsp;ä¸ªå­—
  
  
    
    
  
  &nbsp;|&nbsp;<i class="fas fa-book-reader"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>æ¬¡é˜…è¯»
  
</span>

                  
              </div>
            </div>
          </div>
        </div>
        <span class="img-desc" style="display: inline;"></span>
      </div>
    
    <div class="intro-header no-img">
      <div class="container">
        <div class="row">
          <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
            <div class="post-heading">
              
                <h1>Kubernetes ä½¿ç”¨é›†ç¾¤è”é‚¦å®ç°å¤šé›†ç¾¤ç®¡ç†</h1>
              
              
              
                
                  <h2 class="post-subheading">ä½¿ç”¨è”é‚¦æœåŠ¡è¿›è¡Œè·¨é›†ç¾¤æœåŠ¡å‘ç°</h2>
                
              
              
                <span class="post-meta">
  
  
  <i class="fas fa-calendar"></i>&nbsp;å‘è¡¨äº 2018 å¹´ 3 æœˆ 22 æ—¥
  
  
    &nbsp;|&nbsp;<i class="fas fa-clock"></i>&nbsp;9&nbsp;åˆ†é’Ÿ
  
  
    &nbsp;|&nbsp;<i class="fas fa-book"></i>&nbsp;4443&nbsp;ä¸ªå­—
  
  
    
    
  
  &nbsp;|&nbsp;<i class="fas fa-book-reader"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>æ¬¡é˜…è¯»
  
</span>

              
            </div>
          </div>
        </div>
      </div>
    </div>
  </header>


    
<div class="container" role="main">
  <div class="row">
    <div id="container" class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
      <a title="æ¬ç“¦å·¥" href="https://bandwagonhost.com/aff.php?aff=54207" target="_blank">
<p id="sponsor-text" style="box-sizing: border-box;
    text-align: center;
    width: 100%;
    border: 1px solid #e5e4e9;
    background-color: #d0e4a9;
    margin: 1em 0 0;
    padding: 0.6em 0.6em 0.4em 0.6em;
    border-radius: 0.3em 0.3em 0.1em 0.1em;
    color: #076a66;"><span style="text-decoration: underline;">æ¬ç“¦å·¥</span>é¦™æ¸¯ VPS CN2ï¼Œè¶…ä½ä»· <span style="text-decoration: underline;">$2.99/å¹´</span>èµ·ã€‚é€‚åˆæ–°æ‰‹å…¥é—¨å»ºç«™ï¼Œæˆ‘çš„åšå®¢å°±æ˜¯åœ¨è¿™ä¸Šé¢æ­å»ºçš„</p>
<p style="padding:0em;margin:0 0 1.5em 0;border: 1px solid #e5e4e9;border-radius: 0.1em 0.1em 0.3em 0.3em;background-color: #28344a;text-align: center;" class="entry-sponsor-img">
  <img alt="æ¬ç“¦å·¥" id="support-img" src="https://hugo-picture.oss-cn-beijing.aliyuncs.com/images/bandwagonhost.jpg" style="border: none;width: 100%;max-width: 100%;display: inline-block;">

</p>
</a>

      <article role="main" class="blog-post">
	
<aside class="toc">
    <div id='anchors-navbar'>
        <i class='fa fa-anchor'></i>
        <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#span-id-inline-toc-1-span-kubernetesé›†ç¾¤è”é‚¦ä»‹ç»"><span id="inline-toc">1.</span> Kubernetesé›†ç¾¤è”é‚¦ä»‹ç»</a>
<ul>
<li><a href="#ç®¡ç†å¤šä¸ª-kuberntes-é›†ç¾¤">ç®¡ç†å¤šä¸ª kuberntes é›†ç¾¤</a></li>
<li><a href="#è·¨é›†ç¾¤æœåŠ¡å‘ç°">è·¨é›†ç¾¤æœåŠ¡å‘ç°</a></li>
<li><a href="#è·¨é›†ç¾¤è°ƒåº¦">è·¨é›†ç¾¤è°ƒåº¦</a></li>
<li><a href="#é›†ç¾¤é«˜å¯ç”¨-æ•…éšœè‡ªåŠ¨è¿ç§»">é›†ç¾¤é«˜å¯ç”¨ï¼Œæ•…éšœè‡ªåŠ¨è¿ç§»</a></li>
</ul></li>
<li><a href="#span-id-inline-toc-2-span-ä½¿ç”¨é›†ç¾¤è”é‚¦å®ç°å¤šé›†ç¾¤ç®¡ç†"><span id="inline-toc">2.</span> ä½¿ç”¨é›†ç¾¤è”é‚¦å®ç°å¤šé›†ç¾¤ç®¡ç†</a>
<ul>
<li><a href="#ç³»ç»Ÿç¯å¢ƒ">ç³»ç»Ÿç¯å¢ƒ</a></li>
<li><a href="#å®‰è£…-kubefed">å®‰è£… kubefed</a></li>
<li><a href="#é…ç½®-context">é…ç½® context</a></li>
<li><a href="#è®¾ç½®-coredns-ä½œä¸ºé›†ç¾¤è”é‚¦çš„-dns-æä¾›å•†">è®¾ç½® CoreDNS ä½œä¸ºé›†ç¾¤è”é‚¦çš„ DNS æä¾›å•†</a>
<ul>
<li><a href="#å‰æ">å‰æ</a></li>
<li><a href="#ä½¿æœ¬åœ°é›†ç¾¤æ”¯æŒ-loadbalancer-æœåŠ¡">ä½¿æœ¬åœ°é›†ç¾¤æ”¯æŒ LoadBalancer æœåŠ¡</a></li>
<li><a href="#å®‰è£…-helm">å®‰è£… helm</a></li>
<li><a href="#éƒ¨ç½²-etcd">éƒ¨ç½² etcd</a></li>
<li><a href="#éƒ¨ç½²-coredns">éƒ¨ç½² CoreDNS</a></li>
<li><a href="#ä½¿ç”¨-coredns-ä½œä¸º-dns-æä¾›å•†æ¥éƒ¨ç½²-federation">ä½¿ç”¨ CoreDNS ä½œä¸º DNS æä¾›å•†æ¥éƒ¨ç½² Federation</a></li>
<li><a href="#æ·»åŠ é›†ç¾¤è‡³-federation">æ·»åŠ é›†ç¾¤è‡³ federation</a></li>
</ul></li>
</ul></li>
<li><a href="#span-id-inline-toc-3-span-federation-æ”¯æŒçš„æœåŠ¡"><span id="inline-toc">3.</span> Federation æ”¯æŒçš„æœåŠ¡</a></li>
<li><a href="#span-id-inline-toc-4-span-å‚è€ƒæ–‡æ¡£"><span id="inline-toc">4.</span> å‚è€ƒæ–‡æ¡£</a></li>
</ul></li>
</ul>
</nav>
    </div>
    
</aside>


        
         

         
           
           

<p>åœ¨äº‘è®¡ç®—ç¯å¢ƒä¸­ï¼ŒæœåŠ¡çš„ä½œç”¨è·ç¦»èŒƒå›´ä»è¿‘åˆ°è¿œä¸€èˆ¬å¯ä»¥æœ‰ï¼š</p>

<ul>
<li>åŒä¸»æœºï¼ˆHostï¼ŒNodeï¼‰</li>
<li>è·¨ä¸»æœºåŒå¯ç”¨åŒºï¼ˆAvailable Zoneï¼‰</li>
<li>è·¨å¯ç”¨åŒºåŒåœ°åŒºï¼ˆRegionï¼‰</li>
<li>è·¨åœ°åŒºåŒæœåŠ¡å•†ï¼ˆCloud Service Providerï¼‰</li>
<li>è·¨äº‘å¹³å°</li>
</ul>

<p>K8s çš„è®¾è®¡å®šä½æ˜¯å•ä¸€é›†ç¾¤åœ¨åŒä¸€ä¸ªåœ°åŸŸå†…ï¼Œå› ä¸ºåŒä¸€ä¸ªåœ°åŒºçš„ç½‘ç»œæ€§èƒ½æ‰èƒ½æ»¡è¶³ K8s çš„è°ƒåº¦å’Œè®¡ç®—å­˜å‚¨è¿æ¥è¦æ±‚ã€‚</p>

<p>ä½†æ˜¯å®é™…æƒ…å†µä¸­ç»å¸¸é‡åˆ°çš„ä¸€äº›é—®é¢˜ï¼Œå°±æ˜¯å•ä¸ªé›†ç¾¤é€šå¸¸æ— æ³•è·¨å•ä¸ªäº‘å‚å•†çš„å¤šä¸ª Regionï¼Œæ›´ä¸ç”¨è¯´æ”¯æŒè·¨è·¨åŸŸä¸åŒçš„äº‘å‚å•†ã€‚è¿™æ ·ä¼šç»™ä¼ä¸šå¸¦æ¥ä¸€äº›æ‹…å¿§ï¼Œå¦‚ä½•åº”å¯¹å¯ç”¨åŒºçº§åˆ«çš„ Failï¼Œä»¥åŠå®¹ç¾å¤‡ä»½ï¼Ÿæ˜¯å¦ä¼šé€ æˆå‚å•†é”å®šï¼Œå¢åŠ è¿ç§»æˆæœ¬ï¼Ÿå¦‚ä½•åº”å¯¹çº¿ä¸Šçº¿ä¸‹çªå‘æµé‡ï¼Ÿå¦‚ä½•ç»Ÿä¸€ç®¡ç†è°ƒåº¦å®¹å™¨èµ„æºï¼Ÿå•ä¸ªé›†ç¾¤è§„æ¨¡çš„ä¸Šé™ç­‰ç­‰ã€‚</p>

<p>é›†ç¾¤è”é‚¦ï¼ˆFederationï¼‰å¯ä»¥ä¸€å®šç¨‹åº¦ä¸Šè§£å†³è¿™äº›é—®é¢˜ã€‚<code>Federation</code> æ˜¯å¯ä»¥å°†åˆ†å¸ƒåœ¨å¤šä¸ª Region æˆ–è€…å¤šä¸ªäº‘å‚å•†çš„ Kubernetes é›†ç¾¤æ•´åˆæˆä¸€ä¸ªå¤§çš„é›†ç¾¤ï¼Œç»Ÿä¸€ç®¡ç†ä¸è°ƒåº¦ã€‚</p>

<h2 id="span-id-inline-toc-1-span-kubernetesé›†ç¾¤è”é‚¦ä»‹ç»"><span id="inline-toc">1.</span> Kubernetesé›†ç¾¤è”é‚¦ä»‹ç»</h2>

<hr />

<h3 id="ç®¡ç†å¤šä¸ª-kuberntes-é›†ç¾¤">ç®¡ç†å¤šä¸ª kuberntes é›†ç¾¤</h3>

<p><strong>é›†ç¾¤è”é‚¦</strong>åœ¨æ¶æ„ä¸ŠåŒ kubernetes é›†ç¾¤å¾ˆç›¸ä¼¼ã€‚æœ‰ä¸€ä¸ª<strong>é›†ç¾¤è”é‚¦</strong>çš„ API server æä¾›ä¸€ä¸ªæ ‡å‡†çš„ Kubernetes APIï¼Œå¹¶ä¸”é€šè¿‡ etcd æ¥å­˜å‚¨çŠ¶æ€ã€‚ä¸åŒçš„æ˜¯ï¼Œä¸€ä¸ªé€šå¸¸çš„Kubernetes åªæ˜¯ç®¡ç†èŠ‚ç‚¹è®¡ç®—ï¼Œè€Œ<strong>é›†ç¾¤è”é‚¦</strong>ç®¡ç†æ‰€æœ‰çš„ kubernetes é›†ç¾¤ã€‚</p>

<p><center>
<link rel="stylesheet" href="https://fuckcloudnative.io/css/hugo-easy-gallery.css" />
<div class="box" >
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img itemprop="thumbnail" src="https://hugo-picture.oss-cn-beijing.aliyuncs.com/images/post_loading.gif" data-original="https://hugo-picture.oss-cn-beijing.aliyuncs.com/images/PJSV9a.jpg" alt="https://hugo-picture.oss-cn-beijing.aliyuncs.com/images/PJSV9a.jpg"/>
    </div>
    <a href="https://hugo-picture.oss-cn-beijing.aliyuncs.com/images/PJSV9a.jpg" itemprop="contentUrl"></a>
  </figure>
</div>
</center></p>

<p>Federationä¸»è¦åŒ…æ‹¬ä¸‰ä¸ªç»„ä»¶ï¼š</p>

<ul>
<li><strong>federation-apiserverï¼š</strong>ç±»ä¼¼ <code>kube-apiserver</code>ï¼Œä½†æä¾›çš„æ˜¯è·¨é›†ç¾¤çš„ REST API</li>
<li><strong>federation-controller-managerï¼š</strong>ç±»ä¼¼ <code>kube-controller-manager</code>ï¼Œä½†æä¾›å¤šé›†ç¾¤çŠ¶æ€çš„åŒæ­¥æœºåˆ¶</li>
<li><strong>kubefedï¼š</strong>Federation ç®¡ç†å‘½ä»¤è¡Œå·¥å…·</li>
</ul>

<p>ç”¨æˆ·å¯ä»¥é€šè¿‡ Federation çš„ API Server æ³¨å†Œè¯¥ Federation çš„æˆå‘˜ <code>K8s Cluster</code>ã€‚å½“ç”¨æˆ·é€šè¿‡ Federation çš„ API Server åˆ›å»ºã€æ›´æ”¹ API å¯¹è±¡æ—¶ï¼Œ<code>Federation API Server</code> ä¼šåœ¨è‡ªå·±æ‰€æœ‰æ³¨å†Œçš„å­ K8s Cluster éƒ½åˆ›å»ºä¸€ä»½å¯¹åº”çš„ API å¯¹è±¡ã€‚</p>

<p>åœ¨æä¾›ä¸šåŠ¡è¯·æ±‚æœåŠ¡æ—¶ï¼Œ<code>K8s Federation</code> ä¼šå…ˆåœ¨è‡ªå·±çš„å„ä¸ªå­ Cluster ä¹‹é—´åšè´Ÿè½½å‡è¡¡ï¼Œè€Œå¯¹äºå‘é€åˆ°æŸä¸ªå…·ä½“ <code>K8s Cluster</code> çš„ä¸šåŠ¡è¯·æ±‚ï¼Œä¼šä¾ç…§è¿™ä¸ª K8s Cluster ç‹¬ç«‹æä¾›æœåŠ¡æ—¶ä¸€æ ·çš„è°ƒåº¦æ¨¡å¼å»åš K8s Cluster å†…éƒ¨çš„è´Ÿè½½å‡è¡¡ã€‚è€ŒCluster ä¹‹é—´çš„è´Ÿè½½å‡è¡¡æ˜¯é€šè¿‡åŸŸåæœåŠ¡çš„è´Ÿè½½å‡è¡¡æ¥å®ç°çš„ã€‚</p>

<p>æ‰€æœ‰çš„è®¾è®¡éƒ½å°½é‡ä¸å½±å“ K8s Cluster ç°æœ‰çš„å·¥ä½œæœºåˆ¶ï¼Œè¿™æ ·å¯¹äºæ¯ä¸ªå­ K8s é›†ç¾¤æ¥è¯´ï¼Œå¹¶ä¸éœ€è¦æ›´å¤–å±‚çš„æœ‰ä¸€ä¸ª K8s Federationï¼Œä¹Ÿå°±æ˜¯æ„å‘³ç€æ‰€æœ‰ç°æœ‰çš„ K8s ä»£ç å’Œæœºåˆ¶ä¸éœ€è¦å› ä¸º <code>Federation</code> åŠŸèƒ½æœ‰ä»»ä½•å˜åŒ–ã€‚</p>

<h3 id="è·¨é›†ç¾¤æœåŠ¡å‘ç°">è·¨é›†ç¾¤æœåŠ¡å‘ç°</h3>

<p>Kubernetes æœ‰ä¸€ä¸ªæ ‡å‡†çš„æ’ä»¶ï¼š<code>kube-dns</code>ï¼Œè¿™ä¸ªæ’ä»¶å¯ä»¥åœ¨é›†ç¾¤å†…éƒ¨æä¾› DNS æœåŠ¡ï¼Œé€šè¿‡ DNS è§£æ service åå­—æ¥è®¿é—® kubernetes æœåŠ¡ã€‚<br /></p>

<p>Kubernetes æœåŠ¡æ˜¯ç”±ä¸€ç»„ kubernetes POD ç»„æˆçš„ï¼Œè¿™äº› POD æ˜¯ä¸€äº›å·²ç»å®¹å™¨åŒ–äº†çš„åº”ç”¨ï¼Œè¿™äº› POD å‰é¢ä½¿ç”¨åˆ°äº†è´Ÿè½½å‡è¡¡å™¨ã€‚<br /></p>

<p>å‡å¦‚æˆ‘ä»¬æœ‰ä¸€ä¸ª kubernetes é›†ç¾¤ï¼Œè¿™ä¸ªé›†ç¾¤é‡Œé¢æœ‰ä¸€ä¸ªæœåŠ¡å«åš mysqlï¼Œè¿™ä¸ªæœåŠ¡æ˜¯ç”±ä¸€ç»„ mysql POD ç»„æˆçš„ã€‚åœ¨è¿™ä¸ª kubernetes é›†ç¾¤ä¸­ï¼Œå…¶ä»–åº”ç”¨å¯ä»¥é€šè¿‡ DNS æ¥è®¿é—®è¿™ä¸ª mysql æœåŠ¡ã€‚</p>



<div class="box" >
  <figure  itemprop="associatedMedia" itemscope itemtype="http://schema.org/ImageObject">
    <div class="img">
      <img itemprop="thumbnail" src="https://hugo-picture.oss-cn-beijing.aliyuncs.com/images/post_loading.gif" data-original="https://hugo-picture.oss-cn-beijing.aliyuncs.com/images/aRaBGQ.jpg" alt="https://hugo-picture.oss-cn-beijing.aliyuncs.com/images/aRaBGQ.jpg"/>
    </div>
    <a href="https://hugo-picture.oss-cn-beijing.aliyuncs.com/images/aRaBGQ.jpg" itemprop="contentUrl"></a>
  </figure>
</div>


<h3 id="è·¨é›†ç¾¤è°ƒåº¦">è·¨é›†ç¾¤è°ƒåº¦</h3>

<p id="div-border-top-red">ä¸ºäº†è¿½æ±‚é«˜å¯ç”¨æ€§å’Œæ›´é«˜çš„æ€§èƒ½ï¼Œé›†ç¾¤è”é‚¦èƒ½å¤ŸæŠŠä¸åŒ POD æŒ‡å®šç»™ä¸åŒçš„ Kubernetes é›†ç¾¤ä¸­ã€‚é›†ç¾¤è”é‚¦è°ƒåº¦å™¨å°†å†³å®šå¦‚ä½•åœ¨ä¸åŒ kubernetes é›†ç¾¤ä¸­åˆ†é…å·¥ä½œè´Ÿè½½ã€‚</p>

<p>é€šè¿‡è·¨é›†ç¾¤è°ƒåº¦ï¼Œæˆ‘ä»¬å¯ä»¥ï¼š</p>

<ul>
<li>è·¨ kubernetes é›†ç¾¤å‡åŒ€çš„è°ƒåº¦ä»»åŠ¡è´Ÿè½½</li>
<li>å°†å„ä¸ª kubernetes é›†ç¾¤çš„å·¥ä½œè´Ÿè½½è¿›è¡Œæœ€å¤§åŒ–ï¼Œå¦‚æœå½“å‰ kubernetes é›†ç¾¤è¶…å‡ºäº†æ‰¿å—èƒ½åŠ›ï¼Œé‚£ä¹ˆå°†é¢å¤–çš„å·¥ä½œè´Ÿè½½è·¯ç”±åˆ°å¦ä¸€ä¸ªæ¯”è¾ƒç©ºé—²çš„ kubernetes é›†ç¾¤ä¸­</li>
<li>æ ¹æ®åº”ç”¨åœ°ç†åŒºåŸŸéœ€æ±‚ï¼Œè°ƒåº¦å·¥ä½œè´Ÿè½½åˆ°ä¸åŒçš„ kubernetes é›†ç¾¤ä¸­ï¼Œå¯¹äºä¸åŒçš„ç»ˆç«¯ç”¨æˆ·ï¼Œæä¾›æ›´é«˜çš„å¸¦å®½å’Œæ›´ä½çš„å»¶è¿Ÿã€‚</li>
</ul>

<h3 id="é›†ç¾¤é«˜å¯ç”¨-æ•…éšœè‡ªåŠ¨è¿ç§»">é›†ç¾¤é«˜å¯ç”¨ï¼Œæ•…éšœè‡ªåŠ¨è¿ç§»</h3>

<p>é›†ç¾¤è”é‚¦å¯ä»¥è·¨é›†ç¾¤å†—é¦€éƒ¨ç½²ï¼Œå½“æŸä¸ªé›†ç¾¤æ‰€åœ¨åŒºåŸŸå‡ºç°æ•…éšœæ—¶ï¼Œå¹¶ä¸å½±å“æ•´ä¸ªæœåŠ¡ã€‚é›†ç¾¤è”é‚¦è¿˜å¯ä»¥æ£€æµ‹é›†ç¾¤æ˜¯å¦ä¸ºä¸å¯ç”¨çŠ¶æ€ï¼Œå¦‚æœå‘ç°æŸä¸ªé›†ç¾¤ä¸ºä¸å¯ç”¨çŠ¶æ€æ—¶ï¼Œå¯ä»¥å°†å¤±è´¥çš„ä»»åŠ¡é‡æ–°åˆ†é…ç»™é›†ç¾¤è”é‚¦ä¸­å…¶ä»–å¯ç”¨çŠ¶æ€çš„é›†ç¾¤ä¸Šã€‚</p>

<h2 id="span-id-inline-toc-2-span-ä½¿ç”¨é›†ç¾¤è”é‚¦å®ç°å¤šé›†ç¾¤ç®¡ç†"><span id="inline-toc">2.</span> ä½¿ç”¨é›†ç¾¤è”é‚¦å®ç°å¤šé›†ç¾¤ç®¡ç†</h2>

<hr />

<h3 id="ç³»ç»Ÿç¯å¢ƒ">ç³»ç»Ÿç¯å¢ƒ</h3>

<table>
<thead>
<tr>
<th align="left">åŠŸèƒ½ç»„ä»¶</th>
<th align="center">ç³»ç»Ÿç»„ä»¶</th>
<th align="left">ç³»ç»Ÿç‰ˆæœ¬</th>
<th align="left">è®¾å¤‡æ•°é‡</th>
<th align="left">å¤‡æ³¨</th>
</tr>
</thead>

<tbody>
<tr>
<td align="left">è”é‚¦é›†ç¾¤æ§åˆ¶å¹³é¢</td>
<td align="center">k8s 1.9+Federation</td>
<td align="left">CentOS 7.3</td>
<td align="left">3å°</td>
<td align="left">è”é‚¦é›†ç¾¤æ§åˆ¶å¹³é¢</td>
</tr>

<tr>
<td align="left">K8sé›†ç¾¤01</td>
<td align="center">k8s 1.9 master+node</td>
<td align="left">CentOS 7.3</td>
<td align="left">3å°</td>
<td align="left">è”é‚¦é›†ç¾¤èŠ‚ç‚¹</td>
</tr>
</tbody>
</table>

<h3 id="å®‰è£…-kubefed">å®‰è£… kubefed</h3>

<p>é€‰æ‹©å…¶ä¸­çš„ä¸€ä¸ªé›†ç¾¤ä½œä¸ºä¸»é›†ç¾¤ï¼Œè¿™ä¸ªä¸»é›†ç¾¤å°†è¿è¡Œç»„æˆè”é‚¦æ§åˆ¶é¢æ¿çš„æ‰€æœ‰ç»„ä»¶ã€‚</p>

<p>ä½¿ç”¨ä¸‹åˆ—å‘½ä»¤ä¸‹è½½å¯¹åº”æœ€æ–°å‘è¡Œçš„ <code>kubefed</code> å®‰è£…åŒ…å¹¶å°†å®‰è£…åŒ…é‡Œçš„äºŒè¿›åˆ¶æ–‡ä»¶è§£å‹å‡ºæ¥ï¼š</p>

<pre><code class="language-bash">$ curl -LO https://storage.cloud.google.com/kubernetes-federation-release/release/${RELEASE-VERSION}/federation-client-linux-amd64.tar.gz
$ tar -xzvf federation-client-linux-amd64.tar.gz
</code></pre>

<p>è¯·ç”¨<a href="https://github.com/kubernetes/federation/releases" target="_blank">federation release page</a>é¡µé¢å®é™…çš„ç‰ˆæœ¬å·æ›¿æ¢å˜é‡ <code>RELEASE-VERSION</code>ã€‚</p>

<p>å°†è§£å‹å‡ºæ¥çš„å†…å®¹å¤åˆ¶åˆ°ä½ çš„ç¯å¢ƒå˜é‡ <code>$PATH</code> é‡Œçš„éšä¾¿ä¸€ä¸ªè·¯å¾„ï¼Œ å¹¶è®¾ç½®å¯æ‰§è¡Œæƒé™ã€‚</p>

<pre><code class="language-bash">$ cp federation/client/bin/kubefed /usr/local/bin
$ chmod +x /usr/local/bin/kubefed
</code></pre>

<h3 id="é…ç½®-context">é…ç½® context</h3>

<p>åœ¨å‡†å¤‡é…ç½®è”é‚¦é›†ç¾¤çš„ DCE é›†ç¾¤ä¸­é…ç½®ä¸¤ä¸ª DCE é›†ç¾¤çš„ <code>context</code>ã€‚è®©æ”¹èŠ‚ç‚¹èƒ½é€šè¿‡åˆ‡æ¢ <code>context</code> è¿æ¥ä¸åŒçš„å­é›†ç¾¤ã€‚</p>

<p>å…ˆåˆ›å»ºæœ¬åœ°é›†ç¾¤çš„ <code>kubeconfig</code> æ–‡ä»¶</p>

<pre><code class="language-bash">$ export KUBE_APISERVER=&quot;https://192.168.123.250:6443&quot;
# è®¾ç½®é›†ç¾¤å‚æ•°
$ kubectl config set-cluster kubernetes \
  --certificate-authority=/etc/kubernetes/ssl/ca.pem \
  --embed-certs=true \
  --server=${KUBE_APISERVER}
# è®¾ç½®å®¢æˆ·ç«¯è®¤è¯å‚æ•°
$ kubectl config set-credentials admin \
  --client-certificate=/etc/kubernetes/ssl/admin.pem \
  --embed-certs=true \
  --client-key=/etc/kubernetes/ssl/admin-key.pem
# è®¾ç½®ä¸Šä¸‹æ–‡å‚æ•°
$ kubectl config set-context kubernetes \
  --cluster=kubernetes \
  --user=admin
# è®¾ç½®é»˜è®¤ä¸Šä¸‹æ–‡
$ kubectl config use-context kubernetes
</code></pre>

<p>ç”Ÿæˆçš„ kubeconfig è¢«ä¿å­˜åˆ° <code>~/.kube/config</code> æ–‡ä»¶ã€‚</p>

<style type="text/css">.notice{padding:18px;line-height:24px;margin-bottom:24px;margin-top:30px;border-radius:4px;color:#444;background:#e7f2fa}.notice p:last-child{margin-bottom:0}.notice-title{margin:-18px -18px 12px;padding:4px 18px;border-radius:4px 4px 0 0;font-weight:700;color:#fff;background:#6ab0de}.notice-title:before{margin-right:8px;font-family:"Font Awesome 5 Free",FontAwesome;font-weight:600}.notice.warning .notice-title{background:rgba(217,83,79,.9)}.notice.warning .notice-title:before{content:'\f071'}.notice.warning{background:#fae2e2}.notice.info .notice-title{background:#f0b37e}.notice.info .notice-title:before{content:'\f05a'}.notice.info{background:#fff2db}.notice.note .notice-title{background:#6ab0de}.notice.note .notice-title:before{content:'\f06a'}.notice.note{background:#e7f2fA}.notice.tip .notice-title{background:rgba(92,184,92,.8)}.notice.tip .notice-title:before{content:'\f058'}.notice.tip{background:#e6f9e6}</style><div class="notice note" >
<p class="first notice-title">æ³¨æ„</p><p>~/.kube/config æ–‡ä»¶æ‹¥æœ‰å¯¹è¯¥é›†ç¾¤çš„æœ€é«˜æƒé™ï¼Œè¯·å¦¥å–„ä¿ç®¡ã€‚</p></div>


<p>é…ç½®ç»“æœå¦‚ä¸‹ï¼š</p>

<pre><code class="language-bash">$ kubectl config get-contexts

CURRENT   NAME          CLUSTER       AUTHINFO      NAMESPACE
*         kubernetes    kubernetes    admin
</code></pre>

<h3 id="è®¾ç½®-coredns-ä½œä¸ºé›†ç¾¤è”é‚¦çš„-dns-æä¾›å•†">è®¾ç½® CoreDNS ä½œä¸ºé›†ç¾¤è”é‚¦çš„ DNS æä¾›å•†</h3>

<h4 id="å‰æ">å‰æ</h4>

<ul>
<li>ä¸ºå¯ç”¨ <code>CoreDNS</code> æ¥å®ç°è·¨è”é‚¦é›†ç¾¤çš„æœåŠ¡å‘ç°ï¼Œè”é‚¦çš„æˆå‘˜é›†ç¾¤ä¸­å¿…é¡»æ”¯æŒ <code>LoadBalancer</code> æœåŠ¡ã€‚ï¼ˆ<font color="red">æœ¬åœ°é›†ç¾¤é»˜è®¤ä¸æ”¯æŒ <code>LoadBalancer</code> æœåŠ¡ï¼Œæ‰€ä»¥è¦è®©æœ¬åœ°é›†ç¾¤æ”¯æŒ <code>LoadBalancer</code> æœåŠ¡æ‰èƒ½ä½¿ç”¨ <code>coredns</code> æ¥å®ç° federation çš„æœåŠ¡å‘ç°åŠŸèƒ½ï¼ï¼ï¼</font>ï¼‰</li>
<li>æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ <code>helm charts</code> æ¥éƒ¨ç½² CoreDNSã€‚ CoreDNS éƒ¨ç½²æ—¶ä¼šä»¥ etcd ä½œä¸ºåç«¯ï¼Œå¹¶ä¸” etcd åº”é¢„å…ˆå®‰è£…ã€‚ etcd ä¹Ÿå¯ä»¥åˆ©ç”¨ helm charts è¿›è¡Œéƒ¨ç½²ã€‚</li>
<li>æ‰€æœ‰åŠ å…¥ federation çš„é›†ç¾¤çš„ node å¿…é¡»æ‰“ä¸Šä»¥ä¸‹çš„æ ‡ç­¾ï¼š<br />
<code>failure-domain.beta.kubernetes.io/region=&lt;region&gt;</code><br />
<code>failure-domain.beta.kubernetes.io/zone=&lt;zone&gt;</code></li>
</ul>

<h4 id="ä½¿æœ¬åœ°é›†ç¾¤æ”¯æŒ-loadbalancer-æœåŠ¡">ä½¿æœ¬åœ°é›†ç¾¤æ”¯æŒ LoadBalancer æœåŠ¡</h4>

<p>ä¸ºäº†ä½¿æœ¬åœ°é›†ç¾¤æ”¯æŒ <code>LoadBalancer</code> æœåŠ¡ï¼Œå¯ä»¥å‚è€ƒä»¥ä¸‹ä¸¤ç§å®ç°æ–¹æ¡ˆï¼š</p>

<ul>
<li><a href="https://github.com/munnerz/keepalived-cloud-provider" target="_blank">keepalived-cloud-provider</a></li>
<li><a href="https://github.com/google/metallb" target="_blank">metalLB</a></li>
</ul>

<p>è¿™é‡Œæˆ‘ä»¬é€‰æ‹©ä½¿ç”¨ <code>metalLB</code>ã€‚</p>

<p>metalLB çš„éƒ¨ç½²å¾ˆç®€å•ï¼Œç›´æ¥ä½¿ç”¨ yaml æ–‡ä»¶éƒ¨ç½²ï¼š</p>

<pre><code class="language-bash">$ kubectl apply -f https://raw.githubusercontent.com/google/metallb/v0.5.0/manifests/metallb.yaml
</code></pre>

<p>å…·ä½“å‚è€ƒ <a href="https://metallb.universe.tf/installation/" target="_blank">https://metallb.universe.tf/installation/</a></p>

<p>éƒ¨ç½²å®Œæˆåéœ€è¦ä¸º LoadBalancer æœåŠ¡é€‰æ‹©ä¸€ä¸ªç‰¹å®šçš„ IP åœ°å€æ± ï¼Œè¿™é‡Œé€šè¿‡ configmap æ¥åˆ›å»ºã€‚</p>

<p>ä¸‹é¢æ˜¯ä¸€ä¸ªç®€å•ç¤ºä¾‹ï¼š</p>

<pre><code class="language-bash">$ cat metallb-cm.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  namespace: metallb-system
  name: config
data:
  config: |
    address-pools:
    - name: default
      protocol: layer2
      addresses:
      - 192.168.1.58-192.168.1.60

$ kubectl create -f metallb-cm.yaml
</code></pre>

<p>æ›´å¤šé«˜çº§é…ç½®è¯·å‚è€ƒï¼š<a href="https://metallb.universe.tf/configuration/" target="_blank">https://metallb.universe.tf/configuration/</a></p>

<p>ç°åœ¨æœ¬åœ°é›†ç¾¤å·²ç»æ”¯æŒ LoadBalancer æœåŠ¡äº†ï¼Œä¸‹é¢æˆ‘ä»¬å¼€å§‹ federation çš„æ—…ç¨‹å§ï¼ğŸ‘</p>

<h4 id="å®‰è£…-helm">å®‰è£… helm</h4>

<p>é¦–å…ˆéœ€è¦å®‰è£… <code>helm</code> å®¢æˆ·ç«¯</p>

<pre><code class="language-bash">$ curl https://raw.githubusercontent.com/kubernetes/helm/master/scripts/get &gt; get_helm.sh
$ chmod 700 get_helm.sh
$ ./get_helm.sh
</code></pre>

<p>åˆ›å»º tiller çš„ <code>serviceaccount</code> å’Œ <code>clusterrolebinding</code></p>

<pre><code class="language-bash">$ kubectl create serviceaccount --namespace kube-system tiller
$ kubectl create clusterrolebinding tiller-cluster-rule --clusterrole=cluster-admin --serviceaccount=kube-system:tiller
</code></pre>

<p>ç„¶åå®‰è£… helm æœåŠ¡ç«¯ <code>tiller</code></p>

<pre><code class="language-bash">$ helm init
</code></pre>

<p>ä¸ºåº”ç”¨ç¨‹åºè®¾ç½® <code>serviceAccount</code>ï¼š</p>

<pre><code class="language-bash">$ kubectl patch deploy --namespace kube-system tiller-deploy -p '{&quot;spec&quot;:{&quot;template&quot;:{&quot;spec&quot;:{&quot;serviceAccount&quot;:&quot;tiller&quot;}}}}'
</code></pre>

<p>æ£€æŸ¥æ˜¯å¦å®‰è£…æˆåŠŸï¼š</p>

<pre><code class="language-bash">$ kubectl -n kube-system get pods|grep tiller

tiller-deploy-7bf964fff8-sklts                1/1       Running   0          7h

$ helm version

Client: &amp;version.Version{SemVer:&quot;v2.8.2&quot;, GitCommit:&quot;a80231648a1473929271764b920a8e346f6de844&quot;, GitTreeState:&quot;clean&quot;}
Server: &amp;version.Version{SemVer:&quot;v2.8.2&quot;, GitCommit:&quot;a80231648a1473929271764b920a8e346f6de844&quot;, GitTreeState:&quot;clean&quot;}
</code></pre>

<h4 id="éƒ¨ç½²-etcd">éƒ¨ç½² etcd</h4>

<p>ä¸‹è½½ <code>helm charts</code> ä»“åº“</p>

<pre><code class="language-bash">$ git clone https://github.com/kubernetes/charts.git
</code></pre>

<p>éƒ¨ç½² <code>etcd-operator</code>ï¼ˆetcd-operator ä¼šé€šè¿‡ kubernetes çš„ <code>CustomResourceDefinition</code> è‡ªåŠ¨åˆ›å»º <code>etcd cluster</code>ï¼‰</p>

<pre><code class="language-bash">$ cd charts

$ helm install --name etcd-operator stable/etcd-operator --set rbac.install=true,rbac.apiVersion=v1,customResources.createEtcdClusterCRD=true
</code></pre>

<p>æ£€æŸ¥æ˜¯å¦éƒ¨ç½²æˆåŠŸ</p>

<pre><code class="language-bash">$ kubectl get pods

NAME                                                              READY     STATUS    RESTARTS   AGE
etcd-cluster-6skfqj9mwp                                           1/1       Running   0          7m
etcd-cluster-6w8ntzvkwm                                           1/1       Running   0          8m
etcd-cluster-mclzhqrldf                                           1/1       Running   0          7m
etcd-operator-etcd-operator-etcd-backup-operator-5df985959bvvkw   1/1       Running   0          9m
etcd-operator-etcd-operator-etcd-operator-58d98b95c-x44bz         1/1       Running   0          9m
etcd-operator-etcd-operator-etcd-restore-operator-8688c7684nmdh   1/1       Running   0          9m

$ kubectl get crd

NAME                                    AGE
etcdbackups.etcd.database.coreos.com    1d
etcdclusters.etcd.database.coreos.com   1d
etcdrestores.etcd.database.coreos.com   1d

$ kubectl get crd etcdclusters.etcd.database.coreos.com -o yaml

apiVersion: apiextensions.k8s.io/v1beta1
kind: CustomResourceDefinition
metadata:
...
...
spec:
  group: etcd.database.coreos.com
  names:
    kind: EtcdCluster
    listKind: EtcdClusterList
    plural: etcdclusters
    shortNames:
    - etcd
    singular: etcdcluster
  scope: Namespaced
  version: v1beta2
...
...

$ kubectl get EtcdCluster

NAME           AGE
etcd-cluster   11m

$ kubectl get svc

NAME                    TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)             AGE
etcd-cluster            ClusterIP   None             &lt;none&gt;        2379/TCP,2380/TCP   17m
etcd-cluster-client     ClusterIP   10.254.140.7     &lt;none&gt;        2379/TCP            17m
etcd-restore-operator   ClusterIP   10.254.177.113   &lt;none&gt;        19999/TCP           18m
kubernetes              ClusterIP   10.254.0.1       &lt;none&gt;        443/TCP             16d
</code></pre>

<p>éƒ¨ç½²æˆåŠŸåï¼Œå¯ä»¥åœ¨ host é›†ç¾¤å†…é€šè¿‡ <a href="http://etcd-cluster-client.default:2379" target="_blank">http://etcd-cluster-client.default:2379</a> ç«¯ç‚¹è®¿é—® etcdã€‚</p>

<h4 id="éƒ¨ç½²-coredns">éƒ¨ç½² CoreDNS</h4>

<p>é¦–å…ˆéœ€è¦å®šåˆ¶ <code>CoreDNS chart</code> æ¨¡æ¿çš„é»˜è®¤é…ç½®ï¼Œå®ƒä¼šè¦†ç›– <code>CoreDNS chart</code> çš„é»˜è®¤é…ç½®å‚æ•°ã€‚</p>

<pre><code class="language-bash">$ cat Value.yaml

isClusterService: false
serviceType: &quot;NodePort&quot;
plugins:
  kubernetes:
    enabled: false
  etcd:
    enabled: true
    zones:
    - &quot;example.com.&quot;
    endpoint: &quot;http://etcd-cluster-client.default:2379&quot;
</code></pre>

<p>å‚æ•°è¯´æ˜ï¼š</p>

<ul>
<li><code>isClusterService</code>: æŒ‡å®š CoreDNS æ˜¯å¦ä»¥é›†ç¾¤æœåŠ¡çš„å½¢å¼éƒ¨ç½²ï¼ˆé»˜è®¤ä¸ºæ˜¯ï¼‰ã€‚ éœ€è¦å°†å…¶è®¾ç½®ä¸º â€œfalseâ€ï¼Œä»¥ä½¿ CoreDNS ä»¥ Kubernetes åº”ç”¨æœåŠ¡çš„å½¢å¼éƒ¨ç½²ï¼Œå¦åˆ™ä¼šä¸é›†ç¾¤çš„ dns æœåŠ¡ kubedns å†²çªã€‚</li>
<li><code>serviceType</code>: æŒ‡å®šä¸º CoreDNS åˆ›å»ºçš„ Kubernetes æœåŠ¡ç±»å‹ã€‚ é€‰æ‹© â€œNodePortâ€ï¼Œä»¥ä½¿å¾— CoreDNS æœåŠ¡èƒ½å¤Ÿä» Kubernetes é›†ç¾¤å¤–éƒ¨è®¿é—®ã€‚</li>
<li><code>plugins.kubernetes</code>: é»˜è®¤æ˜¯å¯ç”¨çš„ï¼Œé€šè¿‡å°† <code>plugins.kubernetes.enabled</code> è®¾ç½®ä¸º â€œfalseâ€ æ¥ç¦ç”¨ plugins.kubernetesã€‚</li>
<li>é€šè¿‡å°† plugins.etcd.enabled è®¾ç½®ä¸º â€œtrueâ€ æ¥å¯ç”¨ plugins.etcdã€‚</li>
<li>é€šè¿‡è®¾ç½® <code>plugins.etcd.zones</code> æ¥é…ç½® CoreDNS è¢«æˆæƒçš„ DNS åŒºåŸŸï¼ˆè”é‚¦åŒºåŸŸï¼‰ã€‚</li>
<li>é€šè¿‡è®¾ç½® <code>plugins.etcd.endpoint</code> æ¥è®¾ç½®å…ˆå‰éƒ¨ç½²çš„ etcd çš„ç«¯ç‚¹ã€‚</li>
</ul>

<p>ç°åœ¨è¿è¡Œä»¥ä¸‹å‘½ä»¤æ¥éƒ¨ç½² CoreDNSï¼š</p>

<pre><code class="language-bash">$ helm install --name coredns -f Values.yaml stable/coredns
</code></pre>

<p>éªŒè¯éƒ¨ç½²ï¼š</p>

<pre><code class="language-bash">$ kubectl get pods -l app=coredns-coredns

NAME                               READY     STATUS    RESTARTS   AGE
coredns-coredns-57b54ddb97-xffnc   1/1       Running   0          1d

$ kubectl get svc -l app=coredns-coredns

NAME              TYPE       CLUSTER-IP       EXTERNAL-IP   PORT(S)                                    AGE
coredns-coredns   NodePort   10.254.198.211   &lt;none&gt;        53:27165/UDP,53:27165/TCP,9153:26492/TCP   1d
</code></pre>

<h4 id="ä½¿ç”¨-coredns-ä½œä¸º-dns-æä¾›å•†æ¥éƒ¨ç½²-federation">ä½¿ç”¨ CoreDNS ä½œä¸º DNS æä¾›å•†æ¥éƒ¨ç½² Federation</h4>

<p>å¯ä»¥ä½¿ç”¨ <code>kubefed init</code> æ¥éƒ¨ç½²è”é‚¦æ§åˆ¶å¹³é¢ã€‚ å¯ä»¥é€šè¿‡æŒ‡å®šä¸¤ä¸ªé™„åŠ å‚æ•°æ¥é€‰æ‹© CoreDNS ä½œä¸º DNS æä¾›å•†ã€‚</p>

<pre><code class="language-bash">--dns-provider=coredns
--dns-provider-config=coredns-provider.conf
</code></pre>

<p>coredns-provider.conf å†…å®¹å¦‚ä¸‹ï¼š</p>

<pre><code class="language-bash">[Global]
etcd-endpoints = http://etcd-cluster-client.default:2379
zones = example.com.
coredns-endpoints = &lt;coredns-server-ip&gt;:&lt;port&gt;
</code></pre>

<ul>
<li><code>etcd-endpoints</code> æ˜¯è®¿é—® etcd çš„ç«¯ç‚¹ã€‚</li>
<li><code>zones</code> æ˜¯ CoreDNS è¢«æˆæƒçš„è”é‚¦åŒºåŸŸï¼Œå…¶å€¼ä¸ <code>kubefed init</code> çš„ â€“-dns-zone-name å‚æ•°ç›¸åŒã€‚</li>
<li><code>coredns-endpoints</code> æ˜¯è®¿é—® CoreDNS æœåŠ¡å™¨çš„ç«¯ç‚¹ã€‚ è¿™æ˜¯ä¸€ä¸ª 1.7 ç‰ˆæœ¬å¼€å§‹å¼•å…¥çš„å¯é€‰å‚æ•°ã€‚</li>
</ul>

<div class="notice note" >
<p class="first notice-title">æ³¨æ„</p><p>CoreDNS é…ç½®ä¸­çš„ <code>plugins.etcd.zones</code> ä¸ kubefed init çš„ <code>--dns-zone-name</code> å‚æ•°åº”åŒ¹é…ã€‚</p></div>


<p>ç»™æ‰€æœ‰ node æ‰“ä¸Š <code>region</code> å’Œ <code>zone</code> çš„æ ‡ç­¾ï¼š</p>

<pre><code class="language-bash">$ kubectl label nodes 192.168.123.248 failure-domain.beta.kubernetes.io/zone=shanghai failure-domain.beta.kubernetes.io/region=yangpu

$ kubectl label nodes 192.168.123.249 failure-domain.beta.kubernetes.io/zone=shanghai failure-domain.beta.kubernetes.io/region=yangpu

$ kubectl label nodes 192.168.123.250 failure-domain.beta.kubernetes.io/zone=shanghai failure-domain.beta.kubernetes.io/region=yangpu
</code></pre>

<p>é€šè¿‡æœ¬æ¡å‘½ä»¤åˆå§‹åŒ– federation æ§åˆ¶å¹³é¢ï¼Œå‚æ•°å¦‚ä¸‹ï¼š</p>

<pre><code class="language-bash">$ kubefed init federation \ # è”é‚¦çš„åå­—
  --host-cluster-context=kubernetes \ # ä¸»é›†ç¾¤çš„contextåå­—
  --dns-provider=coredns \ # DNSæœåŠ¡æä¾›å•†
  --dns-zone-name=&quot;example.com.&quot; \ # å‰é¢æ³¨å†Œå¥½çš„åŸŸåï¼Œå¿…é¡»ä»¥.ç»“æŸ
  --dns-provider-config=&quot;coredns-provider.conf&quot; \ # coredns é…ç½®æ–‡ä»¶
  --api-server-service-type=&quot;NodePort&quot; \
  --api-server-advertise-address=&quot;192.168.123.250&quot;

  Creating a namespace federation-system for federation system components... done
  Creating federation control plane service..... done
  Creating federation control plane objects (credentials, persistent volume claim)... done
  Creating federation component deployments... done
  Updating kubeconfig... done
  Waiting for federation control plane to come up..................................................................................................................................................... done
  Federation API server is running at: 10.110.151.216
</code></pre>

<p>è§‚å¯Ÿä»¥ä¸Šè¾“å‡ºä¿¡æ¯ï¼Œè¯¥å‘½ä»¤åšäº†ä»¥ä¸‹å‡ ä»¶äº‹æƒ…ï¼š</p>

<ol>
<li><p>åˆ›å»ºä¸€ä¸ª namespace <code>federation-system</code></p>

<pre><code class="language-bash">$ kubectl get ns

NAME                STATUS    AGE
default             Active    8d
federation-system   Active    8s
kube-public         Active    8d
kube-system         Active    8d
my-namespace        Active    7d
</code></pre></li>

<li><p>åˆ›å»ºä¸¤ä¸ªæœåŠ¡ <code>federation-apiserver</code> å’Œ <code>federation-controller-manager</code></p>

<pre><code class="language-bash">$ kubectl -n federation-system get pods

NAME                                             READY     STATUS         RESTARTS   AGE
federation-apiserver-909415585-wktmw             1/1       Running   0          2s
federation-controller-manager-4247980660-c8ls5   1/1       Running   1          3s
</code></pre></li>

<li><p>åˆ›å»ºä¸€ä¸ª ServiceAccount <code>federation-controller-manager</code></p>

<pre><code class="language-bash">$ kubectl -n federation-system get sa

NAME                            SECRETS   AGE
default                         1         31m
federation-controller-manager   1         31m
</code></pre></li>

<li><p>åˆ›å»ºä¸€ä¸ª Role <code>federation-system:federation-controller-manager</code></p>

<pre><code class="language-bash">$ kubectl -n federation-system get role

NAME                                              AGE
federation-system:federation-controller-manager   38m
</code></pre></li>

<li><p>åˆ›å»ºä¸€ä¸ª RoleBinding <code>federation-system:federation-controller-manager</code></p>

<pre><code class="language-bash">$ kubectl -n federation-system get rolebinding

NAME                                              AGE
federation-system:federation-controller-manager   39m
</code></pre></li>

<li><p>åˆ›å»ºä¸€ä¸ª context <code>federation</code></p>

<pre><code class="language-bash">$ kubectl config get-contexts

CURRENT   NAME         CLUSTER      AUTHINFO     NAMESPACE
          federation   federation   federation
*         kubernetes   kubernetes   admin
</code></pre></li>
</ol>

<div class="notice note" >
<p class="first notice-title">æ³¨æ„</p><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œ<code>kubefed init</code> é€šè¿‡åŠ¨æ€åˆ›å»º PV çš„æ–¹å¼ä¸º etcd åˆ›å»ºæŒä¹…åŒ–å­˜å‚¨ã€‚å¦‚æœ kubernetes é›†ç¾¤ä¸æ”¯æŒåŠ¨æ€åˆ›å»º PVï¼Œåˆ™å¯ä»¥é¢„å…ˆåˆ›å»º PVï¼Œæ³¨æ„ PV è¦åŒ¹é… <code>kubefed</code> çš„ PVCã€‚æˆ–è€…ä½¿ç”¨ <code>hostpath</code>ï¼ŒåŒæ—¶æŒ‡å®šè°ƒåº¦èŠ‚ç‚¹ã€‚</p></div>


<h4 id="æ·»åŠ é›†ç¾¤è‡³-federation">æ·»åŠ é›†ç¾¤è‡³ federation</h4>

<p>ç›®å‰ä¸ºæ­¢æ‚¨å·²ç»æˆåŠŸçš„åˆå§‹åŒ–å¥½äº† <code>Federation</code> çš„æ§åˆ¶å¹³é¢ã€‚æ¥ä¸‹æ¥éœ€è¦å°†å„ä¸ªå­é›†ç¾¤åŠ å…¥åˆ° Federation é›†ç¾¤ä¸­ã€‚</p>

<p>æ·»åŠ é›†ç¾¤ <code>kubernetes</code>ï¼š</p>

<pre><code class="language-bash">$ kubefed join kubernetes \ #åŠ å…¥è”é‚¦çš„é›†ç¾¤å‘½ååå­—
  --context=federation \ #è”é‚¦çš„context
  --cluster-context=kubernetes \ #è¦æ·»åŠ é›†ç¾¤çš„context
  --host-cluster-context=kubernetes #ä¸»é›†ç¾¤çš„context

$ kubectl --context=federation get cluster

NAME          STATUS    AGE
kubernetes    Ready     6d
</code></pre>

<p>é€šè¿‡æˆ‘çš„è§‚å¯Ÿï¼Œä»¥ä¸Šè¿‡ç¨‹åœ¨ <code>åŠ å…¥ federation çš„ kubernetes é›†ç¾¤ä¸­</code> åšäº†ä»¥ä¸‹å‡ ä»¶äº‹æƒ…ï¼š</p>

<ol>
<li><p>åœ¨ namespace <code>federation-system</code> ä¸­åˆ›å»ºä¸€ä¸ª ServiceAccount <code>kubernetes-kubernetes</code></p>

<pre><code class="language-bash">$ kubectl -n federation-system get sa

NAME                            SECRETS   AGE
default                         1         45m
federation-controller-manager   1         45m
kubernetes-kubernetes           1         8m
</code></pre></li>

<li><p>åˆ›å»ºä¸€ä¸ª ClusterRole <code>federation-controller-manager:federation-kubernetes-kubernetes</code></p>

<pre><code class="language-bash">$ kubectl get clusterrole|egrep &quot;NAME|federation&quot;

NAME                                                                   AGE
federation-controller-manager:federation-kubernetes-kubernetes         10m
</code></pre></li>

<li><p>åˆ›å»ºä¸€ä¸ª ClusterRoleBinding <code>federation-controller-manager:federation-kubernetes-kubernetes</code></p>

<pre><code class="language-bash">$ kubectl get clusterrolebinding|egrep &quot;NAME|federation&quot;

NAME                                                             AGE
federation-controller-manager:federation-kubernetes-kubernetes   11m
</code></pre></li>
</ol>

<p>æ•´ä¸ªè¿‡ç¨‹æ˜¯å¦è¿˜è¿›è¡Œäº†å…¶ä»–æ“ä½œï¼Œæš‚æ—¶æ²¡æœ‰å‘ç°ï¼Œæœ‰å¾…ç»§ç»­ç ”ç©¶ã€‚</p>

<p><strong>ä»‹ç»ä¸‹é›†ç¾¤æŸ¥è¯¢ï¼Œç§»é™¤é›†ç¾¤ï¼Œåˆ é™¤è”é‚¦ç­‰å‘½ä»¤ï¼š</strong></p>

<p>æŸ¥è¯¢æ³¨å†Œåˆ° Federation çš„ kubernetes é›†ç¾¤åˆ—è¡¨</p>

<pre><code class="language-bash">$ kubectl --context=federation get clusters

NAME          STATUS    AGE
kubernetes    Ready     8m
</code></pre>

<p>ç§»é™¤ <code>kubernetes</code> é›†ç¾¤</p>

<pre><code class="language-bash">$ kubefed unjoin kubernetes --host-cluster-context=kubernetes --context=federation

Successfully removed cluster &quot;kubernetes&quot; from federation

$ kubectl --context=federation get clusters

No resources found.
</code></pre>

<p>é›†ç¾¤è”é‚¦æ§åˆ¶å¹³é¢çš„åˆ é™¤åŠŸèƒ½è¿˜åœ¨å¼€å‘ä¸­ï¼Œç›®å‰å¯ä»¥é€šè¿‡åˆ é™¤ namespace <code>federation-system</code> çš„æ–¹æ³•æ¥æ¸…ç†ï¼ˆæ³¨æ„pvä¸ä¼šåˆ é™¤ï¼‰ã€‚å‘½ä»¤åœ¨ host-cluster-context ä¸Šæ‰§è¡Œã€‚</p>

<pre><code class="language-bash">$ kubectl delete ns federation-system
</code></pre>

<h2 id="span-id-inline-toc-3-span-federation-æ”¯æŒçš„æœåŠ¡"><span id="inline-toc">3.</span> Federation æ”¯æŒçš„æœåŠ¡</h2>

<hr />

<p>é›†ç¾¤è”é‚¦æ”¯æŒä»¥ä¸‹è”é‚¦èµ„æºï¼Œè¿™äº›èµ„æºä¼šè‡ªåŠ¨åœ¨æ‰€æœ‰æ³¨å†Œçš„ <code>kubernetes</code> é›†ç¾¤ä¸­åˆ›å»ºã€‚</p>

<ul>
<li>Federated ConfigMap</li>
<li>Federated Service</li>
<li>Federated DaemonSet</li>
<li>Federated Deployment</li>
<li>Federated Ingress</li>
<li>Federated Namespaces</li>
<li>Federated ReplicaSets</li>
<li>Federated Secrets</li>
<li>Federated Eventsï¼ˆä»…å­˜åœ¨federationæ§åˆ¶å¹³é¢ï¼‰</li>
<li>Federated Jobsï¼ˆv1.8+ï¼‰</li>
<li>Federated Horizontal Pod Autoscaling (HPAï¼Œv1.8+)</li>
</ul>

<p>ç¤ºä¾‹ï¼š</p>

<p><strong>åˆ›å»º <code>deployment</code></strong></p>

<pre><code class="language-bash">$ cat nginx-deployment.yaml

apiVersion: extensions/v1beta1
kind: Deployment
metadata:
  name: nginx-deployment
spec:
  replicas: 2
  template:
    metadata:
      labels:
        app: nginx
    spec:
      containers:
      - name: nginx
        image: nginx:alpine
        ports:
        - containerPort: 80

$ kubectl --context=federation create ns default
$ kubectl --context=federation create -f nginx-deployment.yaml
</code></pre>

<p>å¯ä»¥é€šè¿‡ <code>kubectl scale deploy nginx --replicas=3 --context=federation</code> æ¥æ‰©å±• nginx å‰¯æœ¬ï¼Œç„¶åè§‚å¯Ÿ nginx åº”ç”¨åœ¨å„ä¸ªå­é›†ç¾¤ä¸­çš„åˆ†å¸ƒæƒ…å†µã€‚</p>

<pre><code class="language-bash">$ kubectl --context=kubernetes get deploy
</code></pre>

<p><strong>é€šè¿‡ Federated Service æ¥å®ç°è·¨é›†ç¾¤æœåŠ¡å‘ç°</strong></p>

<pre><code class="language-bash">$ cat nginx-svc.yaml

apiVersion: v1
kind: Service
metadata:
  name: nginx
  labels:
    app: nginx
spec:
  type: LoadBalancer
  ports:
  - port: 80
    targetPort: 80
    protocol: TCP
    name: http
  selector:
    app: nginx

# è¿™ä¼šåœ¨æ‰€æœ‰æ³¨å†Œåˆ°è”é‚¦çš„ kubernetes é›†ç¾¤ä¸­åˆ›å»ºæœåŠ¡
$ kubectl --context=federation create -f nginx-svc.yaml

# æŸ¥çœ‹æœåŠ¡çŠ¶æ€
$ kubectl --context=federation describe services nginx

Name:                     nginx
Namespace:                default
Labels:                   app=nginx
Annotations:              federation.kubernetes.io/service-ingresses={&quot;items&quot;:[{&quot;cluster&quot;:&quot;kubernetes&quot;,&quot;items&quot;:[{&quot;ip&quot;:&quot;192.168.1.58&quot;}]}]}
Selector:                 app=nginx
Type:                     LoadBalancer
IP:
LoadBalancer Ingress:     192.168.1.58
Port:                     http  80/TCP
TargetPort:               80/TCP
Endpoints:                &lt;none&gt;
Session Affinity:         None
External Traffic Policy:  Cluster
Events:                   &lt;none&gt;
</code></pre>

<p>å¯ä»¥é€šè¿‡ DNS æ¥è®¿é—®è”é‚¦æœåŠ¡ï¼Œè®¿é—®æ ¼å¼åŒ…æ‹¬ä»¥ä¸‹å‡ ç§ï¼š</p>

<ul>
<li><code>&lt;service name&gt;.&lt;namespace&gt;.&lt;federation&gt;</code></li>
<li><code>&lt;service name&gt;.&lt;namespace&gt;.&lt;federation&gt;.svc.&lt;domain&gt;</code></li>
<li><code>&lt;service name&gt;.&lt;namespace&gt;.&lt;federation&gt;.svc.&lt;region&gt;.&lt;domain&gt;</code></li>
<li><code>&lt;service name&gt;.&lt;namespace&gt;.&lt;federation&gt;.svc.&lt;zone&gt;.&lt;region&gt;.&lt;domain&gt;</code></li>
</ul>

<p>æœ¬ä¾‹ä¸­å¯ä»¥é€šè¿‡ä»¥ä¸‹å‡ ä¸ªåŸŸåæ¥è®¿é—®ï¼š</p>

<ul>
<li><code>nginx.default.federation</code></li>
<li><code>nginx.default.federation.svc.example.com</code></li>
<li><code>nginx.default.federation.svc.shanghai.example.com</code></li>
<li><code>nginx.default.federation.svc.shanghai.yangpu.example.com</code></li>
</ul>

<p>DNS åœ¨ etcd ä¸‹çš„å­˜å‚¨è·¯å¾„ä¸ºï¼š<code>/skydns</code></p>

<pre><code class="language-bash">$ kubectl exec etcd-cluster-fznzsrttt9 etcdctl ls /skydns/com/example/

/skydns/com/example/kubernetes
/skydns/com/example/svc
/skydns/com/example/yangpu

$ kubectl exec etcd-cluster-fznzsrttt9 etcdctl ls /skydns/com/example/yangpu/

/skydns/com/example/yangpu/shanghai
/skydns/com/example/yangpu/svc
</code></pre>

<h2 id="span-id-inline-toc-4-span-å‚è€ƒæ–‡æ¡£"><span id="inline-toc">4.</span> å‚è€ƒæ–‡æ¡£</h2>

<hr />

<ul>
<li><a href="https://kubernetes.io/docs/concepts/cluster-administration/federation/" target="_blank">Kubernetes federation</a></li>
<li><a href="https://kubernetes.io/docs/tasks/federation/set-up-coredns-provider-federation/" target="_blank">Set up CoreDNS as DNS provider for Cluster Federation</a></li>
</ul>

         
	 
	 <br />
	 <div style="text-align:center;color: #ccc;font-size:16px;font-family: cursive;">-------ä»–æ—¥æ±Ÿæ¹–ç›¸é€¢ <i class="fa fa-umbrella" style="color:#986dbd"></i> å†å½“æ¯é…’è¨€æ¬¢-------</div>
         
           

<div class="entry-shang text-center">
	<p>ã€ŒçœŸè¯šèµèµï¼Œæ‰‹ç•™ä½™é¦™ã€</p>
        <button class="zs show-zs btn rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}"> <span>èµ</span> </button>
</div>
<div class="zs-modal-bg"></div>
<div class="zs-modal-box">
	<div class="zs-modal-head">
		<button type="button" class="close">Ã—</button>
		<span class="author"><img src="https://hugo-picture.oss-cn-beijing.aliyuncs.com/blog/2019-08-26-WechatIMG12268.jpeg"/>ç±³å¼€æœ—åŸºæ¨</span>
		<p class="tip"><i></i><span>çœŸè¯šèµèµï¼Œæ‰‹ç•™ä½™é¦™</span></p>
 	</div>
	<div class="zs-modal-body">
		<div class="zs-modal-btns">
			<button class="btn btn-blink" data-num="2">2å…ƒ</button>
			<button class="btn btn-blink" data-num="5">5å…ƒ</button>
			<button class="btn btn-blink" data-num="10">10å…ƒ</button>
			<button class="btn btn-blink" data-num="50">50å…ƒ</button>
			<button class="btn btn-blink" data-num="100">100å…ƒ</button>
			<button class="btn btn-blink" data-num="1">ä»»æ„é‡‘é¢</button>
		</div>
		<div class="zs-modal-pay">
			<button class="btn btn-bred" id="pay-text">2å…ƒ</button>
			<p>ä½¿ç”¨<span id="pay-type">å¾®ä¿¡</span>æ‰«æäºŒç»´ç å®Œæˆæ”¯ä»˜</p>
			<img src="/img/wechat-2.png" id="pay-image"/>
		</div>
	</div>
	<div class="zs-modal-footer">
                <span class="zs-wechat"><img src="/img/wechat-btn.png"/></span>
	</div>
</div>

         

        
          <div class="blog-tags">
            
              <a href="https://fuckcloudnative.io/tags/kubernetes/"><i class="fa fa-tags"></i>kubernetes</a>&nbsp;
            
          </div>
        

        
            <hr/>
            <section id="social-share">
              <div class="list-inline footer-links">
                

<div class="share-box" aria-hidden="true">
    <ul class="share">
      
      <li>
	      <a href="//service.weibo.com/share/share.php?url=https%3a%2f%2ffuckcloudnative.io%2fposts%2ffederation%2f&amp;title=Kubernetes%20%e4%bd%bf%e7%94%a8%e9%9b%86%e7%be%a4%e8%81%94%e9%82%a6%e5%ae%9e%e7%8e%b0%e5%a4%9a%e9%9b%86%e7%be%a4%e7%ae%a1%e7%90%86&amp;pic=https%3a%2f%2fhugo-picture.oss-cn-beijing.aliyuncs.com%2fimages%2f20191204220637.png" target="_blank" title="åˆ†äº«åˆ°å¾®åš">
          <i class="fab fa-weibo"></i>
        </a>
      </li>
      
      <li>
	      <a href="//connect.qq.com/widget/shareqq/index.html?url=https%3a%2f%2ffuckcloudnative.io%2fposts%2ffederation%2f&amp;title=Kubernetes%20%e4%bd%bf%e7%94%a8%e9%9b%86%e7%be%a4%e8%81%94%e9%82%a6%e5%ae%9e%e7%8e%b0%e5%a4%9a%e9%9b%86%e7%be%a4%e7%ae%a1%e7%90%86&amp;source=Kubernetes%20%e4%bd%bf%e7%94%a8%e9%9b%86%e7%be%a4%e8%81%94%e9%82%a6%e5%ae%9e%e7%8e%b0%e5%a4%9a%e9%9b%86%e7%be%a4%e7%ae%a1%e7%90%86&amp;desc=&amp;pics=https%3a%2f%2fhugo-picture.oss-cn-beijing.aliyuncs.com%2fimages%2f20191204220637.png&amp;summary=" target="_blank" title="åˆ†äº«åˆ° QQ">
          <i class="fab fa-qq"></i>
        </a>
      </li>
      
      <li>
        <a href="//twitter.com/share?url=https%3a%2f%2ffuckcloudnative.io%2fposts%2ffederation%2f&amp;text=Kubernetes%20%e4%bd%bf%e7%94%a8%e9%9b%86%e7%be%a4%e8%81%94%e9%82%a6%e5%ae%9e%e7%8e%b0%e5%a4%9a%e9%9b%86%e7%be%a4%e7%ae%a1%e7%90%86&amp;via=RyangYang1" target="_blank" title="åˆ†äº«åˆ° Twitter">
          <i class="fab fa-twitter"></i>
        </a>
      </li>
  
      
      <li>
        <a href="//www.facebook.com/sharer/sharer.php?u=https%3a%2f%2ffuckcloudnative.io%2fposts%2ffederation%2f" target="_blank" title="åˆ†äº«åˆ° Facebook">
          <i class="fab fa-facebook"></i>
        </a>
      </li>
  
      
      <li>
	      <a href="//www.linkedin.com/shareArticle?url=https%3a%2f%2ffuckcloudnative.io%2fposts%2ffederation%2f&amp;title=Kubernetes%20%e4%bd%bf%e7%94%a8%e9%9b%86%e7%be%a4%e8%81%94%e9%82%a6%e5%ae%9e%e7%8e%b0%e5%a4%9a%e9%9b%86%e7%be%a4%e7%ae%a1%e7%90%86" target="_blank" title="åˆ†äº«åˆ° LinkedIn">
          <i class="fab fa-linkedin"></i>
        </a>
      </li>
    </ul>
  </div>
  

              </div>
            </section>
        

        
          
            
          

          
                  <h4 class="see-also">ç›¸å…³æ¨è</h4>
                  <ul>
                
                
                    <li><a href="/posts/sealos/">kubernetes é«˜å¯ç”¨éƒ¨ç½²å·¥å…·ï¼šsealos</a></li>
                
                    <li><a href="/posts/what-happens-when-k8s/">kubectl åˆ›å»º Pod èƒŒååˆ°åº•å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ</a></li>
                
                    <li><a href="/posts/istio-1.3-tour/">æ‰‹æŠŠæ‰‹æ•™ä½ éƒ¨ç½² Istio 1.3</a></li>
                
                    <li><a href="/posts/kubesphere/">KubeSphere å®‰è£…æ•™ç¨‹</a></li>
                
                    <li><a href="/posts/istio-1.3/">Istio 1.3 å‘å¸ƒï¼ŒHTTP é¥æµ‹ä¸å†éœ€è¦ Mixer</a></li>
                
              </ul>

          
        
      </article>

      
        <ul class="pager blog-pager">
          
            <li class="previous">
              <a href="https://fuckcloudnative.io/posts/k8s-network-expand/" data-toggle="tooltip" data-placement="top" title="Kubernetes ç½‘ç»œæ‰©å±•">&larr; å‰ä¸€ç¯‡</a>
            </li>
          
          
            <li class="next">
              <a href="https://fuckcloudnative.io/posts/how-manage-image/" data-toggle="tooltip" data-placement="top" title="docker åœ¨æœ¬åœ°å¦‚ä½•ç®¡ç† imageï¼ˆé•œåƒï¼‰?">åä¸€ç¯‡ &rarr;</a>
            </li>
          
        </ul>
      

      
	    <link rel="stylesheet" href="https://fuckcloudnative.io/css/iDisqus.min.css" />
<div id="comment"></div>
<script src="https://fuckcloudnative.io/js/iDisqus.min.js"></script>
<script>
var disq = new iDisqus('comment', {
    forum: 'fuckcloudnative',
    api: 'https://disqus.fuckcloudnative.io',
    site: 'http://fuckcloudnative.io',
    emojiPath: 'https://api.fooleap.org/emoji/unicode/',
    mode: 2,
    timeout: 15,
    init: true
});
</script>

      

    </div>
  </div>
</div>

      
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center footer-links">
          
              <li>
                <a href="mailto:yangchuansheng33@gmail.com" target="_blank" title="Email me">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x" style="color:#986dbd"></i>
                    <i class="fas fa-envelope fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://hugo-picture.oss-cn-beijing.aliyuncs.com/blog/2019-06-13-%E9%BB%98%E8%AE%A4%E6%A0%87%E9%A2%98_%E6%A8%AA%E7%89%88%E4%BA%8C%E7%BB%B4%E7%A0%81_2019.05.17.1.1.png" target="_blank" title="Weixin">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x" style="color:#986dbd"></i>
                    <i class="fab fa-weixin fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://github.com/yangchuansheng" target="_blank" title="GitHub">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x" style="color:#986dbd"></i>
                    <i class="fab fa-github fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://twitter.com/RyangYang1" target="_blank" title="Twitter">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x" style="color:#986dbd"></i>
                    <i class="fab fa-twitter fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://linkedin.com/in/yang-ryan-b6659b106" target="_blank" title="LinkedIn">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x" style="color:#986dbd"></i>
                    <i class="fab fa-linkedin fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://weibo.com/3496206342" target="_blank" title="å¾®åš">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x" style="color:#986dbd"></i>
                    <i class="fab fa-weibo fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
              <li>
                <a href="https://drive.google.com/drive/folders/0By_W-zIhlMXqSGJyU3pHaVVpV2M" target="_blank" title="è§†é¢‘åˆ†äº«">
                  <span class="fa-stack fa-lg">
                    <i class="fas fa-circle fa-stack-2x" style="color:#986dbd"></i>
                    <i class="fab fa-google-drive fa-stack-1x fa-inverse"></i>
                  </span>
                </a>
              </li>
          
          <li>
            <a href="https://fuckcloudnative.io/index.xml" target="_blank" title="RSS">
              <span class="fa-stack fa-lg">
                <i class="fas fa-circle fa-stack-2x" style="color:#986dbd"></i>
                <i class="fas fa-rss fa-stack-1x fa-inverse"></i>
              </span>
            </a>
          </li>
          
        </ul>
	<br />
        <p class="credits copyright text-muted">
	  &nbsp;&bull;&nbsp;&copy;2019
          
            
              <a href="https://fuckcloudnative.io">ç±³å¼€æœ—åŸºæ¨</a>
            
          

          &nbsp;&bull;&nbsp;æ›´æ–°äº
          
            2019 å¹´ 11 æœˆ 17 æ—¥
          

	  &nbsp;&bull;&nbsp;
          <a href="https://fuckcloudnative.io/tags/">æ‰€æœ‰æ–‡ç« </a>

	  
        </p>
        <p class="credits theme-by text-muted">
        <br />
        <span id="busuanzi_container_site_pv">
            æœ¬ç«™å·²è¢«è®¿é—® <span id="busuanzi_value_site_pv"></span> æ¬¡å•¦
        </span>
        <span id="busuanzi_container_site_uv">
            &ensp;|&ensp;&thinsp;æ‚¨æ˜¯ç¬¬ <span id="busuanzi_value_site_uv"></span> ä½åˆ°è®¿çš„å°ä¼™ä¼´
        </span>
        </p>
        
        <p class="credits theme-by text-muted">
          ç”± <a href="https://gohugo.io">Hugo v0.59.0</a> å¼ºåŠ›é©±åŠ¨ &nbsp;&bull;&nbsp; ä¸»é¢˜ <a href="https://github.com/halogenica/beautifulhugo">Beautiful Hugo</a> ç§»æ¤è‡ª <a href="https://deanattali.com/beautiful-jekyll/">Beautiful Jekyll</a>
          
	  <section class="credits theme-by text-muted" align="center">
    <span class="footer__copyright">
    <div>
    <span id="span_dt_dt"> </span>
    <script language="javascript">
      function show_date_time(){
        window.setTimeout("show_date_time()", 1000);
        BirthDay=new Date("7/8/2017 10:56:12");
        today=new Date();
        timeold=(today.getTime()-BirthDay.getTime());
        sectimeold=timeold/1000
        secondsold=Math.floor(sectimeold);
        msPerDay=24*60*60*1000
        e_daysold=timeold/msPerDay
        daysold=Math.floor(e_daysold);
        e_hrsold=(e_daysold-daysold)*24;
        hrsold=Math.floor(e_hrsold);
        e_minsold=(e_hrsold-hrsold)*60;
        minsold=Math.floor((e_hrsold-hrsold)*60);
        seconds=Math.floor((e_minsold-minsold)*60);
        span_dt_dt.innerHTML="æœ¬ç«™å·²ç»å¼€å¿ƒè¿è¡Œ "+daysold+" å¤© "+hrsold+" å°æ—¶ "+minsold+" åˆ† "+seconds+" ç§’";
      }
      show_date_time();
    </script>
    </div>
</script>
</section>

	</p>
      </div>
    </div>
  </div>
</footer>

<script src='/js/bundle.min.13b2d74fbe48bdf362a1e1572571a00fa30ef02c3fa8f697c71a47c9462a759a.js' integrity='sha256-E7LXT75IvfNioeFXJXGgD6MO8Cw/qPaXxxpHyUYqdZo='></script>






<script src="https://fuckcloudnative.io/js/load-photoswipe.js"></script>







<div class="rocket"><img src="/img/rocket_up.png" alt="" width="100" height="100"></div>
<script>
    $(function () {
      $(window).scroll(function () {
        
        if ($(window).scrollTop() >= 1000) {
          $('.rocket').stop().fadeIn(1000);
        }else {
          $('.rocket').stop().fadeOut(1000);
        }
      })
      
      $('.rocket').click(function () {
        $('html,body').stop().animate({scrollTop:0},400);
       
      })
    })

</script>




<script type="text/javascript">
      jQuery(function() {
          jQuery("img").lazyload({threshold: 0,effect: "fadeIn"});
      });
</script>











<script type="text/javascript">
$(document).ready(function () {
  $(window).scroll(function(){
    $(".top-scroll-bar").attr("style", "width: " + ($(this).scrollTop() / ($(document).height() - $(this).height()) * 100) + "%; display: block;");
  });
})
</script>


<script type="text/javascript">
var a_idx = 0;
jQuery(document).ready(function($) {
    $("body").click(function(e) {
        var a = new Array("Docker", "Kubernetes", "Prometheus", "Envoy", "Istio", "coredns", "Service Mesh", "Cloud Native");
        var $i = $("<span />").text(a[a_idx]);
        a_idx = (a_idx + 1) % a.length;
        var x = e.pageX,
        y = e.pageY;
        function randomColor() {
          var flakeColor = new Array("#FFDA65", "#00BFFF", "#BA55D3", "#FFA07A", "#87CEEB", "#FFB6C1");
          var snowColor = flakeColor[Math.floor(flakeColor.length * Math.random())];
          return snowColor;
        }
        $i.css({
            "z-index": 999999999999999999999999999999999999999999999999999999999999999999999,
            "top": y - 20,
            "left": x,
            "position": "absolute",
            "font-weight": "bold",
            "color": randomColor()
        });
        $("body").append($i);
        $i.animate({
            "top": y - 180,
            "opacity": 0
        },
        1500,
        function() {
            $i.remove();
        });
    });
});
</script>


    
  </body>
</html>

